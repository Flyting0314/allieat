<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®è©•åƒ¹ - ALLiEAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <!-- è¼‰å…¥ header.html ä¸­çš„è³‡æº -->
  <link href="img/favicon.ico" rel="icon">
  <link rel="preconnect" href="https://fonts.gstatic.com">
  <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400&family=Roboto:wght@400;500;700&display=swap" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Satisfy&display=swap" rel="stylesheet">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css" rel="stylesheet">
  <link href="lib/owlcarousel/assets/owl.carousel.min.css" rel="stylesheet">
  <link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css" rel="stylesheet" />
  <link rel="stylesheet" href="/css/style.css">

  <style>
  .custom-evaluate-wrapper {
  font-family: "Noto Sans TC", "Montserrat", sans-serif;
  background: #f5f7f8;
  padding: 30px 0;
  color: #333;
  min-height: 100vh;
  display: flex;
  flex-direction: column;
  justify-content: center;
}

.custom-evaluate-container {
  max-width: 800px; /* Increased from 450px for a wider container */
  margin: 0 auto;
  background: white;
  padding: 50px 60px; /* Adjusted padding to leave more space for content */
  border-radius: 20px;
  box-shadow: 0 10px 30px rgba(0,0,0,0.08);
  position: relative;
  overflow: hidden;
}

/* Decorative corner element */
.custom-evaluate-container::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 80px;
  height: 80px;
  background-color: #da9f5b;
  border-radius: 0 0 100% 0;
  opacity: 0.85;
}

.custom-evaluate-title {
  text-align: center;
  margin-bottom: 30px;
  color: #333;
  font-size: 28px;
  position: relative;
  padding-bottom: 15px;
  font-weight: 600;
}

.custom-evaluate-title::after {
  content: '';
  position: absolute;
  width: 60px;
  height: 3px;
  background-color: #da9f5b;
  bottom: 0;
  left: 50%;
  transform: translateX(-50%);
}

.custom-evaluate-order-info {
  margin-bottom: 30px;
  padding: 20px;
  background: #f8f9fa;
  border-radius: 12px;
  border: 1px solid #eeeeee;
  font-size: 15px;
  line-height: 1.6;
}

.custom-evaluate-order-info strong {
  color: #555;
}

.custom-evaluate-form-group {
  margin-bottom: 25px;
}

.custom-evaluate-form-group label {
  font-weight: 600;
  color: #444;
  margin-bottom: 12px;
  display: block;
  font-size: 16px;
}

.custom-evaluate-rating {
  display: flex;
  gap: 15px;
  font-size: 34px;
  cursor: pointer;
  justify-content: center;
  margin-bottom: 10px;
}

.custom-evaluate-star {
  color: #ccc;
  transition: color 0.3s ease;
}

.custom-evaluate-star:hover {
  color: #ffc107;
}

.custom-evaluate-star.selected {
  color: #ffc107;
}

.custom-evaluate-comment {
  width: 100%;
  padding: 15px;
  font-size: 15px;
  border-radius: 10px;
  border: 1px solid #e0e0e0;
  resize: none; /* ç¦æ­¢ç”¨æˆ¶èª¿æ•´å¤§å° */
  transition: border-color 0.3s ease;
  min-height: 80px; /* æ¸›å°‘é«˜åº¦è®“å®ƒæ›´åƒæ©«å‘é•·æ–¹å½¢ */
  height: 80px; /* å›ºå®šé«˜åº¦ */
}

.custom-evaluate-comment:focus {
  outline: none;
  border-color: #da9f5b;
  box-shadow: 0 0 0 2px rgba(218, 159, 91, 0.15);
}

.custom-evaluate-button {
  background: #da9f5b;
  color: white;
  padding: 14px 20px;
  font-size: 16px;
  border: none;
  border-radius: 10px;
  cursor: pointer;
  width: 100%;
  transition: all 0.3s ease;
  font-weight: 600;
  letter-spacing: 1px;
  margin-top: 10px;
}

.custom-evaluate-button:hover {
  background: #c78d4d;
  transform: translateY(-2px);
  box-shadow: 0 6px 15px rgba(218, 159, 91, 0.3);
}

.custom-evaluate-success {
  color: #28a745;
  text-align: center;
  margin-top: 20px;
  font-weight: 600;
}

/* éŸ¿æ‡‰å¼è¨­è¨ˆ */
@media (max-width: 768px) {
  .custom-evaluate-wrapper {
    padding: 15px;
  }

  .custom-evaluate-container {
    width: 95%;
    padding: 25px 20px;
  }

  .custom-evaluate-rating {
    font-size: 30px;
  }
}
  </style>
</head>
<body>
  <!-- é ­éƒ¨ä½”ä½ç¬¦ -->
  <div id="header-placeholder"></div>
  
  <!-- å°èˆªå€å¡Šä½”ä½ç¬¦ -->
  <div id="body-section-placeholder"></div>

  <div class="custom-evaluate-wrapper">
    <div class="custom-evaluate-container">
      <h2 class="custom-evaluate-title">è¨‚å–®è©•åƒ¹</h2>

      <div class="custom-evaluate-order-info" id="orderInfo">
        <div><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>#222</div>
        <div><strong>åº—å®¶ï¼š</strong>éº¥å¯Œè¿ª</div>
      </div>

      <div class="custom-evaluate-form-group">
        <label for="rating">è©•åˆ†ï¼š</label>
        <div class="custom-evaluate-rating" id="ratingStars">
          <span class="custom-evaluate-star" data-value="1">â˜…</span>
          <span class="custom-evaluate-star" data-value="2">â˜…</span>
          <span class="custom-evaluate-star" data-value="3">â˜…</span>
          <span class="custom-evaluate-star" data-value="4">â˜…</span>
          <span class="custom-evaluate-star" data-value="5">â˜…</span>
        </div>
      </div>

      <div class="custom-evaluate-form-group">
        <label for="comment">ç•™è¨€ï¼š</label>
        <textarea id="comment" class="custom-evaluate-comment" rows="4" placeholder="èªªèªªæ‚¨çš„ç”¨é¤é«”é©—å§ï¼"></textarea>
      </div>

      <button class="custom-evaluate-button" onclick="submitEvaluation()">é€å‡ºè©•åƒ¹</button>
      <div class="custom-evaluate-success" id="successMsg"></div>
    </div>
  </div>

  <!-- é å°¾ä½”ä½ç¬¦ -->
  <div id="footer-placeholder"></div>

  <!-- JavaScript Libraries -->
  <script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
  <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
  <script src="lib/easing/easing.min.js"></script>
  <script src="lib/waypoints/waypoints.min.js"></script>
  <script src="lib/owlcarousel/owl.carousel.min.js"></script>
  <script src="lib/tempusdominus/js/moment.min.js"></script>
  <script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
  <script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

  <script>
    // é€šç”¨ç‰‡æ®µè¼‰å…¥å‡½æ•¸
    function loadFragment(id, path, callback) {
      console.log(`æ­£åœ¨å˜—è©¦è¼‰å…¥ ${path} åˆ° ${id}`);
      
      const container = document.getElementById(id);
      if (!container) {
        console.error(`âŒ å®¹å™¨ ${id} ä¸å­˜åœ¨`);
        return;
      }

      fetch(path)
        .then(response => {
          console.log(`${path} éŸ¿æ‡‰ç‹€æ…‹:`, response.status);
          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }
          return response.text();
        })
        .then(html => {
          container.innerHTML = html;
          
          // è½‰æ› Thymeleaf å±¬æ€§
          convertThAttributes(container);
          
          console.log(`âœ… æˆåŠŸè¼‰å…¥ ${path}`);
          
          // å¦‚æœæœ‰å›èª¿å‡½æ•¸ï¼ŒåŸ·è¡Œå›èª¿
          if (typeof callback === 'function') {
            callback();
          }
        })
        .catch(error => {
          console.error(`âŒ è¼‰å…¥ ${path} å¤±æ•—:`, error);
          
          // é¡¯ç¤ºéŒ¯èª¤è¨Šæ¯
          const errorMsg = document.createElement('div');
          errorMsg.style.color = 'red';
          errorMsg.textContent = `ç„¡æ³•è¼‰å…¥ ${path}: ${error.message}`;
          container.appendChild(errorMsg);
        });
    }

    // è½‰æ› Thymeleaf å±¬æ€§çš„å‡½æ•¸
    function convertThAttributes(container) {
      container.querySelectorAll('[th\\:href]').forEach(el => {
        const val = el.getAttribute('th:href');
        if (val?.startsWith('@{') && val.endsWith('}')) {
          el.setAttribute('href', val.slice(2, -1));
          el.removeAttribute('th:href');
        }
      });
      
      container.querySelectorAll('[th\\:src]').forEach(el => {
        const val = el.getAttribute('th:src');
        if (val?.startsWith('@{') && val.endsWith('}')) {
          el.setAttribute('src', val.slice(2, -1));
          el.removeAttribute('th:src');
        }
      });
    }

    // è¨‚å–®è©•åƒ¹é é¢çš„ä¸»è¦é‚è¼¯
    const orderId = new URLSearchParams(window.location.search).get('orderId');
    let selectedRating = 0;

    document.addEventListener('DOMContentLoaded', () => {
      console.log('æ–‡ä»¶å·²è¼‰å…¥');
      
      // æ˜Ÿæ˜Ÿè©•åˆ†äº‹ä»¶ç¶å®š
      document.querySelectorAll('.custom-evaluate-star').forEach(star => {
        star.addEventListener('click', () => {
          selectedRating = parseInt(star.dataset.value);
          updateStars(selectedRating);
        });
      });

      // è¼‰å…¥è¨‚å–®è³‡è¨Š
      if (orderId) {
        fetch(`/meal/order/${orderId}`)
          .then(res => res.json())
          .then(order => {
            if (order.error) {
              document.getElementById('orderInfo').innerHTML = 'âš  ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡è¨Š';
              return;
            }

            const info = `
              <div><strong>è¨‚å–®ç·¨è™Ÿï¼š</strong>#${order.orderId}</div>
              <div><strong>åº—å®¶ï¼š</strong>${order.storeName}</div>
            `;
            document.getElementById('orderInfo').innerHTML = info;
          })
          .catch(() => {
            document.getElementById('orderInfo').innerHTML = 'âš  ç„¡æ³•è¼‰å…¥è¨‚å–®è³‡è¨Š';
          });
      }

      // è¼‰å…¥é ­éƒ¨
      loadFragment('header-placeholder', '/header.html', () => {
        // é ­éƒ¨è¼‰å…¥å®Œæˆå¾Œè¼‰å…¥å°èˆªå€å¡Š
        loadFragment('body-section-placeholder', '/bodySection.html', () => {
          // å°èˆªå€å¡Šè¼‰å…¥å®Œæˆå¾Œè¼‰å…¥é å°¾
          loadFragment('footer-placeholder', '/footer.html');
        });
      });
    });

    // æ›´æ–°æ˜Ÿæ˜Ÿè©•åˆ†
    function updateStars(rating) {
      document.querySelectorAll('.custom-evaluate-star').forEach(star => {
        star.classList.toggle('selected', parseInt(star.dataset.value) <= rating);
      });
    }

    // æäº¤è©•åƒ¹
    function submitEvaluation() {
      if (selectedRating === 0) {
        alert('è«‹å…ˆé¸æ“‡è©•åˆ†ï¼');
        return;
      }

      const payload = {
        orderId: parseInt(orderId || 0),
        rating: selectedRating,
        comment: document.getElementById('comment').value
      };

      fetch('/meal/order/evaluate', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(payload)
      })
      .then(res => res.json())
      .then(data => {
        if (data.success) {
          document.getElementById('successMsg').textContent = 'ğŸ‰ æ„Ÿè¬æ‚¨çš„è©•åƒ¹ï¼';
          
          // 3ç§’å¾Œè‡ªå‹•è¿”å›é¦–é 
          
        } else {
          alert('æäº¤å¤±æ•—ï¼š' + (data.message || 'æœªçŸ¥éŒ¯èª¤'));
        }
      })
      .catch(err => {
        console.error('è©•åƒ¹é€å‡ºå¤±æ•—ï¼š', err);
        alert('ç™¼é€éŒ¯èª¤ï¼Œè«‹ç¨å¾Œå†è©¦');
      });
    }
  </script>
</body>
</html>