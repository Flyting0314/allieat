<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®ç®¡ç†</title>
  <style>
    body {
      font-family: sans-serif;
      padding: 40px;
      background: #f8f9fa;
    }
    .order-box {
      background: white;
      padding: 20px;
      margin-bottom: 20px;
      border-radius: 12px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    }
    .btn-group {
      margin-top: 10px;
    }
    button {
      padding: 10px 16px;
      margin-right: 8px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      font-weight: bold;
    }
    .btn-pick { background: #28a745; color: white; }
    .btn-none { background: #6c757d; color: white; }
    .btn-notyet { background: #ffc107; color: black; }
    .btn-cancel { background: #dc3545; color: white; }
    .message {
      margin-top: 8px;
      font-size: 14px;
      color: #555;
    }
  </style>
</head>
<body>

  <h2>ğŸ›’ æ‰€æœ‰è¨‚å–®ç®¡ç†</h2>
  <div id="orderList">è¼‰å…¥ä¸­...</div>

  <script>
  let page = 0;
  const size = 50;
  let total = 0;

  function loadOrders() {
    fetch(`/meal/order/page?page=${page}&size=${size}`)
      .then(res => res.json())
      .then(data => {
        const container = document.getElementById('orderList');
        if (page === 0) container.innerHTML = '';

        const orders = data.orders;
        total = data.total;

        if (orders.length === 0 && page === 0) {
          container.innerHTML = '<p>ç›®å‰æ²’æœ‰ä»»ä½•è¨‚å–®ã€‚</p>';
          document.getElementById('loadMoreBtn').style.display = 'none';
          return;
        }

        orders.forEach(order => {
          const box = document.createElement('div');
          box.className = 'order-box';
          box.innerHTML = `
            <h4>è¨‚å–® #${order.orderId} - æœƒå“¡ ${order.memberId}</h4>
            <div class="btn-group">
              <button class="btn-pick" onclick="updateStatus(${order.orderId}, 0)">âœ… å·²é ˜å–</button>
              <button class="btn-none" onclick="updateStatus(${order.orderId}, 1)">â›” ç„¡</button>
              <button class="btn-notyet" onclick="updateStatus(${order.orderId}, 2)">â³ æœªé ˜å–</button>
              <button class="btn-cancel" onclick="updateStatus(${order.orderId}, 3)">âŒ å·²æ£„å–®</button>
            </div>
            <div class="message" id="msg-${order.orderId}"></div>
          `;
          container.appendChild(box);
        });

        page++;
        if (page * size >= total) {
          document.getElementById('loadMoreBtn').style.display = 'none';
        } else {
          document.getElementById('loadMoreBtn').style.display = 'block';
        }
      })
      .catch(err => {
        console.error("è¼‰å…¥å¤±æ•—", err);
        document.getElementById('orderList').innerHTML = '<p style="color:red;">âŒ ç„¡æ³•è¼‰å…¥è¨‚å–®ï¼Œè«‹ç¨å¾Œå†è©¦ã€‚</p>';
      });
  }

  function updateStatus(orderId, pickStat) {
	  fetch(`/meal/order/pickup-status?orderId=${orderId}&pickStat=${pickStat}`, {
	    method: 'POST'
	  })
	  .then(res => res.json())
	  .then(data => {
	    const msgBox = document.getElementById('msg-' + orderId);

	    if (pickStat === 0) {
	      msgBox.innerHTML = `âœ… ç‹€æ…‹å·²æ›´æ–°ï¼Œè«‹è‡³å–é¤ç•«é¢ç¹¼çºŒ`;
	    } else if (data.message) {
	      alert(data.message); // â¤ è¨‚å–®å·²å–æ¶ˆ
	      window.location.href = "/index.html";
	    } else if (data.error) {
	      msgBox.innerHTML = `âŒ ${data.error}`;
	    }
	  })
	  .catch(err => {
	    alert("âš ï¸ æ›´æ–°å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
	    console.error(err);
	  });
	}


  window.onload = loadOrders;
</script>

<!-- åœ¨ body æœ€å¾ŒåŠ é€™å€‹æŒ‰éˆ• -->
<button id="loadMoreBtn" onclick="loadOrders()" style="padding: 12px 20px; margin: 20px auto; display: block;">è¼‰å…¥æ›´å¤š</button>

</body>
</html>
