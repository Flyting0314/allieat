<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<title>ç¢ºèªè¨‚å–® - æ”å‘·éœ¸ ALLiEAT</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<link rel="stylesheet" href="/css/style.css">
<style>
body {
	font-family: Arial, sans-serif;
	background: #f8f9fa;
	padding: 30px;
}

.checkout-container {
	max-width: 800px;
	margin: 0 auto;
	background: #fff;
	padding: 30px;
	border-radius: 10px;
	box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
}

h2 {
	text-align: center;
	margin-bottom: 20px;
	color: #da9f5b;
}

.cart-item {
	display: flex;
	justify-content: space-between;
	border-bottom: 1px solid #ddd;
	padding: 10px 0;
}

.cart-total {
	text-align: right;
	font-weight: bold;
	font-size: 18px;
	margin-top: 20px;
}

.btn-checkout, .btn-back {
	background-color: #da9f5b;
	border: none;
	padding: 12px 20px;
	color: white;
	font-weight: bold;
	border-radius: 5px;
	cursor: pointer;
	transition: 0.3s;
}

.btn-checkout:disabled {
	background-color: #ccc;
	cursor: not-allowed;
}

.btn-checkout:hover:not(:disabled), .btn-back:hover {
	background-color: #c88c4a;
}

.actions {
	margin-top: 30px;
	display: flex;
	justify-content: space-between;
}

#countdown {
	text-align: center;
	font-size: 16px;
	font-weight: bold;
	margin-bottom: 15px;
}

.alert {
	background-color: #ffc107;
	color: #000;
	padding: 10px;
	border-radius: 5px;
	margin-top: 10px;
	text-align: center;
}
</style>
</head>
<body>
	<!-- Navbar Start -->
	<section id="header">
		<div class="container-fluid p-0 nav-bar">
			<nav class="navbar navbar-expand-lg bg-none navbar-dark py-3">
				<a href="index.html" class="navbar-brand px-lg-4 m-0">
					<h1 class="m-0 display-4 text-uppercase text-white"
						style="display: inline-block;">
						<img src="/img/logo3.png" width="80px" height="80px" alt=""
							style="vertical-align: middle; margin-right: 0px; margin-top: -10px; border-radius: 50%; object-fit: cover;">
						<span style="font-family: 'Satisfy', cursive;">ALLiEAT</span>
					</h1>
				</a>
				<button type="button" class="navbar-toggler" data-toggle="collapse"
					data-target="#navbarCollapse">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse justify-content-between"
					id="navbarCollapse">
					<div class="navbar-nav ml-auto p-4">
						<a href="index.html" class="nav-item nav-link active">é—œæ–¼æˆ‘å€‘</a>
						<div class="nav-item dropdown">
							<a href="#" class="nav-link dropdown-toggle"
								data-toggle="dropdown">æˆ‘è¦ææ¬¾</a>
							<div class="dropdown-menu text-capitalize">
								<a href="reservation.html" class="dropdown-item">æˆ‘è¦ææ¬¾</a> <a
									href="testimonial.html" class="dropdown-item">ææ¬¾æŸ¥è©¢</a>
							</div>
						</div>
						<a href="service.html" class="nav-item nav-link">å—åŠ©è€…å–é¤</a>
						<div class="nav-item dropdown">
							<a href="#" class="nav-link dropdown-toggle"
								data-toggle="dropdown">è¨»å†Š/ç™»å…¥</a>
							<div class="dropdown-menu text-capitalize">
								<a href="reservation.html" class="dropdown-item">è¨»å†Š</a> <a
									href="testimonial.html" class="dropdown-item">ç™»å…¥</a>
							</div>
						</div>
						<a href="contact.html" class="nav-item nav-link">æœƒå“¡å°ˆå€</a>
					</div>
				</div>
			</nav>
		</div>
	</section>

	<!-- Hero Section Start -->
	<section id="hero">
		<div class="container-fluid p-0 mb-5">
			<div id="hero-carousel" class="carousel slide overlay-bottom"
				data-ride="carousel">
				<div class="carousel-inner">
					<div class="carousel-item active"
						style="background-image: url('img/åœ–ç‰‡3.png'); background-size: 110% auto; background-position: center -300px; height: 570px; filter: brightness(200%);">
						<div
							class="carousel-caption d-flex flex-column align-items-center justify-content-center">
							<h2 class="text-primary font-weight-medium m-0"></h2>
							<h1 class="display-1 text-white m-0"></h1>
							<h2 class="text-white m-0"></h2>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- Hero Section End -->
	<div class="checkout-container">
		<h2>ç¢ºèªæ‚¨çš„è¨‚å–®</h2>
		<div id="countdown">å‰©é¤˜æ™‚é–“ï¼š180 ç§’</div>
		<div id="cartItems"></div>
		<div class="cart-total" id="cartTotal">ç¸½è¨ˆï¼š0 é»</div>
		<div class="alert" id="statusMessage" style="display: none;"></div>
		<div class="actions">
			<button class="btn-back" onclick="goBackToOrder()">â¬… è¿”å›é»é¤</button>
			<button class="btn-checkout" id="checkoutBtn"
				onclick="confirmCheckout()">âœ… ç¢ºèªçµå¸³</button>
		</div>
	</div>

	<script>
let cartData = [];
let timer = 120;
let countdownInterval;
let stockCheckInterval;
let storeCheckInterval;

function startCountdown() {
    updateCountdownDisplay();
    countdownInterval = setInterval(() => {
        timer--;
        updateCountdownDisplay();
        if (timer <= 0) {
            clearInterval(countdownInterval);
            clearInterval(stockCheckInterval);
            clearInterval(storeCheckInterval);

            // æ™‚é–“åˆ°è‡ªå‹•æ¸…ç©ºè³¼ç‰©è»Š
            fetch('/api/cart/clear', { method: 'POST' })
                .then(() => {
                    console.log("â° è³¼ç‰©è»Šå·²è‡ªå‹•æ¸…ç©º");
                    disableCheckout("â° æ™‚é–“å·²åˆ°ï¼Œè³¼ç‰©è»Šå·²æ¸…ç©ºï¼Œè«‹é‡æ–°é»é¤");

                    // 2 ç§’å¾Œè‡ªå‹•è·³å›é»é¤é 
                    setTimeout(goBackToOrder, 2000);
                })
                .catch(err => {
                    console.error("æ¸…ç©ºè³¼ç‰©è»Šå¤±æ•—ï¼š", err);
                    disableCheckout("âŒ æ¸…ç©ºå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¿”å›é»é¤é ");
                });
        }
    }, 1000);
}

function updateCountdownDisplay() {
    document.getElementById('countdown').textContent = `å‰©é¤˜æ™‚é–“ï¼š${timer} ç§’`;
}

function loadCart() {
    fetch('/api/cart')
        .then(res => res.json())
        .then(cart => {
            if (!cart || cart.length === 0) {
                disableCheckout("ğŸ›’ è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹è¿”å›é»é¤");
                return;
            }
            return fetch('/meal/cart/details', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(cart)
            });
        })
        .then(res => res?.json())
        .then(details => {
            if (!details) return;
            cartData = details;
            renderCart();
        })
        .catch(err => {
            console.error("è¼‰å…¥è³¼ç‰©è»Šå¤±æ•—ï¼š", err);
            disableCheckout("âŒ ç³»çµ±ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦");
        });
}

function renderCart() {
    const cartItems = document.getElementById('cartItems');
    cartItems.innerHTML = '';
    let total = 0;

    cartData.forEach(item => {
        total += item.cost * item.quantity;
        const div = document.createElement('div');
        div.className = 'cart-item';
        div.innerHTML = `
            <div>ä¸»é¤ï¼š${item.foodName}</div>
            <div>é™„é¤ï¼š${item.attachedName}</div>
            <div>æ•¸é‡ï¼š${item.quantity}</div>
            <div>é»æ•¸ï¼š${item.cost * item.quantity}</div>
        `;
        cartItems.appendChild(div);
    });

    document.getElementById('cartTotal').textContent = `ç¸½è¨ˆï¼š${total} é»`;

    // âœ… å„²å­˜æ­£ç¢ºæ ¼å¼çš„ cartItems åˆ° sessionStorageï¼Œkey ç‚º pointsCost
    const cartItemsForSubmit = cartData.map(item => ({
    	foodId: item.foodId,
        foodName: item.foodName,
        attachedName: item.attachedName,
        quantity: item.quantity,
        pointsCost: item.cost,   // âœ… å¾Œç«¯éœ€è¦é€™å€‹ key
        note: item.note || ""
    }));

    sessionStorage.setItem('cartItems', JSON.stringify(cartItemsForSubmit));
}

function confirmCheckout() {
    const memberId = localStorage.getItem('memberId');
    const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));

    if (!memberId || !selectedFood) {
        alert("âš  ç„¡æ³•å–å¾—ä½¿ç”¨è€…æˆ–åº—å®¶è³‡è¨Šï¼");
        return;
    }

    const orderPayload = {
        storeId: selectedFood.storeId,
        memberId: parseInt(memberId),
        pickStat: 2,  // ğŸ“Œ 2025/04/13 ä¿®æ”¹ï¼šé è¨­ç‚º 2 æœªé ˜å–
        serveStat: 0,
        foodId: selectedFood.foodId,
        attachedId: selectedFood.attachedId || null,
        items: JSON.parse(sessionStorage.getItem('cartItems')) || []
    };

    fetch('/meal/order/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderPayload)
    })
    .then(res => {
        if (!res.ok) throw new Error("ä¼ºæœå™¨éŒ¯èª¤");
        return res.json();
    })
    .then(data => {
        console.log("âœ… å¾Œç«¯å›å‚³ data:", data);
        if (data.error) {
            alert(data.error);
            return;
        }

        // ğŸ“Œ 2025/04/13 ä¿®æ”¹ï¼šè£œä¸Š orderIdï¼Œè®“å¾ŒçºŒåœ°åœ–é èˆ‡è¼ªè©¢é å¯è®€å–
        sessionStorage.setItem("orderSuccess", JSON.stringify({
            orderId: data.orderId,                   // âœ… é€™ä¸€è¡Œæ˜¯æ–°å¢çš„
            storeName: data.storeName,
            address: data.address,
            pickupCode: data.pickupCode,
            pickupTime: data.pickupTime,
            storeLat: data.storeLat,
            storeLng: data.storeLng,
            details: data.details
        }));

        // ğŸ“Œ æ¸…é™¤å‰ç«¯èˆ‡å¾Œç«¯è³¼ç‰©è»Š
        clearCartStorage();
        fetch('/api/cart/clear', { method: 'POST' })
            .then(() => console.log("âœ… å¾Œç«¯è³¼ç‰©è»Šå·²æ¸…ç©º"))
            .catch(err => console.error("âŒ å¾Œç«¯è³¼ç‰©è»Šæ¸…é™¤å¤±æ•—", err));

        // ğŸ“Œ å°å‘æˆåŠŸé ï¼ˆ5 ç§’å¾Œæœƒè‡ªå‹•è·³ pickup åœ°åœ–é ï¼‰
        window.location.href = "/success.html";
    })
    .catch(err => {
        console.error("è¨‚å–®å»ºç«‹å¤±æ•—ï¼š", err);
        alert("âŒ è¨‚å–®å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
    });
}

// âœ… æ¸…ç©ºè³¼ç‰©è»Š function
function clearCartStorage() {
    localStorage.removeItem('selectedFood');
    localStorage.removeItem('cartItems');
    sessionStorage.removeItem('selectedFood');
    sessionStorage.removeItem('cartItems');
}




//âœ… æ¸…ç©ºè³¼ç‰©è»Šèˆ‡é¸æ“‡çš„é¤é»è³‡æ–™ï¼ˆlocalStorage èˆ‡ sessionStorageï¼‰
function clearCartStorage() {
    // æ¸…é™¤é¸æ“‡çš„ä¸»é¤èˆ‡é™„é¤è³‡æ–™
    localStorage.removeItem('selectedFood');
    sessionStorage.removeItem('selectedFood');

    // æ¸…é™¤è³¼ç‰©è»Šè³‡æ–™
    localStorage.removeItem('cartItems');
    sessionStorage.removeItem('cartItems');
}





function disableCheckout(msg) {
    const checkoutBtn = document.getElementById('checkoutBtn');
    checkoutBtn.disabled = true;
    checkoutBtn.style.backgroundColor = "#ccc";
    document.getElementById('statusMessage').textContent = msg;
    document.getElementById('statusMessage').style.display = 'block';

    document.querySelectorAll('.cart-item').forEach(item => {
        item.style.opacity = "0.5";
    });

    clearInterval(stockCheckInterval);
    clearInterval(storeCheckInterval);
}

function checkStock() {
    if (!cartData.length) return;
    fetch('/meal/cart/stock-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartData)
    })
    .then(res => res.json())
    .then(stockList => {
        if (stockList.some(item => item.available === false)) {
            disableCheckout("âŒ æœ‰å•†å“å·²å”®å®Œï¼Œè«‹é‡æ–°é»é¤");
        }
    })
    .catch(err => console.error("æª¢æŸ¥åº«å­˜å¤±æ•—", err));
}

function checkStoreStatus() {
    const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
    if (!selectedFood || !selectedFood.storeId) return;

    fetch(`/meal/store/status/${selectedFood.storeId}`)
        .then(res => res.json())
        .then(data => {
            if (data.accepting === false) {
                disableCheckout("ğŸš« åº—å®¶ç›®å‰ç„¡æ³•æ¥å–®");
            }
        })
        .catch(err => console.error("æª¢æŸ¥åº—å®¶ç‹€æ…‹å¤±æ•—", err));
}

function goBackToOrder() {
    const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
    if (selectedFood && selectedFood.storeId && selectedFood.storeName) {
        const storeId = selectedFood.storeId;
        const storeName = encodeURIComponent(selectedFood.storeName);
        window.location.href = `/orderfood.html?id=${storeId}&name=${storeName}`;
    } else {
        window.location.href = '/map2';
    }
}

window.onload = () => {
    loadCart();
    startCountdown();
    stockCheckInterval = setInterval(checkStock, 10000);
    storeCheckInterval = setInterval(checkStoreStatus, 15000);
};


</script>

	<!-- Footer Start -->
	<div
		class="container-fluid footer text-white mt-5 pt-5 px-0 position-relative overlay-top">
		<div class="row mx-0 pt-5 px-sm-3 px-lg-5 mt-4">
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">è¯çµ¡æˆ‘å€‘</h4>
				<p>
					<i class="fa fa-map-marker-alt mr-2"></i>å°åŒ—å¸‚æ„›ä½ å€æ„›ä½ ä¸€è·¯5255è™Ÿ
				</p>
				<p>
					<i class="fa fa-phone-alt mr-2"></i>02-2222-5252
				</p>
				<p class="m-0">
					<i class="fa fa-envelope mr-2"></i>allieat105@gmail.com
				</p>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">é—œæ³¨æˆ‘å€‘</h4>
				<p>åœ¨é€™å€‹ä¸–ç•Œä¸Šï¼Œæœ‰äº›äººæ¯å¤©ç‚ºäº†æº«é£½è€ŒåŠªåŠ›ï¼Œè€Œä½ çš„ä¸€ä»½æ„›å¿ƒï¼Œå¯ä»¥æˆç‚ºä»–å€‘çš„ä¸€çµ²å¸Œæœ›ã€‚æ„›å¿ƒä»£ç”¨é¤æ˜¯ä¸€å€‹ç°¡å–®å»å……æ»¿æº«åº¦çš„å…¬ç›Šè¡Œå‹•ï¼Œè®“éœ€è¦å¹«åŠ©çš„äººèƒ½å¤ ç²å¾—ä¸€ä»½ç†±é¨°é¨°çš„é¤é»ï¼Œæ„Ÿå—ç¤¾æœƒçš„é—œæ‡·èˆ‡æ”¯æŒã€‚</p>
				<div class="d-flex justify-content-start">
					<a class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-twitter"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-facebook-f"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-linkedin-in"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square" href="#"><i
						class="fab fa-instagram"></i></a>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">å®¢æœæ™‚é–“</h4>
				<div>
					<h6 class="text-white text-uppercase">å‘¨ä¸€ - é€±äº”</h6>
					<p>æ—©ä¸Š10:00 - æ™šä¸Š21:00</p>
					<h6 class="text-white text-uppercase">é€±å…­ - é€±æ—¥</h6>
					<p>æ—©ä¸Š11:00 - æ™šä¸Š19:00</p>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">è¨‚é–±é›»å­å ±</h4>
				<p>è¨‚é–±æ„›å¿ƒä»£ç”¨é¤é›»å­å ±ï¼Œç²å–æœ€æ–°æ„›å¿ƒè¨ˆç•«ã€æ–°å¢åˆä½œåº—å®¶èˆ‡å…¬ç›Šæ´»å‹•è³‡è¨Šï¼Œè®“æº«æš–æŒçºŒå‚³éï¼</p>
				<div class="w-100">
					<div class="input-group">
						<input type="text" class="form-control border-light"
							style="padding: 25px;" placeholder="è¼¸å…¥æ‚¨çš„ä¿¡ç®±">
						<div class="input-group-append">
							<button class="btn btn-primary font-weight-bold px-3">ç«‹å³è¨‚é–±</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div
			class="container-fluid text-center text-white border-top mt-4 py-4 px-sm-3 px-md-5"
			style="border-color: rgba(256, 256, 256, .1) !important;">
			<p class="mb-2 text-white">
				ç‰ˆæ¬Šæ‰€æœ‰ &copy; <a class="font-weight-bold" href="#">æ”å‘·éœ¸è‚¡ä»½æœ‰é™å…¬å¸</a>.
				ä¿ç•™æ‰€æœ‰æ¬Šåˆ©
			</p>
			<p class="m-0 text-white">
				ç¶²ç«™è¨­è¨ˆç”± <a class="font-weight-bold" href="#">æ”å‘·éœ¸è‚¡ä»½æœ‰é™å…¬å¸ è¨­è¨ˆéƒ¨ è¨­è¨ˆ</a>
			</p>
		</div>
	</div>
	<!-- Footer End -->
</body>
</html>
