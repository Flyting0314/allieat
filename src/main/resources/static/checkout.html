<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>Á¢∫Ë™çË®ÇÂñÆ - ÊîèÂë∑Èú∏ ALLiEAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css">
  <style>
  .checkout-page {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f6f8f9 0%, #e5ebee 100%);
    padding: 30px;
    min-height: 100vh;
  }
  .checkout-page .checkout-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  .checkout-page h2 {
    text-align: center;
    margin-bottom: 30px;
    color: #2c3e50;
    font-weight: 600;
    position: relative;
    padding-bottom: 10px;
  }
  .checkout-page h2::after {
    content: '';
    position: absolute;
    width: 80px;
    height: 3px;
    background-color: #da9f5b;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
  }
  .checkout-page .cart-total {
    text-align: right;
    font-weight: bold;
    font-size: 20px;
    margin-top: 20px;
    color: #2c3e50;
  }
  .checkout-page .btn-checkout,
  .checkout-page .btn-back {
    background-color: #da9f5b;
    border: none;
    padding: 12px 20px;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .checkout-page .btn-checkout:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  .checkout-page .btn-checkout:hover:not(:disabled),
  .checkout-page .btn-back:hover {
    background-color: #c88c4a;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .checkout-page .actions {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }
  .checkout-page #countdown {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #7f8c8d;
  }
  .checkout-page .alert {
    background-color: #f39c12;
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-top: 15px;
    text-align: center;
    font-weight: 500;
  }

  /* ÊîπÈÄ≤ÁöÑË≥ºÁâ©ËªäÈ†ÖÁõÆÊ®£Âºè */
  .checkout-page .pretty-cart-item {
    display: flex;
    flex-direction: column;
    background: linear-gradient(to right, #f9f9f9, #f0f0f0);
    border: 1px solid #e0e0e0;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .checkout-page .pretty-cart-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background-color: #da9f5b;
  }
  .checkout-page .pretty-cart-item:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  .checkout-page .pretty-cart-item .line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e6e6e6;
  }
  .checkout-page .pretty-cart-item .line:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }
  .checkout-page .pretty-cart-item .line span.label {
    font-weight: 600;
    color: #34495e;
    min-width: 80px;
    text-align: left;
  }
  .checkout-page .pretty-cart-item .line span.value {
    color: #2c3e50;
    font-weight: 500;
    text-align: right;
  }
</style>
</head>
<body>
  <div id="header-placeholder"></div>
  <div id="body-section-placeholder"></div>
  <div class="checkout-page">
    <div class="checkout-container">
      <h2>Á¢∫Ë™çÊÇ®ÁöÑË®ÇÂñÆ</h2>
      <div id="countdown">Ââ©È§òÊôÇÈñìÔºö180 Áßí</div>
      <div id="cartItems"></div>
      <div class="cart-total" id="cartTotal">Á∏ΩË®àÔºö0 Èªû</div>
      <div class="alert" id="statusMessage" style="display: none;"></div>
      <div class="actions">
        <button class="btn-back" onclick="goBackToOrder()">‚¨Ö ËøîÂõûÈªûÈ§ê</button>
        <button class="btn-checkout" id="checkoutBtn" onclick="confirmCheckout()">‚úÖ Á¢∫Ë™çÁµêÂ∏≥</button>
      </div>
    </div>
  </div>
  <div id="footer-placeholder"></div>

  <!-- ÂÖ±Áî® HTML ÂçÄÂ°äËºâÂÖ• + th Â±¨ÊÄßËΩâÊèõ -->
  <script>
    function loadFragment(id, path) {
      fetch(path)
        .then(res => res.text())
        .then(html => {
          const container = document.getElementById(id);
          container.innerHTML = html;
          convertThAttributes(container);
        })
        .catch(err => console.error(`‚ùå ÁÑ°Ê≥ïËºâÂÖ• ${path}`, err));
    }

    function convertThAttributes(container) {
      container.querySelectorAll("[th\\:href]").forEach(el => {
        const val = el.getAttribute("th:href");
        if (val?.startsWith("@{") && val.endsWith("}")) {
          el.setAttribute("href", val.slice(2, -1));
          el.removeAttribute("th:href");
        }
      });
      container.querySelectorAll("[th\\:src]").forEach(el => {
        const val = el.getAttribute("th:src");
        if (val?.startsWith("@{") && val.endsWith("}")) {
          el.setAttribute("src", val.slice(2, -1));
          el.removeAttribute("th:src");
        }
      });
    }

    loadFragment("header-placeholder", "/header.html");
    loadFragment("body-section-placeholder", "/bodySection.html");
    loadFragment("footer-placeholder", "/footer.html");
  </script>

  <!-- ÂéüÂßã checkout JS ÂäüËÉΩ -->
  <script>
    let cartData = [];
    let timer = 120;
    let countdownInterval;
    let stockCheckInterval;
    let storeCheckInterval;

    function startCountdown() {
      updateCountdownDisplay();
      countdownInterval = setInterval(() => {
        timer--;
        updateCountdownDisplay();
        if (timer <= 0) {
          clearInterval(countdownInterval);
          clearInterval(stockCheckInterval);
          clearInterval(storeCheckInterval);
          fetch('/api/cart/clear', { method: 'POST' })
            .then(() => {
              disableCheckout("‚è∞ ÊôÇÈñìÂ∑≤Âà∞ÔºåË≥ºÁâ©ËªäÂ∑≤Ê∏ÖÁ©∫ÔºåË´ãÈáçÊñ∞ÈªûÈ§ê");
              setTimeout(goBackToOrder, 2000);
            })
            .catch(err => {
              console.error("Ê∏ÖÁ©∫Ë≥ºÁâ©ËªäÂ§±ÊïóÔºö", err);
              disableCheckout("‚ùå Ê∏ÖÁ©∫Â§±ÊïóÔºåË´ãÊâãÂãïËøîÂõûÈªûÈ§êÈ†Å");
            });
        }
      }, 1000);
    }

    function updateCountdownDisplay() {
      document.getElementById('countdown').textContent = `Ââ©È§òÊôÇÈñìÔºö${timer} Áßí`;
    }

    function loadCart() {
      fetch('/api/cart')
        .then(res => res.json())
        .then(cart => {
          if (!cart || cart.length === 0) {
            disableCheckout("üõí Ë≥ºÁâ©ËªäÊòØÁ©∫ÁöÑÔºåË´ãËøîÂõûÈªûÈ§ê");
            return;
          }
          return fetch('/meal/cart/details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cart)
          });
        })
        .then(res => res?.json())
        .then(details => {
          if (!details) return;
          cartData = details;
          renderCart();
        })
        .catch(err => {
          console.error("ËºâÂÖ•Ë≥ºÁâ©ËªäÂ§±ÊïóÔºö", err);
          disableCheckout("‚ùå Á≥ªÁµ±Áï∞Â∏∏ÔºåË´ãÁ®çÂæåÂÜçË©¶");
        });
    }

    function renderCart() {
    	  const cartItems = document.getElementById('cartItems');
    	  cartItems.innerHTML = '';
    	  let total = 0;

    	  cartData.forEach(item => {
    	    total += item.cost * item.quantity;
    	    const div = document.createElement('div');
    	    div.className = 'pretty-cart-item';
    	    div.innerHTML = `
    	      <div class="line"><span class="label">‰∏ªÈ§ê</span><span class="value">${item.foodName}</span></div>
    	      <div class="line"><span class="label">ÈôÑÈ§ê</span><span class="value">${item.attachedName}</span></div>
    	      <div class="line"><span class="label">Êï∏Èáè</span><span class="value">${item.quantity}</span></div>
    	      <div class="line"><span class="label">ÈªûÊï∏</span><span class="value">${item.cost * item.quantity}</span></div>
    	    `;
    	    cartItems.appendChild(div);
    	  });

    	  document.getElementById('cartTotal').textContent = `Á∏ΩË®àÔºö${total} Èªû`;

    	  const cartItemsForSubmit = cartData.map(item => ({
    	    foodId: item.foodId,
    	    foodName: item.foodName,
    	    attachedName: item.attachedName,
    	    quantity: item.quantity,
    	    pointsCost: item.cost,
    	    note: item.note || ""
    	  }));

    	  sessionStorage.setItem('cartItems', JSON.stringify(cartItemsForSubmit));
    	}

    function confirmCheckout() {
      const memberId = localStorage.getItem('memberId');
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));

      if (!memberId || !selectedFood) {
        alert("‚ö† ÁÑ°Ê≥ïÂèñÂæó‰ΩøÁî®ËÄÖÊàñÂ∫óÂÆ∂Ë≥áË®äÔºÅ");
        return;
      }

      const orderPayload = {
        storeId: selectedFood.storeId,
        memberId: parseInt(memberId),
        pickStat: 2,
        serveStat: 0,
        foodId: selectedFood.foodId,
        attachedId: selectedFood.attachedId || null,
        items: JSON.parse(sessionStorage.getItem('cartItems')) || []
      };

      fetch('/meal/order/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderPayload)
      })
      .then(res => {
        if (!res.ok) throw new Error("‰º∫ÊúçÂô®ÈåØË™§");
        return res.json();
      })
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }
        sessionStorage.setItem("orderSuccess", JSON.stringify(data));
        clearCartStorage();
        fetch('/api/cart/clear', { method: 'POST' });
        window.location.href = "/success.html";
      })
      .catch(err => {
        console.error("Ë®ÇÂñÆÂª∫Á´ãÂ§±ÊïóÔºö", err);
        alert("‚ùå Ë®ÇÂñÆÂª∫Á´ãÂ§±ÊïóÔºåË´ãÁ®çÂæåÂÜçË©¶");
      });
    }

    function clearCartStorage() {
      localStorage.removeItem('selectedFood');
      sessionStorage.removeItem('selectedFood');
      localStorage.removeItem('cartItems');
      sessionStorage.removeItem('cartItems');
    }

    function disableCheckout(msg) {
      const checkoutBtn = document.getElementById('checkoutBtn');
      checkoutBtn.disabled = true;
      checkoutBtn.style.backgroundColor = "#ccc";
      document.getElementById('statusMessage').textContent = msg;
      document.getElementById('statusMessage').style.display = 'block';
      document.querySelectorAll('.cart-item').forEach(item => {
        item.style.opacity = "0.5";
      });
      clearInterval(stockCheckInterval);
      clearInterval(storeCheckInterval);
    }

    function checkStock() {
      if (!cartData.length) return;
      fetch('/meal/cart/stock-status', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(cartData)
      })
      .then(res => res.json())
      .then(stockList => {
        if (stockList.some(item => item.available === false)) {
          disableCheckout("‚ùå ÊúâÂïÜÂìÅÂ∑≤ÂîÆÂÆåÔºåË´ãÈáçÊñ∞ÈªûÈ§ê");
        }
      });
    }

    function checkStoreStatus() {
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
      if (!selectedFood || !selectedFood.storeId) return;

      fetch(`/meal/store/status/${selectedFood.storeId}`)
        .then(res => res.json())
        .then(data => {
          if (data.accepting === false) {
            disableCheckout("üö´ Â∫óÂÆ∂ÁõÆÂâçÁÑ°Ê≥ïÊé•ÂñÆ");
          }
        });
    }

    function goBackToOrder() {
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
      if (selectedFood && selectedFood.storeId && selectedFood.storeName) {
        const storeId = selectedFood.storeId;
        const storeName = encodeURIComponent(selectedFood.storeName);
        window.location.href = `/orderfood.html?id=${storeId}&name=${storeName}`;
      } else {
        window.location.href = '/map2';
    }
    }

    window.onload = () => {
      loadCart();
      startCountdown();
      stockCheckInterval = setInterval(checkStock, 10000);
      storeCheckInterval = setInterval(checkStoreStatus, 15000);
    };
  </script>
</body>
</html>