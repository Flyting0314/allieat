<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>確認訂單 - 攏呷霸 ALLiEAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css">
  <style>
  .checkout-page {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f6f8f9 0%, #e5ebee 100%);
    padding: 30px;
    min-height: 100vh;
  }
  .checkout-page .checkout-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  .checkout-page h2 {
    text-align: center;
    margin-bottom: 30px;
    color: #2c3e50;
    font-weight: 600;
    position: relative;
    padding-bottom: 10px;
  }
  .checkout-page h2::after {
    content: '';
    position: absolute;
    width: 80px;
    height: 3px;
    background-color: #da9f5b;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
  }
  .checkout-page .cart-total {
    text-align: right;
    font-weight: bold;
    font-size: 20px;
    margin-top: 20px;
    color: #2c3e50;
  }
  .checkout-page .btn-checkout,
  .checkout-page .btn-back {
    background-color: #da9f5b;
    border: none;
    padding: 12px 20px;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .checkout-page .btn-checkout:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  .checkout-page .btn-checkout:hover:not(:disabled),
  .checkout-page .btn-back:hover {
    background-color: #c88c4a;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .checkout-page .actions {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }
  .checkout-page #countdown {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #7f8c8d;
  }
  .checkout-page .alert {
    background-color: #f39c12;
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-top: 15px;
    text-align: center;
    font-weight: 500;
  }

  /* 改進的購物車項目樣式 */
  .checkout-page .pretty-cart-item {
    display: flex;
    flex-direction: column;
    background: linear-gradient(to right, #f9f9f9, #f0f0f0);
    border: 1px solid #e0e0e0;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .checkout-page .pretty-cart-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background-color: #da9f5b;
  }
  .checkout-page .pretty-cart-item:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  .checkout-page .pretty-cart-item .line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e6e6e6;
  }
  .checkout-page .pretty-cart-item .line:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }
  .checkout-page .pretty-cart-item .line span.label {
    font-weight: 600;
    color: #34495e;
    min-width: 80px;
    text-align: left;
  }
  .checkout-page .pretty-cart-item .line span.value {
    color: #2c3e50;
    font-weight: 500;
    text-align: right;
  }
</style>
</head>
<body>

<div class="container-fluid p-0 nav-bar">
    <nav class="navbar navbar-expand-lg bg-none navbar-dark py-3">
        <a href="/index.html" class="navbar-brand px-lg-4 m-0">
            <h1 class="m-0 display-4 text-uppercase text-white">
                <img src="/img/logo3.png" width="80px" height="80px" alt="ALLiEAT Logo"
                     style="vertical-align: middle; border-radius: 50%; object-fit: cover;">
                <span style="font-family: 'Satisfy', cursive;">ALLiEAT</span>
            </h1>
        </a>
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
            <div class="navbar-nav ml-auto p-4">
                <a href="/index" class="nav-item nav-link active">關於我們</a>
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">捐款專區</a>
                    <div class="dropdown-menu text-capitalize">
                        <a href="/dona/donaAddA" class="dropdown-item">我要捐款</a>
                        <a href="dona/donaAddD" class="dropdown-item">捐款查詢</a>
                    </div>
                </div>
                <a href="/map2" class="nav-item nav-link">我要取餐 / 點餐</a>

                <!-- 登入 / 登出選項，靜態頁面無法動態切換 -->
                <a href="/registerAndLogin" class="nav-item nav-link">註冊/登入</a>
                <!-- 可選：硬寫一個登出/會員專區按鈕，依實際需求顯示 -->
                <a href="/registerAndLogin/logout" class="nav-item nav-link">登出</a>
                <a href="/member" id="memberAreaBtn" class="nav-item nav-link">會員專區</a>
            </div>
        </div>
    </nav>
</div>
</header>

<!-- Hero Section Start -->
<section id="hero">
    <div class="container-fluid p-0 mb-5">
        <div id="hero-carousel" class="carousel slide overlay-bottom" data-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active" style="
                    background-image: url(/img/圖片3.png);
                    background-size: 110% auto;
                    background-position: center 50px;
                    height: 300px;
                    filter: brightness(225%);">
                    <div class="carousel-caption d-flex flex-column align-items-center justify-content-center">
                        <h2 class="text-primary font-weight-medium m-0"></h2>
                        <h1 class="display-1 text-white m-0"></h1>
                        <h2 class="text-white m-0"></h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Hero Section End -->
  
  <div id="body-section-placeholder"></div>
  <div class="checkout-page">
    <div class="checkout-container">
      <h2>確認您的訂單</h2>
      <div id="countdown">剩餘時間：180 秒</div>
      <div id="cartItems"></div>
      <div class="cart-total" id="cartTotal">總計：0 點</div>
      <div class="alert" id="statusMessage" style="display: none;"></div>
      <div class="actions">
        <button class="btn-back" onclick="goBackToOrder()">⬅ 返回點餐</button>
        <button class="btn-checkout" id="checkoutBtn" onclick="confirmCheckout()">✅ 確認結帳</button>
      </div>
    </div>
  </div>
  <div id="footer-placeholder"></div>
  
  <!-- Footer Start -->
	<div
		class="container-fluid footer text-white pt-5 px-0 position-relative overlay-top">
		<div class="row mx-0 pt-5 px-sm-3 px-lg-5 mt-4">
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">聯絡我們</h4>
				<p>
					<i class="fa fa-map-marker-alt mr-2"></i>台北市愛你區愛你一路5255號
				</p>
				<p>
					<i class="fa fa-phone-alt mr-2"></i>02-2222-5252
				</p>
				<p class="m-0">
					<i class="fa fa-envelope mr-2"></i>allieat105@gmail.com
				</p>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">關注我們</h4>
				<p>在這個世界上，有些人每天為了溫飽而努力，而你的一份愛心，可以成為他們的一絲希望。愛心代用餐是一個簡單卻充滿溫度的公益行動，讓需要幫助的人能夠獲得一份熱騰騰的餐點，感受社會的關懷與支持。</p>
				<div class="d-flex justify-content-start">
					<a class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-twitter"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-facebook-f"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-linkedin-in"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square" href="#"><i
						class="fab fa-instagram"></i></a>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">客服時間</h4>
				<div>
					<h6 class="text-white text-uppercase">周一 - 週五</h6>
					<p>早上10:00 - 晚上21:00</p>
					<h6 class="text-white text-uppercase">週六 - 週日</h6>
					<p>早上11:00 - 晚上19:00</p>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">訂閱電子報</h4>
				<p>訂閱愛心代用餐電子報，獲取最新愛心計畫、新增合作店家與公益活動資訊，讓溫暖持續傳遞！</p>
				<div class="w-100">
					<div class="input-group">
						<input type="text" class="form-control border-light"
							style="padding: 25px;" placeholder="輸入您的信箱">
						<div class="input-group-append">
							<button class="btn btn-primary font-weight-bold px-3">立即訂閱</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div
			class="container-fluid text-center text-white border-top mt-4 py-4 px-sm-3 px-md-5"
			style="border-color: rgba(256, 256, 256, .1) !important;">
			<p class="mb-2 text-white">
				版權所有 &copy; <a class="font-weight-bold" href="#">攏呷霸股份有限公司</a>.
				保留所有權利
			</p>
			<p class="m-0 text-white">
				網站設計由 <a class="font-weight-bold" href="#">攏呷霸股份有限公司 設計部 設計</a>
			</p>
		</div>
	</div>
	<!-- Footer End -->

  
  <!-- 原始 checkout JS 功能 -->
  <script>
    let cartData = [];
    let timer = 100;
    let countdownInterval;
    let stockCheckInterval;
    let storeCheckInterval;

    function startCountdown() {
      updateCountdownDisplay();
      countdownInterval = setInterval(() => {
        timer--;
        updateCountdownDisplay();
        if (timer <= 0) {
          clearInterval(countdownInterval);
          clearInterval(stockCheckInterval);
          clearInterval(storeCheckInterval);
          fetch('/api/cart/clear', { method: 'POST' })
            .then(() => {
              disableCheckout("⏰ 時間已到，購物車已清空，請重新點餐");
              setTimeout(goBackToOrder, 2000);
            })
            .catch(err => {
              console.error("清空購物車失敗：", err);
              disableCheckout("❌ 清空失敗，請手動返回點餐頁");
            });
        }
      }, 1000);
    }

    function updateCountdownDisplay() {
      document.getElementById('countdown').textContent = `剩餘時間：${timer} 秒`;
    }

    function loadCart() {
      fetch('/api/cart')
        .then(res => res.json())
        .then(cart => {
          if (!cart || cart.length === 0) {
            disableCheckout("🛒 購物車是空的，請返回點餐");
            return;
          }
          return fetch('/meal/cart/details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cart)
          });
        })
        .then(res => res?.json())
        .then(details => {
          if (!details) return;
          cartData = details;
          renderCart();
        })
        .catch(err => {
          console.error("載入購物車失敗：", err);
          disableCheckout("❌ 系統異常，請稍後再試");
        });
    }

    function renderCart() {
    	  const cartItems = document.getElementById('cartItems');
    	  cartItems.innerHTML = '';
    	  let total = 0;

    	  cartData.forEach(item => {
    	    total += item.cost * item.quantity;
    	    const div = document.createElement('div');
    	    div.className = 'pretty-cart-item';
    	    div.innerHTML = `
    	      <div class="line"><span class="label">主餐</span><span class="value">${item.foodName}</span></div>
    	      <div class="line"><span class="label">附餐</span><span class="value">${item.attachedName}</span></div>
    	      <div class="line"><span class="label">數量</span><span class="value">${item.quantity}</span></div>
    	      <div class="line"><span class="label">點數</span><span class="value">${item.cost * item.quantity}</span></div>
    	    `;
    	    cartItems.appendChild(div);
    	  });

    	  document.getElementById('cartTotal').textContent = `總計：${total} 點`;

    	  const cartItemsForSubmit = cartData.map(item => ({
    	    foodId: item.foodId,
    	    foodName: item.foodName,
    	    attachedName: item.attachedName,
    	    quantity: item.quantity,
    	    pointsCost: item.cost,
    	    note: item.note || ""
    	  }));

    	  sessionStorage.setItem('cartItems', JSON.stringify(cartItemsForSubmit));
    	}

    function confirmCheckout() {
      const memberId = localStorage.getItem('memberId');
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));

      if (!memberId || !selectedFood) {
        alert("⚠ 無法取得使用者或店家資訊！");
        return;
      }

      const orderPayload = {
        storeId: selectedFood.storeId,
        memberId: parseInt(memberId),
        pickStat: 2,
        serveStat: 0,
        foodId: selectedFood.foodId,
        attachedId: selectedFood.attachedId || null,
        items: JSON.parse(sessionStorage.getItem('cartItems')) || []
      };

      fetch('/meal/order/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderPayload)
      })
      .then(res => {
        if (!res.ok) throw new Error("伺服器錯誤");
        return res.json();
      })
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }
        sessionStorage.setItem("orderSuccess", JSON.stringify(data));
        clearCartStorage();
        fetch('/api/cart/clear', { method: 'POST' });
        window.location.href = "/success.html";
      })
      .catch(err => {
        console.error("訂單建立失敗：", err);
        alert("❌ 訂單建立失敗，請稍後再試");
      });
    }

    function clearCartStorage() {
      localStorage.removeItem('selectedFood');
      sessionStorage.removeItem('selectedFood');
      localStorage.removeItem('cartItems');
      sessionStorage.removeItem('cartItems');
    }

    function disableCheckout(msg) {
      const checkoutBtn = document.getElementById('checkoutBtn');
      checkoutBtn.disabled = true;
      checkoutBtn.style.backgroundColor = "#ccc";
      document.getElementById('statusMessage').textContent = msg;
      document.getElementById('statusMessage').style.display = 'block';
      document.querySelectorAll('.cart-item').forEach(item => {
        item.style.opacity = "0.5";
      });
      clearInterval(stockCheckInterval);
      clearInterval(storeCheckInterval);
    }

    function checkStock() {
    	  if (!cartData.length) return;

    	  fetch('/meal/cart/stock-status', {
    	    method: 'POST',
    	    headers: { 'Content-Type': 'application/json' },
    	    body: JSON.stringify(cartData)
    	  })
    	  .then(res => res.json())
    	  .then(stockList => {
    	    const soldOutItem = stockList.find(item => item.available === false);
    	    if (soldOutItem) {
    	      disableCheckout(`❌ ${soldOutItem.foodName || '某項餐點'} 已售完，請重新點餐`);
    	      
    	      // 額外提示畫面
    	      showOutOfStockModal(soldOutItem.foodName || '某項餐點');
    	    }
    	  });
    	}


    function checkStoreStatus() {
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
      if (!selectedFood || !selectedFood.storeId) return;

      fetch(`/meal/store/status/${selectedFood.storeId}`)
        .then(res => res.json())
        .then(data => {
          if (data.accepting === false) {
            disableCheckout("🚫 店家目前無法接單");
          }
        });
    }

    function goBackToOrder() {
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
      if (selectedFood && selectedFood.storeId && selectedFood.storeName) {
        const storeId = selectedFood.storeId;
        const storeName = encodeURIComponent(selectedFood.storeName);
        window.location.href = `/orderfood.html?id=${storeId}&name=${storeName}`;
      } else {
        window.location.href = '/map2';
    }
    }

    window.onload = () => {
      loadCart();
      startCountdown();
      stockCheckInterval = setInterval(checkStock, 1000);
      storeCheckInterval = setInterval(checkStoreStatus, 15000);
    };
    
    function showOutOfStockModal(foodName) {
    	  const modal = document.getElementById("stockModal");
    	  const text = document.getElementById("modalStockText");
    	  text.textContent = `【${foodName}】已售完，請選擇其他餐點。`;
    	  modal.style.display = "flex";
    	}

    
    
  </script>
  
  <div id="stockModal" style="display:none; position:fixed; top:0; left:0; 
    width:100%; height:100%; background:rgba(0,0,0,0.6); 
    z-index:2000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; max-width:90%; width:400px;">
    <h3 style="color:#e74c3c;">該餐點已無庫存</h3>
    <p id="modalStockText">請選擇其他餐點</p>
    <button onclick="goBackToOrder()" style="margin-top:20px; background:#2980b9; color:white; padding:10px 20px; border:none; border-radius:6px;">返回點餐頁面</button>
  </div>
</div>
  
</body>
</html>