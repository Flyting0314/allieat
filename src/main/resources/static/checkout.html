<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>ç¢ºèªè¨‚å–® - æ”å‘·éœ¸ ALLiEAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="/css/style.css">
  <style>
  .checkout-page {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #f6f8f9 0%, #e5ebee 100%);
    padding: 30px;
    min-height: 100vh;
  }
  .checkout-page .checkout-container {
    max-width: 800px;
    margin: 0 auto;
    background: white;
    padding: 40px;
    border-radius: 15px;
    box-shadow: 0 10px 25px rgba(0, 0, 0, 0.1);
  }
  .checkout-page h2 {
    text-align: center;
    margin-bottom: 30px;
    color: #2c3e50;
    font-weight: 600;
    position: relative;
    padding-bottom: 10px;
  }
  .checkout-page h2::after {
    content: '';
    position: absolute;
    width: 80px;
    height: 3px;
    background-color: #da9f5b;
    bottom: 0;
    left: 50%;
    transform: translateX(-50%);
  }
  .checkout-page .cart-total {
    text-align: right;
    font-weight: bold;
    font-size: 20px;
    margin-top: 20px;
    color: #2c3e50;
  }
  .checkout-page .btn-checkout,
  .checkout-page .btn-back {
    background-color: #da9f5b;
    border: none;
    padding: 12px 20px;
    color: white;
    font-weight: bold;
    border-radius: 8px;
    cursor: pointer;
    transition: 0.3s;
    text-transform: uppercase;
    letter-spacing: 1px;
  }
  .checkout-page .btn-checkout:disabled {
    background-color: #ccc;
    cursor: not-allowed;
  }
  .checkout-page .btn-checkout:hover:not(:disabled),
  .checkout-page .btn-back:hover {
    background-color: #c88c4a;
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.1);
  }
  .checkout-page .actions {
    margin-top: 30px;
    display: flex;
    justify-content: space-between;
  }
  .checkout-page #countdown {
    text-align: center;
    font-size: 18px;
    font-weight: bold;
    margin-bottom: 20px;
    color: #7f8c8d;
  }
  .checkout-page .alert {
    background-color: #f39c12;
    color: white;
    padding: 12px;
    border-radius: 8px;
    margin-top: 15px;
    text-align: center;
    font-weight: 500;
  }

  /* æ”¹é€²çš„è³¼ç‰©è»Šé …ç›®æ¨£å¼ */
  .checkout-page .pretty-cart-item {
    display: flex;
    flex-direction: column;
    background: linear-gradient(to right, #f9f9f9, #f0f0f0);
    border: 1px solid #e0e0e0;
    border-radius: 15px;
    padding: 20px;
    margin-bottom: 20px;
    box-shadow: 0 6px 12px rgba(0,0,0,0.05);
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .checkout-page .pretty-cart-item::before {
    content: '';
    position: absolute;
    top: 0;
    left: 0;
    width: 5px;
    height: 100%;
    background-color: #da9f5b;
  }
  .checkout-page .pretty-cart-item:hover {
    transform: scale(1.02);
    box-shadow: 0 8px 16px rgba(0,0,0,0.1);
  }
  .checkout-page .pretty-cart-item .line {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 10px;
    font-size: 16px;
    padding-bottom: 10px;
    border-bottom: 1px solid #e6e6e6;
  }
  .checkout-page .pretty-cart-item .line:last-child {
    border-bottom: none;
    margin-bottom: 0;
  }
  .checkout-page .pretty-cart-item .line span.label {
    font-weight: 600;
    color: #34495e;
    min-width: 80px;
    text-align: left;
  }
  .checkout-page .pretty-cart-item .line span.value {
    color: #2c3e50;
    font-weight: 500;
    text-align: right;
  }
</style>
</head>
<body>

<div class="container-fluid p-0 nav-bar">
    <nav class="navbar navbar-expand-lg bg-none navbar-dark py-3">
        <a href="/index.html" class="navbar-brand px-lg-4 m-0">
            <h1 class="m-0 display-4 text-uppercase text-white">
                <img src="/img/logo3.png" width="80px" height="80px" alt="ALLiEAT Logo"
                     style="vertical-align: middle; border-radius: 50%; object-fit: cover;">
                <span style="font-family: 'Satisfy', cursive;">ALLiEAT</span>
            </h1>
        </a>
        <button type="button" class="navbar-toggler" data-toggle="collapse" data-target="#navbarCollapse">
            <span class="navbar-toggler-icon"></span>
        </button>
        <div class="collapse navbar-collapse justify-content-between" id="navbarCollapse">
            <div class="navbar-nav ml-auto p-4">
                <a href="/index" class="nav-item nav-link active">é—œæ–¼æˆ‘å€‘</a>
                <div class="nav-item dropdown">
                    <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">ææ¬¾å°ˆå€</a>
                    <div class="dropdown-menu text-capitalize">
                        <a href="/dona/donaAddA" class="dropdown-item">æˆ‘è¦ææ¬¾</a>
                        <a href="dona/donaAddD" class="dropdown-item">ææ¬¾æŸ¥è©¢</a>
                    </div>
                </div>
                <a href="/map2" class="nav-item nav-link">æˆ‘è¦å–é¤ / é»é¤</a>

                <!-- ç™»å…¥ / ç™»å‡ºé¸é …ï¼Œéœæ…‹é é¢ç„¡æ³•å‹•æ…‹åˆ‡æ› -->
                <a href="/registerAndLogin" class="nav-item nav-link">è¨»å†Š/ç™»å…¥</a>
                <!-- å¯é¸ï¼šç¡¬å¯«ä¸€å€‹ç™»å‡º/æœƒå“¡å°ˆå€æŒ‰éˆ•ï¼Œä¾å¯¦éš›éœ€æ±‚é¡¯ç¤º -->
                <a href="/registerAndLogin/logout" class="nav-item nav-link">ç™»å‡º</a>
                <a href="/member" id="memberAreaBtn" class="nav-item nav-link">æœƒå“¡å°ˆå€</a>
            </div>
        </div>
    </nav>
</div>
</header>

<!-- Hero Section Start -->
<section id="hero">
    <div class="container-fluid p-0 mb-5">
        <div id="hero-carousel" class="carousel slide overlay-bottom" data-ride="carousel">
            <div class="carousel-inner">
                <div class="carousel-item active" style="
                    background-image: url(/img/åœ–ç‰‡3.png);
                    background-size: 110% auto;
                    background-position: center 50px;
                    height: 300px;
                    filter: brightness(225%);">
                    <div class="carousel-caption d-flex flex-column align-items-center justify-content-center">
                        <h2 class="text-primary font-weight-medium m-0"></h2>
                        <h1 class="display-1 text-white m-0"></h1>
                        <h2 class="text-white m-0"></h2>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>
<!-- Hero Section End -->
  
  <div id="body-section-placeholder"></div>
  <div class="checkout-page">
    <div class="checkout-container">
      <h2>ç¢ºèªæ‚¨çš„è¨‚å–®</h2>
      <div id="countdown">å‰©é¤˜æ™‚é–“ï¼š180 ç§’</div>
      <div id="cartItems"></div>
      <div class="cart-total" id="cartTotal">ç¸½è¨ˆï¼š0 é»</div>
      <div class="alert" id="statusMessage" style="display: none;"></div>
      <div class="actions">
        <button class="btn-back" onclick="goBackToOrder()">â¬… è¿”å›é»é¤</button>
        <button class="btn-checkout" id="checkoutBtn" onclick="confirmCheckout()">âœ… ç¢ºèªçµå¸³</button>
      </div>
    </div>
  </div>
  <div id="footer-placeholder"></div>
  
  <!-- Footer Start -->
	<div
		class="container-fluid footer text-white pt-5 px-0 position-relative overlay-top">
		<div class="row mx-0 pt-5 px-sm-3 px-lg-5 mt-4">
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">è¯çµ¡æˆ‘å€‘</h4>
				<p>
					<i class="fa fa-map-marker-alt mr-2"></i>å°åŒ—å¸‚æ„›ä½ å€æ„›ä½ ä¸€è·¯5255è™Ÿ
				</p>
				<p>
					<i class="fa fa-phone-alt mr-2"></i>02-2222-5252
				</p>
				<p class="m-0">
					<i class="fa fa-envelope mr-2"></i>allieat105@gmail.com
				</p>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">é—œæ³¨æˆ‘å€‘</h4>
				<p>åœ¨é€™å€‹ä¸–ç•Œä¸Šï¼Œæœ‰äº›äººæ¯å¤©ç‚ºäº†æº«é£½è€ŒåŠªåŠ›ï¼Œè€Œä½ çš„ä¸€ä»½æ„›å¿ƒï¼Œå¯ä»¥æˆç‚ºä»–å€‘çš„ä¸€çµ²å¸Œæœ›ã€‚æ„›å¿ƒä»£ç”¨é¤æ˜¯ä¸€å€‹ç°¡å–®å»å……æ»¿æº«åº¦çš„å…¬ç›Šè¡Œå‹•ï¼Œè®“éœ€è¦å¹«åŠ©çš„äººèƒ½å¤ ç²å¾—ä¸€ä»½ç†±é¨°é¨°çš„é¤é»ï¼Œæ„Ÿå—ç¤¾æœƒçš„é—œæ‡·èˆ‡æ”¯æŒã€‚</p>
				<div class="d-flex justify-content-start">
					<a class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-twitter"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-facebook-f"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
						class="fab fa-linkedin-in"></i></a> <a
						class="btn btn-lg btn-outline-light btn-lg-square" href="#"><i
						class="fab fa-instagram"></i></a>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">å®¢æœæ™‚é–“</h4>
				<div>
					<h6 class="text-white text-uppercase">å‘¨ä¸€ - é€±äº”</h6>
					<p>æ—©ä¸Š10:00 - æ™šä¸Š21:00</p>
					<h6 class="text-white text-uppercase">é€±å…­ - é€±æ—¥</h6>
					<p>æ—©ä¸Š11:00 - æ™šä¸Š19:00</p>
				</div>
			</div>
			<div class="col-lg-3 col-md-6 mb-5">
				<h4 class="text-white text-uppercase mb-4"
					style="letter-spacing: 3px;">è¨‚é–±é›»å­å ±</h4>
				<p>è¨‚é–±æ„›å¿ƒä»£ç”¨é¤é›»å­å ±ï¼Œç²å–æœ€æ–°æ„›å¿ƒè¨ˆç•«ã€æ–°å¢åˆä½œåº—å®¶èˆ‡å…¬ç›Šæ´»å‹•è³‡è¨Šï¼Œè®“æº«æš–æŒçºŒå‚³éï¼</p>
				<div class="w-100">
					<div class="input-group">
						<input type="text" class="form-control border-light"
							style="padding: 25px;" placeholder="è¼¸å…¥æ‚¨çš„ä¿¡ç®±">
						<div class="input-group-append">
							<button class="btn btn-primary font-weight-bold px-3">ç«‹å³è¨‚é–±</button>
						</div>
					</div>
				</div>
			</div>
		</div>
		<div
			class="container-fluid text-center text-white border-top mt-4 py-4 px-sm-3 px-md-5"
			style="border-color: rgba(256, 256, 256, .1) !important;">
			<p class="mb-2 text-white">
				ç‰ˆæ¬Šæ‰€æœ‰ &copy; <a class="font-weight-bold" href="#">æ”å‘·éœ¸è‚¡ä»½æœ‰é™å…¬å¸</a>.
				ä¿ç•™æ‰€æœ‰æ¬Šåˆ©
			</p>
			<p class="m-0 text-white">
				ç¶²ç«™è¨­è¨ˆç”± <a class="font-weight-bold" href="#">æ”å‘·éœ¸è‚¡ä»½æœ‰é™å…¬å¸ è¨­è¨ˆéƒ¨ è¨­è¨ˆ</a>
			</p>
		</div>
	</div>
	<!-- Footer End -->

  
  <!-- åŸå§‹ checkout JS åŠŸèƒ½ -->
  <script>
    let cartData = [];
    let timer = 100;
    let countdownInterval;
    let stockCheckInterval;
    let storeCheckInterval;

    function startCountdown() {
      updateCountdownDisplay();
      countdownInterval = setInterval(() => {
        timer--;
        updateCountdownDisplay();
        if (timer <= 0) {
          clearInterval(countdownInterval);
          clearInterval(stockCheckInterval);
          clearInterval(storeCheckInterval);
          fetch('/api/cart/clear', { method: 'POST' })
            .then(() => {
              disableCheckout("â° æ™‚é–“å·²åˆ°ï¼Œè³¼ç‰©è»Šå·²æ¸…ç©ºï¼Œè«‹é‡æ–°é»é¤");
              setTimeout(goBackToOrder, 2000);
            })
            .catch(err => {
              console.error("æ¸…ç©ºè³¼ç‰©è»Šå¤±æ•—ï¼š", err);
              disableCheckout("âŒ æ¸…ç©ºå¤±æ•—ï¼Œè«‹æ‰‹å‹•è¿”å›é»é¤é ");
            });
        }
      }, 1000);
    }

    function updateCountdownDisplay() {
      document.getElementById('countdown').textContent = `å‰©é¤˜æ™‚é–“ï¼š${timer} ç§’`;
    }

    function loadCart() {
      fetch('/api/cart')
        .then(res => res.json())
        .then(cart => {
          if (!cart || cart.length === 0) {
            disableCheckout("ğŸ›’ è³¼ç‰©è»Šæ˜¯ç©ºçš„ï¼Œè«‹è¿”å›é»é¤");
            return;
          }
          return fetch('/meal/cart/details', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(cart)
          });
        })
        .then(res => res?.json())
        .then(details => {
          if (!details) return;
          cartData = details;
          renderCart();
        })
        .catch(err => {
          console.error("è¼‰å…¥è³¼ç‰©è»Šå¤±æ•—ï¼š", err);
          disableCheckout("âŒ ç³»çµ±ç•°å¸¸ï¼Œè«‹ç¨å¾Œå†è©¦");
        });
    }

    function renderCart() {
    	  const cartItems = document.getElementById('cartItems');
    	  cartItems.innerHTML = '';
    	  let total = 0;

    	  cartData.forEach(item => {
    	    total += item.cost * item.quantity;
    	    const div = document.createElement('div');
    	    div.className = 'pretty-cart-item';
    	    div.innerHTML = `
    	      <div class="line"><span class="label">ä¸»é¤</span><span class="value">${item.foodName}</span></div>
    	      <div class="line"><span class="label">é™„é¤</span><span class="value">${item.attachedName}</span></div>
    	      <div class="line"><span class="label">æ•¸é‡</span><span class="value">${item.quantity}</span></div>
    	      <div class="line"><span class="label">é»æ•¸</span><span class="value">${item.cost * item.quantity}</span></div>
    	    `;
    	    cartItems.appendChild(div);
    	  });

    	  document.getElementById('cartTotal').textContent = `ç¸½è¨ˆï¼š${total} é»`;

    	  const cartItemsForSubmit = cartData.map(item => ({
    	    foodId: item.foodId,
    	    foodName: item.foodName,
    	    attachedName: item.attachedName,
    	    quantity: item.quantity,
    	    pointsCost: item.cost,
    	    note: item.note || ""
    	  }));

    	  sessionStorage.setItem('cartItems', JSON.stringify(cartItemsForSubmit));
    	}

    function confirmCheckout() {
      const memberId = localStorage.getItem('memberId');
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));

      if (!memberId || !selectedFood) {
        alert("âš  ç„¡æ³•å–å¾—ä½¿ç”¨è€…æˆ–åº—å®¶è³‡è¨Šï¼");
        return;
      }

      const orderPayload = {
        storeId: selectedFood.storeId,
        memberId: parseInt(memberId),
        pickStat: 2,
        serveStat: 0,
        foodId: selectedFood.foodId,
        attachedId: selectedFood.attachedId || null,
        items: JSON.parse(sessionStorage.getItem('cartItems')) || []
      };

      fetch('/meal/order/submit', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify(orderPayload)
      })
      .then(res => {
        if (!res.ok) throw new Error("ä¼ºæœå™¨éŒ¯èª¤");
        return res.json();
      })
      .then(data => {
        if (data.error) {
          alert(data.error);
          return;
        }
        sessionStorage.setItem("orderSuccess", JSON.stringify(data));
        clearCartStorage();
        fetch('/api/cart/clear', { method: 'POST' });
        window.location.href = "/success.html";
      })
      .catch(err => {
        console.error("è¨‚å–®å»ºç«‹å¤±æ•—ï¼š", err);
        alert("âŒ è¨‚å–®å»ºç«‹å¤±æ•—ï¼Œè«‹ç¨å¾Œå†è©¦");
      });
    }

    function clearCartStorage() {
      localStorage.removeItem('selectedFood');
      sessionStorage.removeItem('selectedFood');
      localStorage.removeItem('cartItems');
      sessionStorage.removeItem('cartItems');
    }

    function disableCheckout(msg) {
      const checkoutBtn = document.getElementById('checkoutBtn');
      checkoutBtn.disabled = true;
      checkoutBtn.style.backgroundColor = "#ccc";
      document.getElementById('statusMessage').textContent = msg;
      document.getElementById('statusMessage').style.display = 'block';
      document.querySelectorAll('.cart-item').forEach(item => {
        item.style.opacity = "0.5";
      });
      clearInterval(stockCheckInterval);
      clearInterval(storeCheckInterval);
    }

    function checkStock() {
    	  if (!cartData.length) return;

    	  fetch('/meal/cart/stock-status', {
    	    method: 'POST',
    	    headers: { 'Content-Type': 'application/json' },
    	    body: JSON.stringify(cartData)
    	  })
    	  .then(res => res.json())
    	  .then(stockList => {
    	    const soldOutItem = stockList.find(item => item.available === false);
    	    if (soldOutItem) {
    	      disableCheckout(`âŒ ${soldOutItem.foodName || 'æŸé …é¤é»'} å·²å”®å®Œï¼Œè«‹é‡æ–°é»é¤`);
    	      
    	      // é¡å¤–æç¤ºç•«é¢
    	      showOutOfStockModal(soldOutItem.foodName || 'æŸé …é¤é»');
    	    }
    	  });
    	}


    function checkStoreStatus() {
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
      if (!selectedFood || !selectedFood.storeId) return;

      fetch(`/meal/store/status/${selectedFood.storeId}`)
        .then(res => res.json())
        .then(data => {
          if (data.accepting === false) {
            disableCheckout("ğŸš« åº—å®¶ç›®å‰ç„¡æ³•æ¥å–®");
          }
        });
    }

    function goBackToOrder() {
      const selectedFood = JSON.parse(localStorage.getItem('selectedFood'));
      if (selectedFood && selectedFood.storeId && selectedFood.storeName) {
        const storeId = selectedFood.storeId;
        const storeName = encodeURIComponent(selectedFood.storeName);
        window.location.href = `/orderfood.html?id=${storeId}&name=${storeName}`;
      } else {
        window.location.href = '/map2';
    }
    }

    window.onload = () => {
      loadCart();
      startCountdown();
      stockCheckInterval = setInterval(checkStock, 1000);
      storeCheckInterval = setInterval(checkStoreStatus, 15000);
    };
    
    function showOutOfStockModal(foodName) {
    	  const modal = document.getElementById("stockModal");
    	  const text = document.getElementById("modalStockText");
    	  text.textContent = `ã€${foodName}ã€‘å·²å”®å®Œï¼Œè«‹é¸æ“‡å…¶ä»–é¤é»ã€‚`;
    	  modal.style.display = "flex";
    	}

    
    
  </script>
  
  <div id="stockModal" style="display:none; position:fixed; top:0; left:0; 
    width:100%; height:100%; background:rgba(0,0,0,0.6); 
    z-index:2000; justify-content:center; align-items:center;">
  <div style="background:white; padding:30px; border-radius:12px; text-align:center; max-width:90%; width:400px;">
    <h3 style="color:#e74c3c;">è©²é¤é»å·²ç„¡åº«å­˜</h3>
    <p id="modalStockText">è«‹é¸æ“‡å…¶ä»–é¤é»</p>
    <button onclick="goBackToOrder()" style="margin-top:20px; background:#2980b9; color:white; padding:10px 20px; border:none; border-radius:6px;">è¿”å›é»é¤é é¢</button>
  </div>
</div>
  
</body>
</html>