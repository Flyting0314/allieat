<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>取餐地圖 - ALLiEAT</title>
</head>
<body>
  <h1>等待取餐通知中...</h1>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      console.log("🚀 頁面已載入，開始Firebase初始化");

      // 🔔 請求通知權限
      const permission = await Notification.requestPermission();
      console.log("🔔 通知權限：", permission);

      if (permission !== "granted") {
        alert("⚠️ 請允許通知功能，才能在餐點完成時收到提醒！");
        return;
      }

      // ✅ 初始化 Firebase
      firebase.initializeApp({
        apiKey: "AIzaSyA68z34B-2gMTza5XihaqtGUeNlKi3-pVU",
        authDomain: "allieat-notification.firebaseapp.com",
        projectId: "allieat-notification",
        messagingSenderId: "613984391786",
        appId: "1:613984391786:web:f5fc9510d0ef5f972d3013"
      });

      const messaging = firebase.messaging();

      // ✅ 註冊 service worker 並取得 token
      navigator.serviceWorker.register("/firebase-messaging-sw.js")
        .then(reg => {
          console.log("✅ Service Worker註冊成功");
          return messaging.getToken({
            vapidKey: "BMhduGYc_FYGv9W9jCouQGGJlIkDi71agZasPO1ufaui5qXbVIY35W4_MVmw1P3GlcV026ifk5sS1bOLQNDidUY",
            serviceWorkerRegistration: reg
          });
        })
        .then(token => {
          console.log("✅ 拿到token：", token);

          // ✅ 傳 token 到後端，關聯訂單資訊
          const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};
          const orderId = orderData?.orderId;
          console.log("📦 orderId：", orderId);

          if (token && orderId) {
            fetch("/api/fcm/register-token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token, orderId })
            })
            .then(response => {
              if (response.ok) {
                console.log("✅ Token已成功送到後端");
              } else {
                console.error("❌ Token送到後端失敗，狀態碼：", response.status);
              }
            })
            .catch(err => {
              console.error("❌ 傳送token到後端時出錯：", err);
            });
          } else {
            console.error("❌ token 或 orderId 不存在，無法傳送");
          }
        })
        .catch(err => {
          console.error("❌ 無法取得 token：", err);
        });

      // 🔔 處理前景推播訊息（例如：取餐通知）
      messaging.onMessage(payload => {
        console.log("📨 收到前景推播訊息：", payload);
        alert(`🔔 ${payload.notification.title}\n${payload.notification.body}`);
      });
    });
  </script>
</body>
</html>