<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8" />
  <title>取餐地點 - 攏呷霸 ALLiEAT</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }

    .navbar {
      background-color: white;
      padding: 15px 30px;
      box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .navbar .logo {
      display: flex;
      align-items: center;
    }

    .navbar .logo img {
      height: 60px;
      margin-right: 15px;
    }

    .navbar h1 {
      font-size: 28px;
      color: #003366;
      font-weight: bold;
    }

    .container {
      display: flex;
      padding: 30px;
    }

    .store-info {
      width: 25%;
      padding: 20px;
      border: 2px dashed #aaaaff;
      border-radius: 10px;
      background-color: #ffffff;
      margin-right: 30px;
    }

    .store-info h2 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }

    .store-info p {
      margin-top: 8px;
      font-size: 16px;
      color: #555;
    }

    .store-info a {
      color: #0077cc;
      text-decoration: underline;
    }

    .order-item {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }

    .order-item p {
      margin: 4px 0;
    }

    .total-points {
      font-weight: bold;
      margin-top: 15px;
      font-size: 18px;
      color: #444;
    }

    #map {
      width: 75%;
      height: 500px;
      border-radius: 10px;
    }
  </style>
</head>
<body>
  <!-- Navbar -->
  <div class="navbar">
    <div class="logo">
      <img src="/img/logo3.png" alt="logo" />
      <h1>攏呷霸</h1>
    </div>
    <div>
      <a href="/index.html">首頁</a> | <a href="/logout">登出</a>
    </div>
  </div>

  <!-- Main Content -->
  <div class="container">
    <div class="store-info">
      <h2 id="storeName">店家名稱</h2>
      <p id="storeAddress">店家地址</p>
      <p><a id="googleMapLink" href="#" target="_blank">在 Google 地圖中開啟</a></p>

      <div class="order-detail" style="margin-top: 20px;">
        <h3>訂單明細</h3>
        <div id="orderDetails">載入中...</div>
        <div class="total-points" id="totalPoints"></div>
      </div>
    </div>
    <div id="map"></div>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const orderDataStr = sessionStorage.getItem("orderSuccess");

      if (!orderDataStr) {
        alert("⚠️ 無法取得訂單資訊，將跳回首頁！");
        location.href = "/index.html";
        return;
      }

      const orderData = JSON.parse(orderDataStr);
      console.log("🧪 從 sessionStorage 取得的訂單資訊：", orderData);

      document.getElementById("storeName").textContent = orderData.storeName || "未知店家";
      document.getElementById("storeAddress").textContent = orderData.address || "未提供地址";

      const encodedAddress = encodeURIComponent(orderData.address || "");
      document.getElementById("googleMapLink").href =
        `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;

      const container = document.getElementById("orderDetails");
      container.innerHTML = "";
      let total = 0;

      if (orderData.details && orderData.details.length > 0) {
        orderData.details.forEach(detail => {
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("order-item");
          itemDiv.innerHTML = `
            <p><strong>主餐：</strong>${detail.foodName || "未提供"}</p>
            <p><strong>數量：</strong>${detail.quantity ?? "-"}</p>
            <p><strong>使用點數：</strong>${detail.pointsCost ?? "-"}</p>
            <p><strong>成立時間：</strong>${formatDateTime(detail.createdTime) || "-"}</p>
            <p><strong>備註：</strong>${detail.note || "無"}</p>
          `;
          container.appendChild(itemDiv);
          total += (detail.pointsCost || 0) * (detail.quantity || 1);
        });

        document.getElementById("totalPoints").textContent = `🧾 訂單總點數：${total} 點`;
      } else {
        container.innerHTML = "<p>❌ 找不到訂單明細</p>";
      }

      function formatDateTime(timestamp) {
        const d = new Date(timestamp);
        return d.toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
      }


    });

    function initMap() {
      const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};
      const defaultLocation = { lat: 25.0330, lng: 121.5654 };

      const storeLat = parseFloat(orderData.storeLat);
      const storeLng = parseFloat(orderData.storeLng);
      const hasCoords = !isNaN(storeLat) && !isNaN(storeLng);

      if (hasCoords) {
        renderMap({ lat: storeLat, lng: storeLng });
      } else {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: orderData.address }, (results, status) => {
          if (status === "OK" && results[0]) {
            const loc = results[0].geometry.location;
            renderMap({ lat: loc.lat(), lng: loc.lng() });
          } else {
            console.warn("⚠️ 地址轉換失敗，使用預設位置");
            renderMap(defaultLocation);
          }
        });
      }
    }

    function renderMap(location) {
      const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};

      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 16,
        center: location,
      });

      const marker = new google.maps.Marker({
        position: location,
        map: map,
      });

      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div>
            <strong>${orderData?.storeName || '店家名稱'}</strong><br/>
            取餐號碼：${orderData?.pickupCode || '------'}<br/>
            取餐時間：店家接單後會通知您
          </div>
        `
      });

      marker.addListener("click", () => infoWindow.open(map, marker));
      infoWindow.open(map, marker);
    }

    window.initMap = initMap;
  </script>

  <!-- Google Maps API -->
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwk4bH6RdOWmqwmrpdYu7-NKZin0St0vQ&libraries=places&callback=initMap&region=TW&language=zh-TW">
  </script>
</body>
</html>
