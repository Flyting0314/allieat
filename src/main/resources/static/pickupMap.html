<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="utf-8">
<script th:inline="javascript">
  window.isMember = /*[[${session.member != null}]]*/ false;
  window.isStore = /*[[${session.store != null}]]*/ false;
</script>
<style>
    body {
      font-family: 'Arial', sans-serif;
      background-color: #f4f4f4;
      margin: 0;
      padding: 0;
    }
    .container {
      display: flex;
      padding: 30px;
    }
    .store-info {
      width: 25%;
      padding: 20px;
      border: 2px dashed #aaaaff;
      border-radius: 10px;
      background-color: #ffffff;
      margin-right: 30px;
    }
    .store-info h2 {
      margin: 0;
      font-size: 20px;
      color: #333;
    }
    .store-info p {
      margin-top: 8px;
      font-size: 16px;
      color: #555;
    }
    .store-info a {
      color: #0077cc;
      text-decoration: underline;
    }
    .order-item {
      background-color: #f9f9f9;
      border-radius: 8px;
      padding: 12px;
      margin-bottom: 16px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    }
    .order-item p {
      margin: 4px 0;
    }
    .total-points {
      font-weight: bold;
      margin-top: 15px;
      font-size: 18px;
      color: #444;
    }
    #map {
      width: 75%;
      height: 500px;
      border-radius: 10px;
    }
    
 </style>
<script>
  window.renderMode = "fetch";
  window.isMember = false;
 window.isStore = false;
</script>
</head>
<body>

<div id="header-container"></div>
<div id="bodySection-container"></div>
<!-- Navbar Start -->
<!-- Hero Section End -->
  <div id="header-placeholder"></div>
  <div id="body-section-placeholder"></div>
  <div class="container">
    <div class="store-info">
      <h2 id="storeName">åº—å®¶åç¨±</h2>
      <p id="storeAddress">åº—å®¶åœ°å€</p>
      <p><a id="googleMapLink" href="#" target="_blank">åœ¨ Google åœ°åœ–ä¸­é–‹å•Ÿ</a></p>
      <div class="order-detail" style="margin-top: 20px;">
        <h3>è¨‚å–®æ˜ç´°</h3>
        <div id="orderDetails">è¼‰å…¥ä¸­...</div>
        <div class="total-points" id="totalPoints"></div>
      </div>
    </div>
    <div id="map"></div>
  </div>
<!--   <div id="footer-placeholder"></div> -->



  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const orderDataStr = sessionStorage.getItem("orderSuccess");
      if (!orderDataStr) {
        alert("âš ï¸ ç„¡æ³•å–å¾—è¨‚å–®è³‡è¨Šï¼Œå°‡è·³å›é¦–é ï¼");
        location.href = "/index.html";
        return;
      }
      const orderData = JSON.parse(orderDataStr);
      document.getElementById("storeName").textContent = orderData.storeName || "æœªçŸ¥åº—å®¶";
      document.getElementById("storeAddress").textContent = orderData.address || "æœªæä¾›åœ°å€";
      const encodedAddress = encodeURIComponent(orderData.address || "");
      document.getElementById("googleMapLink").href =
        `https://www.google.com/maps/search/?api=1&query=${encodedAddress}`;
      const container = document.getElementById("orderDetails");
      container.innerHTML = "";
      let total = 0;
      if (orderData.details && orderData.details.length > 0) {
        orderData.details.forEach(detail => {
          const itemDiv = document.createElement("div");
          itemDiv.classList.add("order-item");
          itemDiv.innerHTML = `
            <p><strong>ä¸»é¤ï¼š</strong>${detail.foodName || "æœªæä¾›"}</p>
            <p><strong>æ•¸é‡ï¼š</strong>${detail.quantity ?? "-"}</p>
            <p><strong>ä½¿ç”¨é»æ•¸ï¼š</strong>${detail.pointsCost ?? "-"}</p>
            <p><strong>æˆç«‹æ™‚é–“ï¼š</strong>${formatDateTime(detail.createdTime) || "-"}</p>
            <p><strong>å‚™è¨»ï¼š</strong>${detail.note || "ç„¡"}</p>
          `;
          container.appendChild(itemDiv);
          total += (detail.pointsCost || 0);
        });
        document.getElementById("totalPoints").textContent = `ğŸ§¾ è¨‚å–®ç¸½é»æ•¸ï¼š${total} é»`;
      } else {
        container.innerHTML = "<p>âŒ æ‰¾ä¸åˆ°è¨‚å–®æ˜ç´°</p>";
      }
      function formatDateTime(timestamp) {
        const d = new Date(timestamp);
        return d.toLocaleString("zh-TW", { timeZone: "Asia/Taipei" });
      }
      waitForPickup();
    });

    function initMap() {
      const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};
      const defaultLocation = { lat: 25.0330, lng: 121.5654 };
      const storeLat = parseFloat(orderData.storeLat);
      const storeLng = parseFloat(orderData.storeLng);
      const hasCoords = !isNaN(storeLat) && !isNaN(storeLng);
      if (hasCoords) {
        renderMap({ lat: storeLat, lng: storeLng });
      } else {
        const geocoder = new google.maps.Geocoder();
        geocoder.geocode({ address: orderData.address }, (results, status) => {
          if (status === "OK" && results[0]) {
            const loc = results[0].geometry.location;
            renderMap({ lat: loc.lat(), lng: loc.lng() });
          } else {
            console.warn("âš ï¸ åœ°å€è½‰æ›å¤±æ•—ï¼Œä½¿ç”¨é è¨­ä½ç½®");
            renderMap(defaultLocation);
          }
        });
      }
    }

    function renderMap(location) {
      const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};
      const map = new google.maps.Map(document.getElementById("map"), {
        zoom: 16,
        center: location,
      });
      const marker = new google.maps.Marker({
        position: location,
        map: map,
      });
      const infoWindow = new google.maps.InfoWindow({
        content: `
          <div>
            <strong>${orderData?.storeName || 'åº—å®¶åç¨±'}</strong><br/>
            å–é¤è™Ÿç¢¼ï¼š${orderData?.pickupCode || '------'}<br/>
            å–é¤æ™‚é–“ï¼šåº—å®¶æ¥å–®å¾Œæœƒé€šçŸ¥æ‚¨
          </div>
        `
      });
      marker.addListener("click", () => infoWindow.open(map, marker));
      infoWindow.open(map, marker);
    }

    window.initMap = initMap;

    function waitForPickup() {
      const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};
      const orderId = orderData?.orderId;
      if (!orderId) return;
      fetch(`/meal/order/wait-pickup?orderId=${orderId}`)
        .then(res => res.json())
        .then(data => {
          if (data.pickedUp) {
            window.location.href = `/evaluate.html?orderId=${orderId}`;
          } else {
            setTimeout(waitForPickup, 1000);
          }
        })
        .catch(err => {
          console.error("âŒ ç„¡æ³•æŸ¥è©¢å–é¤ç‹€æ…‹", err);
          setTimeout(waitForPickup, 2000);
        });
    }
    
    
  </script>
  <!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>

<script>
  document.addEventListener("DOMContentLoaded", async () => {
    // ğŸ”” è«‹æ±‚é€šçŸ¥æ¬Šé™
    const permission = await Notification.requestPermission();
    if (permission !== "granted") {
      alert("âš ï¸ è«‹å…è¨±é€šçŸ¥åŠŸèƒ½ï¼Œæ‰èƒ½åœ¨é¤é»å®Œæˆæ™‚æ”¶åˆ°æé†’ï¼");
      return;
    }

    // âœ… åˆå§‹åŒ– Firebase
    firebase.initializeApp({
      apiKey: "AIzaSyA68z34B-2gMTza5XihaqtGUeNlKi3-pVU",
      authDomain: "allieat-notification.firebaseapp.com",
      projectId: "allieat-notification",
      messagingSenderId: "613984391786",
      appId: "1:613984391786:web:f5fc9510d0ef5f972d3013"
    });

    const messaging = firebase.messaging();

    // âœ… è¨»å†Š service worker ä¸¦å–å¾— token
    navigator.serviceWorker.register("/firebase-messaging-sw.js")
      .then(reg => {
        return messaging.getToken({
          vapidKey: "BMhduGYc_FYGv9W9jCouQGGJlIkDi71agZasPO1ufaui5qXbVIY35W4_MVmw1P3GlcV026ifk5sS1bOLQNDidUY",
          serviceWorkerRegistration: reg
        });
      })
      .then(token => {
        console.log("âœ… FCM token:", token);

        // âœ… å‚³ token åˆ°å¾Œç«¯ï¼Œé—œè¯è¨‚å–®è³‡è¨Š
        const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};
        const orderId = orderData?.orderId;
        if (token && orderId) {
          fetch("/api/fcm/register-token", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ token, orderId })
          });
        }
      })
      .catch(err => {
        console.error("âŒ ç„¡æ³•å–å¾— tokenï¼š", err);
      });

    // ğŸ”” è™•ç†å‰æ™¯æ¨æ’­è¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šå–é¤é€šçŸ¥ï¼‰
    messaging.onMessage(payload => {
      console.log("ğŸ“¨ å‰æ™¯æ¨æ’­è¨Šæ¯ï¼š", payload);
      alert(`ğŸ”” ${payload.notification.title}\n${payload.notification.body}`);
    });
  });
</script>
  
  <script async
    src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwk4bH6RdOWmqwmrpdYu7-NKZin0St0vQ&libraries=places&callback=initMap&region=TW&language=zh-TW">
  </script>
  
  <!-- Footer Start -->
<!-- Footer End -->
<div id="footer-container"></div>
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
<script src="/components/loader.js" defer></script>
<!-- JavaScript Libraries -->
  
</body>
</html>
