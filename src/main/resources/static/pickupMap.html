<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>å–é¤åœ°åœ– - ALLiEAT</title>
</head>
<body>
  <h1>ç­‰å¾…å–é¤é€šçŸ¥ä¸­...</h1>

  <!-- Firebase SDK -->
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.8.0/firebase-messaging-compat.js"></script>

  <script>
    document.addEventListener("DOMContentLoaded", async () => {
      console.log("ğŸš€ é é¢å·²è¼‰å…¥ï¼Œé–‹å§‹Firebaseåˆå§‹åŒ–");

      // ğŸ”” è«‹æ±‚é€šçŸ¥æ¬Šé™
      const permission = await Notification.requestPermission();
      console.log("ğŸ”” é€šçŸ¥æ¬Šé™ï¼š", permission);

      if (permission !== "granted") {
        alert("âš ï¸ è«‹å…è¨±é€šçŸ¥åŠŸèƒ½ï¼Œæ‰èƒ½åœ¨é¤é»å®Œæˆæ™‚æ”¶åˆ°æé†’ï¼");
        return;
      }

      // âœ… åˆå§‹åŒ– Firebase
      firebase.initializeApp({
        apiKey: "AIzaSyA68z34B-2gMTza5XihaqtGUeNlKi3-pVU",
        authDomain: "allieat-notification.firebaseapp.com",
        projectId: "allieat-notification",
        messagingSenderId: "613984391786",
        appId: "1:613984391786:web:f5fc9510d0ef5f972d3013"
      });

      const messaging = firebase.messaging();

      // âœ… è¨»å†Š service worker ä¸¦å–å¾— token
      navigator.serviceWorker.register("/firebase-messaging-sw.js")
        .then(reg => {
          console.log("âœ… Service Workerè¨»å†ŠæˆåŠŸ");
          return messaging.getToken({
            vapidKey: "BMhduGYc_FYGv9W9jCouQGGJlIkDi71agZasPO1ufaui5qXbVIY35W4_MVmw1P3GlcV026ifk5sS1bOLQNDidUY",
            serviceWorkerRegistration: reg
          });
        })
        .then(token => {
          console.log("âœ… æ‹¿åˆ°tokenï¼š", token);

          // âœ… å‚³ token åˆ°å¾Œç«¯ï¼Œé—œè¯è¨‚å–®è³‡è¨Š
          const orderData = JSON.parse(sessionStorage.getItem("orderSuccess")) || {};
          const orderId = orderData?.orderId;
          console.log("ğŸ“¦ orderIdï¼š", orderId);

          if (token && orderId) {
            fetch("/api/fcm/register-token", {
              method: "POST",
              headers: { "Content-Type": "application/json" },
              body: JSON.stringify({ token, orderId })
            })
            .then(response => {
              if (response.ok) {
                console.log("âœ… Tokenå·²æˆåŠŸé€åˆ°å¾Œç«¯");
              } else {
                console.error("âŒ Tokené€åˆ°å¾Œç«¯å¤±æ•—ï¼Œç‹€æ…‹ç¢¼ï¼š", response.status);
              }
            })
            .catch(err => {
              console.error("âŒ å‚³é€tokenåˆ°å¾Œç«¯æ™‚å‡ºéŒ¯ï¼š", err);
            });
          } else {
            console.error("âŒ token æˆ– orderId ä¸å­˜åœ¨ï¼Œç„¡æ³•å‚³é€");
          }
        })
        .catch(err => {
          console.error("âŒ ç„¡æ³•å–å¾— tokenï¼š", err);
        });

      // ğŸ”” è™•ç†å‰æ™¯æ¨æ’­è¨Šæ¯ï¼ˆä¾‹å¦‚ï¼šå–é¤é€šçŸ¥ï¼‰
      messaging.onMessage(payload => {
        console.log("ğŸ“¨ æ”¶åˆ°å‰æ™¯æ¨æ’­è¨Šæ¯ï¼š", payload);
        alert(`ğŸ”” ${payload.notification.title}\n${payload.notification.body}`);
      });
    });
  </script>
</body>
</html>