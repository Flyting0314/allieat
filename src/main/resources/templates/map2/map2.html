<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:replace="fragments/header :: header"></th:block>
<!-- 評分星星樣式 -->
<style>
/* 評分星星樣式 */
.stars-outer {
	display: inline-block;
	position: relative;
	font-family: 'Font Awesome 5 Free';
	font-weight: 900;
}

.stars-outer::before {
	content: "\f005 \f005 \f005 \f005 \f005";
	color: #ccc;
}

.stars-inner {
	position: absolute;
	top: 0;
	left: 0;
	white-space: nowrap;
	overflow: hidden;
	width: 0;
}

.stars-inner::before {
	content: "\f005 \f005 \f005 \f005 \f005";
	color: #f8ce0b;
}

/* 地圖信息視窗樣式 */
.gm-style .gm-style-iw {
	font-family: 'Roboto', sans-serif;
	padding: 15px;
}

.info-window {
	padding: 10px;
}

.info-window h3 {
	margin-top: 0;
	margin-bottom: 10px;
	color: #da9f5b;
}

.info-window div {
	margin-bottom: 5px;
}

/* 搜尋框焦點樣式 */
#search-input:focus {
	box-shadow: 0 0 0 0.2rem rgba(218, 159, 91, 0.25);
	border-color: #da9f5b;
}

.section-title::after {
	position: absolute;
	content: "";
	width: 100%;
	height: 0;
	top: 50%;
	left: 0;
	border-top: 2px dashed #bbb;
	z-index: -1;
}

.section-title {
	position: relative;
	display: inline-block;
	letter-spacing: 1px;
	color: #da9f5b;
	border-color: #da9f5b;
}

.section-title span {
	position: relative;
	background: #ffffff;
	padding: 0 10px;
}

/* 餐廳列表樣式 */
.restaurant-item {
	transition: all 0.2s ease;
	border-left: 3px solid transparent;
}

.restaurant-item:hover {
	border-left: 3px solid #da9f5b;
	background-color: rgba(218, 159, 91, 0.05);
}

.restaurant-category .badge {
	background-color: #da9f5b;
	font-weight: normal;
}

.location-item .badge {
	background-color: #da9f5b;
	font-weight: normal;
}

/* 搜尋結果區域樣式 */
.nearby-restaurants {
	max-height: 500px;
	overflow-y: auto;
	padding-right: 5px;
}

.nearby-restaurants::-webkit-scrollbar {
	width: 5px;
}

.nearby-restaurants::-webkit-scrollbar-track {
	background: #f1f1f1;
	border-radius: 10px;
}

.nearby-restaurants::-webkit-scrollbar-thumb {
	background: #da9f5b;
	border-radius: 10px;
}

.nearby-restaurants::-webkit-scrollbar-thumb:hover {
	background: #c28a4a;
}

/* 餐廳標籤樣式 */
.restaurant-tags {
	margin-top: 5px;
}

.restaurant-tags .tag {
	display: inline-block;
	padding: 2px 8px;
	margin-right: 5px;
	font-size: 0.7rem;
	border-radius: 10px;
	background-color: rgba(218, 159, 91, 0.2);
	color: #8b5a2b;
}

/* 載入動畫 */
.loading-spinner {
	display: inline-block;
	width: 1rem;
	height: 1rem;
	border: 2px solid rgba(218, 159, 91, 0.2);
	border-radius: 50%;
	border-top-color: #da9f5b;
	animation: spin 1s ease-in-out infinite;
}

@keyframes spin {to { transform:rotate(360deg);
	
}

}

/* 餐廳詳情視窗樣式 */
.restaurant-detail-modal .modal-header {
	background-color: #da9f5b;
	color: white;
}

.restaurant-detail-modal .close {
	color: white;
	opacity: 0.8;
}

.restaurant-detail-modal .close:hover {
	opacity: 1;
}

.restaurant-detail-modal .restaurant-amenities i {
	color: #da9f5b;
	margin-right: 5px;
}

/* 餐廳詳情視窗底部按鈕樣式 */
.restaurant-detail-modal .modal-footer .btn-primary {
	background-color: #da9f5b;
	border-color: #da9f5b;
}

.restaurant-detail-modal .modal-footer .btn-primary:hover {
	background-color: #c28a4a;
	border-color: #c28a4a;
}

/* 返回按鈕樣式 */
.back-to-restaurants {
	position: absolute;
	top: 10px;
	left: 10px;
	z-index: 1000;
	background-color: rgba(255, 255, 255, 0.9);
	border: 1px solid #da9f5b;
	color: #da9f5b;
	padding: 5px 12px;
	border-radius: 4px;
	font-size: 0.9rem;
	display: none;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.back-to-restaurants:hover {
	background-color: #da9f5b;
	color: white;
}

/* 路線指引列表樣式 */
.route-steps ol {
	padding-left: 20px;
	margin-top: 5px;
}

.route-steps li {
	margin-bottom: 8px;
	font-size: 0.9rem;
}

#autocomplete-suggestions {
	max-height: 250px;
	overflow-y: auto;
	border-radius: 0 0 10px 10px;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#autocomplete-suggestions li {
	padding: 10px 15px;
	border-bottom: 1px solid #f1f1f1;
}

#autocomplete-suggestions li:hover {
	background-color: #f8f9fa;
	cursor: pointer;
	border-left: 3px solid #da9f5b;
}

#autocomplete-suggestions li:last-child {
	border-bottom: none;
	border-radius: 0 0 10px 10px;
}

.pac-container {
	display: none !important;
}
</style>
</head>

<body>
<th:block th:replace="fragments/bodySection :: bodySection"></th:block>

	<!-- Hero Section End -->

	<!-- 美化後的地圖區域 -->
	<div class="container-fluid py-5 bg-light">
		<div class="container">
			<div class="row mb-4">
				<div class="col-12 text-center">
					<h2 class="section-title text-uppercase mb-2">
						<span>尋找愛心餐廳</span>
					</h2>
					<p class="text-muted">搜尋您附近的愛心代用餐合作餐廳</p>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 mb-4">
					<div class="card shadow-sm h-100">
						<div class="card-body">
							<h4 class="mb-3">搜尋餐廳</h4>
							<div class="input-group mb-4 position-relative"
								style="width: 100%;">
								<input id="search-input" class="form-control"
									placeholder="輸入地點、地址或餐廳名稱..."
									style="border-radius: 50px 0 0 50px; padding: 12px 20px; font-size: 1rem; height: 48px; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);">
								<div class="input-group-append">
									<button class="btn btn-primary"
										style="border-radius: 0 50px 50px 0; padding: 0 20px; font-size: 1rem; height: 48px;">
										<i class="fas fa-search"></i>
									</button>
								</div>


								<!-- 🔽 自動完成提示 -->
								<ul id="autocomplete-suggestions"
									class="list-group position-absolute w-100"
									style="z-index: 1000; top: 100%; left: 0; display: none;"></ul>
							</div>

							<div id="restaurant-info" class="mt-4 d-none">
								<h5 class="restaurant-name font-weight-bold"></h5>
								<div class="restaurant-rating mb-2">
									<div class="stars-outer">
										<div class="stars-inner"></div>
									</div>
									<span class="rating-value ml-2"></span>
								</div>
								<p class="restaurant-address mb-1">
									<i class="fas fa-map-marker-alt mr-2 text-primary"></i> <span></span>
								</p>
								<p class="restaurant-phone mb-1">
									<i class="fas fa-phone mr-2 text-primary"></i> <span></span>
								</p>
								<p class="walking-time mb-3">
									<i class="fas fa-walking mr-2 text-primary"></i> <span></span>
								</p>
								<!-- 前往導航：地圖導航 -->
								<button class="btn btn-primary btn-block mt-3"
									onclick="showRouteInMap(selectRestaurant.location, selectRestaurant.name)">
									<i class="fas fa-route mr-1"></i>前往導航
								</button>

								<!-- 前往點餐：跳轉到點餐頁 -->
								<button type="button" class="btn btn-success btn-block mt-2"
									onclick="goToRestaurantPage(selectRestaurant.id || selectRestaurant.storeId, selectRestaurant.name)">
									<i class="fas fa-utensils mr-1"></i>前往點餐
								</button>


							</div>

							<!-- ✅ 保留：愛心餐合作s列表 -->
							<div class="nearby-restaurants mt-4">
								<h5>附近愛心合作餐廳</h5>
								<div class="list-group mt-3 restaurants-list">
									<!-- 餐廳列表會由JS動態生成 -->
								</div>
							</div>



						</div>
					</div>
				</div>

				<div class="col-md-8 mb-4">
					<div class="card shadow-sm h-100">
						<div class="card-body p-0">
							<div id="map"
								style="width: 100%; height: 700px; border-radius: 5px;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- 餐廳詳情模態視窗 -->
	<div class="modal fade restaurant-detail-modal"
		id="restaurantDetailModal" tabindex="-1" role="dialog"
		aria-labelledby="restaurantDetailModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="restaurantDetailModalLabel">餐廳詳情</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<img id="restaurant-photo" class="img-fluid rounded" alt="餐廳封面" style="display: none;" />

						</div>
						<div class="col-md-6">
							<h4 class="restaurant-name"></h4>
							<div class="restaurant-rating mb-2">
								<div class="stars-outer">
									<div class="stars-inner"></div>
								</div>
								<span class="rating-value ml-2"></span>
							</div>
							<p class="restaurant-address mb-1">
								<i class="fas fa-map-marker-alt mr-2 text-primary"></i> <span></span>
							</p>
							<p class="restaurant-phone mb-1">
								<i class="fas fa-phone mr-2 text-primary"></i> <span></span>
							</p>
							<p class="restaurant-category mb-1">
								<i class="fas fa-utensils mr-2 text-primary"></i> <span></span>
							</p>
							<div class="restaurant-tags mt-2">
								<!-- 標籤會在這裡動態生成 -->
							</div>
						</div>
					</div>

					<hr>

					<div class="row mt-3">
						<div class="col-12">
							<h5>愛心代用餐訊息</h5>
							<p>本餐廳是「攏呷霸 ALLiEAT」愛心代用餐合作夥伴，您可以在此處：</p>
							<ul>
								<li>捐贈愛心餐點給有需要的人</li>
								<li>若您有愛心代用餐券，可在此兌換餐點</li>
							</ul>
						</div>
					</div>

					<div class="row mt-3">
						<div class="col-12">
							<h5>餐廳設施</h5>
							<div class="restaurant-amenities row">
								<div class="col-md-4 mb-2">
									<i class="fas fa-wifi"></i> 免費WiFi
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-parking"></i> 停車場
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-wheelchair"></i> 無障礙設施
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-baby"></i> 兒童座椅
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-credit-card"></i> 刷卡服務
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-dog"></i> 寵物友善
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">關閉</button>
					<button type="button" class="btn btn-primary btn-restaurant">前往點餐</button>
					<button type="button" class="btn btn-primary btn-navigation">前往導航</button>
					<!-- <button onclick="debugStore()">調試餐廳數據</button> -->
				</div>
			</div>
		</div>
	</div>

	<!-- Footer Start -->
	<th:block th:replace="fragments/footer :: footer"></th:block>

	<!-- Back to Top -->
	<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i
		class="fa fa-angle-double-up"></i></a>

	<!-- 將後端的 storeList 傳到前端變成 JS 變數 -->
	<script th:inline="javascript">
    /*<![CDATA[*/
    const stores = /*[[${storeList}]]*/ [];
    /*]]>*/
</script>

	<!-- JavaScript Libraries -->
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
	<script src="lib/easing/easing.min.js"></script>
	<script src="lib/waypoints/waypoints.min.js"></script>
	<script src="lib/owlcarousel/owl.carousel.min.js"></script>
	<script src="lib/tempusdominus/js/moment.min.js"></script>
	<script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
	<script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

	<!-- 地圖相關腳本 -->
	<script>
    // 整合地圖JavaScript
    let map;
    let currentPosition;
    let selectRestaurant;
    let marker;
    let autocomplete;
    let directionsService;
    let directionsRenderer;
    let infowindow;
    let markers = []; // 存儲所有標記
    let userMarker; // 用戶位置標記
    let tempSearchMarker = null;  // 使用者搜尋位置的紅點
    let tempRouteMarker = null;   // 導航目的地的橘點

    
  
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 25.033, lng: 121.565 },
            zoom: 14,
            styles: [/* 地圖樣式略 */],
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            zoomControl: true
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: '#da9f5b',
                strokeWeight: 5,
                strokeOpacity: 0.7
            }
        });

        infowindow = new google.maps.InfoWindow({
            maxWidth: 300,
            pixelOffset: new google.maps.Size(0, -30)
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // ✅ 標記使用者位置
                userMarker = new google.maps.Marker({
                    position: currentPosition,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeColor: "white",
                        strokeWeight: 2
                    },
                    title: "您的位置",
                    zIndex: 999
                });

                map.setCenter(currentPosition);

                // ✅ 初始化 autocomplete
                autocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('search-input'),
                    {
                        types: ['restaurant', 'food'],
                        componentRestrictions: { country: 'tw' }
                    }
                );
                autocomplete.addListener('place_changed', onPlaceChanged);

                // ✅ 等 currentPosition 有值再呼叫這兩個
                addRestaurantMarkers();
                addRestaurantsList();

            }, function () {
                handleLocationError(true, map.getCenter());
            });
        } else {
            handleLocationError(false, map.getCenter());
        }
    }


    function handleLocationError(browserHasGeolocation, pos) {
        alert(browserHasGeolocation
            ? '無法取得您的位置。請確認位置權限已開啟。'
            : '您的瀏覽器不支援定位功能。');

        currentPosition = { lat: 25.047924, lng: 121.517081 }; // 台北車站 fallback
        map.setCenter(currentPosition);

        autocomplete = new google.maps.places.Autocomplete(
            document.getElementById('search-input')
        );
        autocomplete.addListener('place_changed', onPlaceChanged);

        // ✅ 也要補上這兩行
        addRestaurantMarkers();
        addRestaurantsList();
    }

    function onPlaceChanged() {
        const place = autocomplete.getPlace();
        
        if (!place.geometry || !place.geometry.location) {
            alert("找不到該地點的詳細資訊，請選擇搜尋結果中的餐廳。");
            return;
        }
        
        selectRestaurant = {
            location: {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            },
            placeId: place.place_id,
            name: place.name,
            address: place.formatted_address || "無地址資訊",
            phoneNumber: place.formatted_phone_number || "無電話資訊",
            rating: place.rating || "尚未評分"
        };
        
        // 更新地圖
        map.setCenter(selectRestaurant.location);
        map.setZoom(17);
        
        // 更新標記
        if (tempSearchMarker) tempSearchMarker.setMap(null);
tempSearchMarker = new google.maps.Marker({
    map: map,
    position: selectRestaurant.location,
    animation: google.maps.Animation.DROP,
    icon: {
        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
        scaledSize: new google.maps.Size(40, 40)
    },
    title: selectRestaurant.name
});
        
        // 更新側邊欄資訊
        updateRestaurantInfo(selectRestaurant);
        
        // 顯示信息窗口
        const content = `
            <div class="info-window">
                <h3>${selectRestaurant.name}</h3>
                <div><strong>地址：</strong>${selectRestaurant.address}</div>
                <div><strong>電話：</strong>${selectRestaurant.phoneNumber}</div>
                <div><strong>評分：</strong>${selectRestaurant.rating} / 5</div>
                <div class="mt-2 text-center">
                    <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap(${selectRestaurant.location.lat}, ${selectRestaurant.location.lng}, '${selectRestaurant.name}')">
                        <i class="fas fa-route mr-1"></i>顯示路線
                    </button>
                </div>
            </div>
        `;
        
        infowindow.setContent(content);
        infowindow.open(map, marker);
    }

    function updateRestaurantInfo(restaurant) {
        const infoDiv = document.getElementById('restaurant-info');
        infoDiv.classList.remove('d-none');
        
        // 更新餐廳名稱
        infoDiv.querySelector('.restaurant-name').textContent = restaurant.name;
        
        // 更新評分星星
        const starsInner = infoDiv.querySelector('.stars-inner');
        const starPercentage = (restaurant.rating / 5) * 100;
        starsInner.style.width = `${starPercentage}%`;
        infoDiv.querySelector('.rating-value').textContent = `${restaurant.rating} / 5`;
        
        // 更新地址與電話
        infoDiv.querySelector('.restaurant-address span').textContent = restaurant.address;
        infoDiv.querySelector('.restaurant-phone span').textContent = restaurant.phoneNumber || restaurant.phone;
        
        // 更新步行時間
        if (restaurant.duration) {
            infoDiv.querySelector('.walking-time span').textContent = restaurant.duration;
        } else {
            infoDiv.querySelector('.walking-time span').textContent = "計算中...";
            // 計算步行時間
            if (currentPosition && restaurant.location) {
                directionsService.route({
                    origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
                    destination: new google.maps.LatLng(restaurant.location.lat, restaurant.location.lng),
                    travelMode: 'WALKING'
                }, function(response, status) {
                    if (status === 'OK') {
                        const leg = response.routes[0].legs[0];
                        infoDiv.querySelector('.walking-time span').textContent = leg.duration.text;
                        restaurant.duration = leg.duration.text;
                    }
                });
            }
        }
        
        // 更新導航按鈕事件 - 在地圖上顯示路線
        const navButton = infoDiv.querySelector('.btn-primary');
        navButton.onclick = function() {
            if (restaurant.location) {
                showRouteInMap(restaurant.location, restaurant.name);
            }
        };
    }

    // 添加餐廳標記 - 使用從 Thymeleaf 獲取的數據
    function addRestaurantMarkers() {
        // 清除現有標記
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        
        // 使用後端提供的餐廳數據
        if (typeof stores !== 'undefined' && stores.length > 0) {
            stores.forEach((store, index) => {
                // 將後端數據轉換為地圖所需格式
                const storeLocation = { 
                    lat: store.latitude,
                    lng: store.longitude
                };
                
                const marker = new google.maps.Marker({
                    position: storeLocation,
                    map: map,
                    title: store.name,
                    animation: google.maps.Animation.DROP,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                        scaledSize: new google.maps.Size(36, 36)
                    },
                    label: {
                        text: store.name,
                        color: '#000',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    storeId: store.storeId || index  // 改為使用storeId
                });
                
                markers.push(marker);
                
       
             // 點擊標記時顯示信息
                marker.addListener('click', function() {
                    selectRestaurant = {
                        name: store.name,
                        address: store.address,
                        phoneNumber: store.phone,
                        rating: store.rating || 4.5,
                        location: storeLocation,
                        id: store.storeId || store.id, // 確保使用正確的 ID
                        category: store.category || '餐飲',
                        tags: store.tags || ['愛心合作店']
                    };
                    
                    // 直接顯示模態視窗，而不是在地圖上顯示信息窗口
                    showRestaurantModal(store);
                });
                    
                    
                    //測試用======================
                    function debugRestaurant(btn, id, name) {
                    console.log('準備跳轉,餐廳ID:', id, '餐廳名稱:', name);
                    console.log('按鈕元素:', btn);
                    console.log('找到相應店家:', stores.find(s => s.name === name));
                    
                    // 延遲跳轉，以便查看調試信息
                    setTimeout(() => {
                        goToRestaurantPage(id, name);
                    }, 3000);
                }
             });
         }
    } 
    

    function handlePlacesResult(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
            const place = results[0];
            
            selectRestaurant = {
                location: {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng()
                },
                placeId: place.place_id,
                name: place.name,
                address: place.formatted_address || "無地址資訊",
                phoneNumber: "02-XXXX-XXXX", // la4模擬電話
                rating: place.rating || "尚未評分"
            };
            
            // 更新地圖
            map.setCenter(selectRestaurant.location);
            map.setZoom(17);
            
            // 更新標記
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({
                map: map,
                position: selectRestaurant.location,
                animation: google.maps.Animation.DROP
            });
            
            // 更新側邊欄資訊
            updateRestaurantInfo(selectRestaurant);
            
            // 創建信息窗口
            const infoContent = `
                <div class="info-window">
                    <h3>${selectRestaurant.name}</h3>
                    <div><strong>地址：</strong>${selectRestaurant.address}</div>
                    <div><strong>電話：</strong>${selectRestaurant.phoneNumber}</div>
                    <div><strong>評分：</strong>${selectRestaurant.rating} / 5</div>
                    <div class="mt-2 text-center">
                        <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap({lat: ${selectRestaurant.location.lat}, lng: ${selectRestaurant.location.lng}}, '${selectRestaurant.name}')">
                            <i class="fas fa-route mr-1"></i>顯示路線
                        </button>
                    </div>
                </div>
            `;
            
            infowindow.setContent(infoContent);
            infowindow.open(map, marker);
        } else {
            alert("找不到相關餐廳");
        }
    }
    
    // 更新側邊欄
    function updateSidebar() {
        // 先添加餐廳列表區域 (修改順序)
        addRestaurantsList();
        
       
    }

    // 更新熱門地點區域
    function updatePopularLocations() {
        const popularLocations = restaurantApi.getPopularLocations();
        const locationContainer = document.querySelector('.location-tips .list-group');
        
        // 清除現有項目
        locationContainer.innerHTML = '';
        
        // 添加新項目
        popularLocations.forEach(location => {
            const locationItem = document.createElement('a');
            locationItem.href = '#';
            locationItem.className = 'list-group-item list-group-item-action location-item';
            locationItem.setAttribute('data-name', location.name);
            locationItem.innerHTML = `
                <i class="fas fa-utensils mr-2 text-primary"></i>
                ${location.name} <span class="badge badge-pill badge-primary">${location.count}</span>
            `;
            
            // 添加點擊事件監聽器
            locationItem.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('search-input').value = this.getAttribute('data-name');
                
                // 觸發搜尋
                const service = new google.maps.places.PlacesService(map);
                service.textSearch({
                    query: this.getAttribute('data-name') + " 餐廳",
                    location: currentPosition,
                    radius: 5000
                }, handlePlacesResult);
            });
            
            locationContainer.appendChild(locationItem);
        });
    }

    // 添加餐廳列表區域
    
  // ✅ 確保 getDistance 回傳的是公里數（不是公尺），並加強檢查 currentPosition 是否正確
function getDistance(lat1, lng1, lat2, lng2) {
    if (!lat1 || !lng1 || !lat2 || !lng2) return 0;
    function toRad(x) {
        return x * Math.PI / 180;
    }
    const R = 6371; // 地球半徑 (公里)
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function addRestaurantsList() {
    const restaurantsList = document.querySelector('.restaurants-list');
    restaurantsList.innerHTML = '';

    if (!currentPosition || !currentPosition.lat || !currentPosition.lng) {
        console.warn('尚未取得使用者位置');
        restaurantsList.innerHTML = '<p class="text-center">尚未取得使用者位置</p>';
        return;
    }

    const geocoder = new google.maps.Geocoder();

    if (typeof stores !== 'undefined' && stores.length > 0) {
        stores.forEach((store, index) => {
            const restaurantItem = document.createElement('a');
            restaurantItem.href = '#';
            restaurantItem.className = 'list-group-item list-group-item-action restaurant-item';
            restaurantItem.setAttribute('data-id', store.storeId);

            const tags = store.tags || ['愛心合作店'];
            const tagHtml = tags.map(tag => `<small class="badge badge-info ml-1">${tag}</small>`).join('');

            // 預設距離文字
            let distanceText = '距離未知';

            const renderRestaurantItem = (distance) => {
                distanceText = distance < 1 ? `${Math.round(distance * 1000)} 公尺` : `${distance.toFixed(1)} 公里`;

                restaurantItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${store.name}</h6>
                        <small>${distanceText}</small>
                    </div>
                    <div class="restaurant-category mb-1">
                        <small class="text-muted">${store.category || '餐飲'}</small>
                        ${tagHtml}
                    </div>
                    <small class="d-block">
                        <div class="stars-outer d-inline-block" style="font-size: 0.8rem;">
                            <div class="stars-inner" style="width: ${((store.rating || 4.5) / 5) * 100}%"></div>
                        </div>
                        <span class="rating-value ml-1">${store.rating || 4.5}</span>
                    </small>
                `;

                restaurantItem.addEventListener('click', function (e) {
                    e.preventDefault();
                    const storeId = $(this).data('id');
                    const storeData = stores.find(s => s.storeId == storeId || s.id == storeId);
                    if (storeData) showRestaurantModal(storeData);
                });

                restaurantsList.appendChild(restaurantItem);
            };

            // ✅ 有經緯度就先轉為數字再處理
            const lat = parseFloat(store.latitude);
            const lng = parseFloat(store.longitude);

            if (!isNaN(lat) && !isNaN(lng)) {
                const dist = getDistance(currentPosition.lat, currentPosition.lng, lat, lng);
                renderRestaurantItem(dist);
            } else if (store.address) {
                // ❗沒有經緯度就用地址反查
                geocoder.geocode({ address: store.address }, function (results, status) {
                    if (status === 'OK' && results[0] && results[0].geometry) {
                        const loc = results[0].geometry.location;
                        const lat = loc.lat();
                        const lng = loc.lng();

                        store.latitude = lat;
                        store.longitude = lng;

                        const dist = getDistance(currentPosition.lat, currentPosition.lng, lat, lng);
                        renderRestaurantItem(dist);
                    } else {
                        console.warn('地址轉經緯度失敗', store.address, status);
                        renderRestaurantItem(NaN);
                    }
                });
            } else {
                // 沒經緯度也沒地址，無法計算
                renderRestaurantItem(NaN);
            }
        });
    } else {
        restaurantsList.innerHTML = '<p class="text-center">沒有可用的餐廳資料</p>';
    }
}

//測試用========================
function debugStore() {
    console.log('所有餐廳數據:', stores);
    if(stores.length > 0) {
        console.log('第一個餐廳結構:', stores[0]);
        console.log('餐廳ID屬性:', stores[0].storeId, stores[0].id);
    }
    return false; // 阻止頁面跳轉
}

// 跳轉到餐廳詳情頁面
function goToRestaurantPage(storeId, name) {
    console.log('跳轉到餐廳頁面, ID:', storeId, '名稱:', name);
    
    // 確保 storeId 是數字
    storeId = parseInt(storeId, 10);
    
    if (isNaN(storeId) || storeId <= 0) {
        console.error('無效的餐廳ID');
        alert('找不到餐廳，請重新選擇');
        return;
    }
    
    // 如果名稱是編碼過的，先解碼
    name = decodeURIComponent(name);
    
    // 跳轉到餐廳點餐頁面
    const url = `/orderfood?id=${storeId}&name=${encodeURIComponent(name)}`;
    console.log('即將跳轉到:', url);
    window.location.href = url;
}

// 餐廳詳情模態視窗
function showRestaurantModal(restaurant) {
    const modal = $('#restaurantDetailModal');

    // ✅ 補強 storeId，如果是 store.id 傳進來的話
    if (!restaurant.storeId && restaurant.id) {
        restaurant.storeId = restaurant.id;
    }

    // ✅ 設定圖片顯示
    const photoImg = document.getElementById("restaurant-photo");
    const imgUrl = `/meal/photo/${restaurant.storeId}/cover`;
    const testImg = new Image();

    testImg.onload = function () {
        photoImg.src = imgUrl;
        photoImg.style.display = "block";
    };
    testImg.onerror = function () {
        console.warn("載入圖片失敗，改用預設圖：", imgUrl);
        photoImg.src = "/img/default-restaurant.png"; // ✅ 使用預設圖
        photoImg.style.display = "block";
    };
    testImg.src = imgUrl;

    // ✅ 設定餐廳資訊
    modal.find('.restaurant-name').text(restaurant.name);
    modal.find('.restaurant-address span').text(restaurant.address || "地址未知");
    modal.find('.restaurant-phone span').text(restaurant.phone || restaurant.phoneNumber || "無電話資訊");
    modal.find('.restaurant-category span').text(restaurant.category || '一般餐飲');

    // ✅ 星星評分
    const starsInner = modal.find('.stars-inner');
    const rating = parseFloat(restaurant.rating || 4.5);
    const starPercentage = (rating / 5) * 100;
    starsInner.css('width', `${starPercentage}%`);
    modal.find('.rating-value').text(`${rating.toFixed(1)} / 5`);

    // ✅ 標籤渲染
    const tagsContainer = modal.find('.restaurant-tags');
    tagsContainer.empty();
    const tags = restaurant.tags || ['愛心合作店'];
    tags.forEach(tag => {
        tagsContainer.append(`<span class="badge badge-info mr-1">${tag}</span>`);
    });

    // ✅ 前往點餐按鈕
    modal.find('.btn-restaurant').off('click').on('click', function () {
        modal.modal('hide');
        goToRestaurantPage(restaurant.storeId, restaurant.name);
    });

    // ✅ 前往導航按鈕
    modal.find('.btn-navigation').off('click').on('click', function () {
        modal.modal('hide');
        if (restaurant.latitude && restaurant.longitude) {
            showRouteInMap({
                lat: parseFloat(restaurant.latitude),
                lng: parseFloat(restaurant.longitude)
            }, restaurant.name);
        } else if (restaurant.location) {
            showRouteInMap(restaurant.location, restaurant.name);
        } else {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: restaurant.address }, function (results, status) {
                if (status === 'OK' && results[0]?.geometry) {
                    const loc = results[0].geometry.location;
                    showRouteInMap({ lat: loc.lat(), lng: loc.lng() }, restaurant.name);
                } else {
                    alert('無法解析地址：' + restaurant.address);
                }
            });
        }
    });

    // ✅ 顯示模態視窗
    modal.modal('show');
}

    // 格式化路線指引文字
    function formatInstructions(instruction) {
        // 移除HTML標籤但保留文字
        const div = document.createElement('div');
        div.innerHTML = instruction;
        let text = div.textContent || div.innerText || '';
        
        // 如果有距離資訊，保留距離但簡化格式
        const distanceMatch = instruction.match(/(\d+)\s*(公尺|米|m|km|公里)/i);
        if (distanceMatch) {
            const distance = distanceMatch[0];
            text = text.replace(/向(東|南|西|北|東北|東南|西南|西北)走/, '向$1走 ' + distance);
        }
        
        // 簡化常見指引
        text = text.replace('繼續直行', '直行')
               .replace('輕微向右轉', '稍微右轉')
               .replace('輕微向左轉', '稍微左轉')
               .replace('目的地在', '到達');
        
        return text;
    }

    // 在地圖上顯示路線導航
    function showRouteInMap(destination, destinationName) {
        // 檢查是否有用戶位置
        if (!currentPosition) {
            alert('請先允許獲取您的位置，以便規劃路線');
            return;
        }
        
        // 顯示返回按鈕
        const backButton = document.getElementById('back-to-restaurants');
        if (backButton) {
            backButton.style.display = 'block';
        } else {
            // 創建返回按鈕
            const btn = document.createElement('button');
            btn.id = 'back-to-restaurants';
            btn.className = 'back-to-restaurants';
            btn.innerHTML = '<i class="fas fa-arrow-left mr-2"></i>返回餐廳列表';
            btn.onclick = function() {
                // 清除路線
                directionsRenderer.set('directions', null);
                
                // 隱藏返回按鈕
                this.style.display = 'none';
                
                // 重新顯示所有餐廳標記
                markers.forEach(marker => marker.setVisible(true));
                
                // 關閉信息窗口
                infowindow.close();
                
                // 顯示所有餐廳
                showAllRestaurants();
            };
            document.getElementById('map').parentNode.appendChild(btn);
        }
        
        // 隱藏所有餐廳標記
        markers.forEach(marker => marker.setVisible(false));
        
        // 規劃路線
        directionsService.route({
            origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
            destination: new google.maps.LatLng(destination.lat, destination.lng),
            travelMode: 'WALKING',
            provideRouteAlternatives: false,
            avoidHighways: true,
            avoidTolls: true
        }, function(response, status) {
            if (status === 'OK') {
                // 設置路線渲染器選項
                directionsRenderer.setOptions({
                    directions: response,
                    suppressMarkers: true, // 隱藏默認標記
                    polylineOptions: {
                        strokeColor: '#da9f5b',
                        strokeWeight: 5,
                        strokeOpacity: 0.7
                    }
                });
                
                // 獲取路線詳情
                const leg = response.routes[0].legs[0];
                
                // 格式化路線指引步驟
                const formattedSteps = leg.steps.map(step => {
                    return `<li>${formatInstructions(step.instructions)}</li>`;
                }).join('');
                
                // 創建路線詳情信息窗口
                const routeInfo = `
                    <div class="info-window">
                        <h3>前往 ${destinationName}</h3>
                        <div><strong><i class="fas fa-map-marker-alt mr-2 text-primary"></i>起點：</strong>${leg.start_address}</div>
                        <div><strong><i class="fas fa-flag-checkered mr-2 text-danger"></i>終點：</strong>${leg.end_address}</div>
                        <div><strong><i class="fas fa-route mr-2 text-success"></i>距離：</strong>${leg.distance.text}</div>
                        <div><strong><i class="fas fa-walking mr-2 text-info"></i>步行時間：</strong>${leg.duration.text}</div>
                        <div class="route-steps mt-2">
                            <strong><i class="fas fa-directions mr-2"></i>路線指引：</strong>
                            <ol class="mt-1">
                                ${formattedSteps}
                            </ol>
                        </div>
                    </div>
                `;
                
                // 顯示路線詳情
                infowindow.setContent(routeInfo);
                infowindow.setPosition(destination);
                infowindow.open(map);
                
                // 更新地圖視角以顯示整條路線
                const bounds = new google.maps.LatLngBounds();
                const path = response.routes[0].overview_path;
                path.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
                
                // 添加起點和終點標記
                // 起點已有用戶位置標記
                // 添加終點標記
             // 添加終點標記（改為區域變數）
                const destinationMarker = new google.maps.Marker({
                    position: new google.maps.LatLng(destination.lat, destination.lng),
                    map: map,
                    title: destinationName,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    zIndex: 900
                });

            } else {
                alert('無法規劃路線：' + status);
                
                // 重新顯示所有餐廳標記
                markers.forEach(marker => marker.setVisible(true));
                
                // 隱藏返回按鈕
                document.getElementById('back-to-restaurants').style.display = 'none';
            }
        });
    }

    // 顯示所有餐廳
    function showAllRestaurants() {
        if (markers.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            
            markers.forEach(marker => {
                marker.setVisible(true);
                bounds.extend(marker.getPosition());
            });
            
            map.fitBounds(bounds);
        }
    }

    // 模糊搜索函數 - 在stores數組中搜尋符合條件的餐廳
    function fuzzySearchRestaurants(searchText) {
        if (!stores || !stores.length) {
            return [];
        }
        
        // 將搜尋文字轉小寫以進行不區分大小寫的比對
        const searchLower = searchText.toLowerCase();
        
        // 篩選符合條件的餐廳
        return stores.filter(store => {
            // 檢查餐廳名稱
            if (store.name && store.name.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // 檢查地址
            if (store.address && store.address.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // 檢查類別
            if (store.category && store.category.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // 檢查標籤
            if (store.tags && Array.isArray(store.tags)) {
                return store.tags.some(tag => tag.toLowerCase().includes(searchLower));
            }
            
            return false;
        });
    }

    // 顯示搜尋結果函數
   function displaySearchResults(results) {
    markers.forEach(marker => marker.setMap(null));
    markers = [];

    if (results.length === 0) {
        alert('沒有找到符合條件的餐廳');
        addRestaurantMarkers();
        return;
    }

    const restaurantsList = document.querySelector('.restaurants-list');
    restaurantsList.innerHTML = '';

    const bounds = new google.maps.LatLngBounds();

    results.forEach((store, index) => {
        const storeLocation = {
            lat: parseFloat(store.latitude),
            lng: parseFloat(store.longitude)
        };

        bounds.extend(new google.maps.LatLng(storeLocation.lat, storeLocation.lng));

        const marker = new google.maps.Marker({
            position: storeLocation,
            map: map,
            title: store.name,
            animation: google.maps.Animation.DROP,
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                scaledSize: new google.maps.Size(36, 36)
            },
            label: {
                text: store.name,
                color: '#000',
                fontSize: '12px',
                fontWeight: 'bold'
            },
            storeId: store.storeId || index
        });

        markers.push(marker);

        marker.addListener('click', function () {
            selectRestaurant = {
                name: store.name,
                address: store.address,
                phoneNumber: store.phone,
                rating: store.rating || 4.5,
                location: storeLocation,
                id: store.storeId || store.id,
                category: store.category || '餐飲',
                tags: store.tags || ['愛心合作店']
            };

            showRestaurantModal(store);
        });

        // ✅ 計算距離
        let distanceDisplay = '無法取得距離';
        if (currentPosition && store.latitude && store.longitude) {
            const distance = getDistance(currentPosition.lat, currentPosition.lng, store.latitude, store.longitude);
            if (distance < 1000) {
                distanceDisplay = `${Math.round(distance)} 公尺`;
            } else {
                distanceDisplay = `${(distance / 1000).toFixed(1)} 公里`;
            }
        }

        const tags = store.tags || ['愛心合作店'];
        const tagHtml = tags.map(tag => `<small class="badge badge-info ml-1">${tag}</small>`).join('');

        const restaurantItem = document.createElement('a');
        restaurantItem.href = '#';
        restaurantItem.className = 'list-group-item list-group-item-action restaurant-item';
        restaurantItem.setAttribute('data-id', store.storeId);

        restaurantItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${store.name}</h6>
                <small>${distanceDisplay}</small>
            </div>
            <div class="restaurant-category mb-1">
                <small class="text-muted">${store.category || '餐飲'}</small>
                ${tagHtml}
            </div>
            <small class="d-block">
                <div class="stars-outer d-inline-block" style="font-size: 0.8rem;">
                    <div class="stars-inner" style="width: ${((store.rating || 4.5) / 5) * 100}%"></div>
                </div>
                <span class="rating-value ml-1">${store.rating || 4.5}</span>
            </small>
        `;

        restaurantItem.addEventListener('click', function (e) {
            e.preventDefault();
            const marker = markers.find(m => m.storeId == store.id);
            if (marker) {
                google.maps.event.trigger(marker, 'click');
                map.setCenter(marker.getPosition());
                map.setZoom(16);
            } else {
                showRestaurantModal(store);
            }
        });

        restaurantsList.appendChild(restaurantItem);
    });

    if (markers.length > 0) {
        map.fitBounds(bounds);
        if (markers.length === 1) {
            google.maps.event.addListenerOnce(map, 'bounds_changed', function () {
                map.setZoom(16);
            });
        }
    }
}

    
    </script>

	<!-- Google Maps API -->
	<script async
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwk4bH6RdOWmqwmrpdYu7-NKZin0St0vQ&libraries=places&callback=initMap&region=TW&language=zh-TW">
    </script>

	<!-- 初始化功能 -->


	<script>
//當頁面完全載入後執行
$(document).ready(function() {
    // 修改搜尋按鈕點擊事件 - 結合 Google Places API 和資料庫搜尋
    $('.input-group-append .btn').click(function() {
        const searchText = $('#search-input').val().trim();
        if (!searchText) return;
        
        // 首先在本地資料庫中搜尋
        const localResults = fuzzySearchRestaurants(searchText);
        
        if (localResults.length > 0) {
            // 如果在本地資料庫中找到結果，顯示這些結果
            displaySearchResults(localResults);
        } else {
            // 如果本地沒有找到結果，使用 Google Places API 搜尋
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                const service = new google.maps.places.PlacesService(map);
                service.textSearch({
                    query: searchText,
                    location: currentPosition,
                    radius: 5000
                }, handlePlacesResult);
            }
        }
    });
    
    // 監聽搜尋輸入框的 Enter 鍵
    $('#search-input').keypress(function(e) {
        if (e.which === 13) { // Enter 鍵的 keyCode
            $('.input-group-append .btn').click();
            e.preventDefault();
        }
    });
    
    // 添加側邊欄導航按鈕點擊事件 - 改為在地圖上顯示路線
    $(document).on('click', '#restaurant-info .btn-primary', function() {
        if (selectRestaurant && selectRestaurant.location) {
            showRouteInMap(selectRestaurant.location, selectRestaurant.name);
        }
    });
    
   // 添加餐廳項目點擊事件處理
$(document).on('click', '.restaurant-item', function(e) {
    e.preventDefault();
    
    // 確保地圖已初始化
    if (!map) {
        console.error('地圖尚未初始化');
        return;
    }
    
    // 獲取餐廳 ID
    const restaurantId = $(this).data('id');
    
    // 顯示地圖載入中狀態
    console.log('正在加載餐廳位置...');
    
    // 找到對應的標記並觸發點擊
    const marker = markers.find(m => m.storeId == restaurantId);
    if (marker) {
        // 確保標記可見
        marker.setVisible(true);
        
        // 移動地圖視角到標記位置
        map.setCenter(marker.getPosition());
        map.setZoom(16);
        
        // 觸發標記的點擊事件
        google.maps.event.trigger(marker, 'click');
    } else {
        // 如果找不到標記，直接從stores數據中獲取餐廳信息
        const store = stores.find(s => s.storeId == restaurantId);
        if (store && store.latitude && store.longitude) {
            const storeLocation = { 
                lat: parseFloat(store.latitude), 
                lng: parseFloat(store.longitude) 
            };
            
            // 移動地圖到餐廳位置
            map.setCenter(storeLocation);
            map.setZoom(16);
            
            // 顯示餐廳信息
            showRestaurantModal(store);
        } else {
            console.error('找不到餐廳資料或位置資訊');
        }
    }
});

    
    // 🔍 自動完成建議 + 高亮關鍵字 + 只顯示餐廳位置（不導航）
    $('#search-input').on('input', function () {
        const keyword = $(this).val().trim().toLowerCase();
        const suggestionBox = $('#autocomplete-suggestions');
        suggestionBox.empty();
        
        if (keyword.length === 0) {
        	addRestaurantsList();         // 恢復全部餐廳
            addRestaurantMarkers();       // 恢復所有地圖標記
            suggestionBox.hide();
            return;
        }
        
        const matched = stores.filter(store =>
            store.name.toLowerCase().includes(keyword) ||
            store.address.toLowerCase().includes(keyword)
        );
        
        if (matched.length === 0) {
            suggestionBox.hide();
            return;
        }
        
        matched.slice(0, 8).forEach(store => {
            // 高亮關鍵字
            const highlight = (text) => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                return text.replace(regex, '<b>$1</b>');
            };
            
            const suggestionItem = $(`
                <li class="list-group-item list-group-item-action">
                    ${highlight(store.name)} - ${highlight(store.address)}
                </li>
            `);
            
            suggestionItem.on('click', function() {
                // 更新搜尋框值並隱藏建議框
                $('#search-input').val(store.name);
                suggestionBox.hide();
                
                console.log('點擊餐廳建議:', store);
                
                // 顯示搜尋結果
                displaySearchResults([store]);
   
                
                // 1. 清除任何現有路線
                if (directionsRenderer) {
                    directionsRenderer.setMap(null);
                }
                
                // 2. 找到對應的標記
                const storeId = store.id;
                const marker = markers.find(m => m.storeId == storeId);
                
                if (marker) {
                    console.log('找到餐廳標記:', marker);
                    
                    // 直接使用現有標記
                    marker.setVisible(true);
                    map.setCenter(marker.getPosition());
                    map.setZoom(16);
                    
                    // 觸發標記點擊事件顯示信息窗口
                    google.maps.event.trigger(marker, 'click');
                } else {
                    console.log('未找到標記，手動創建:', store);
                    
                    // 直接從原始資料創建新標記
                    try {
                        // 嘗試獲取有效座標
                        const validLat = parseFloat(store.latitude);
                        const validLng = parseFloat(store.longitude);
                        
                        if (isNaN(validLat) || isNaN(validLng)) {
                            console.error('餐廳座標無效:', store);
                            return;
                        }
                        
                        const position = {
                            lat: validLat,
                            lng: validLng
                        };
                        
                        console.log('創建新標記於位置:', position);
                        
                        // 創建新標記
                        if (window.tempMarker) {
                            window.tempMarker.setMap(null);
                        }
                        
                        window.tempMarker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: store.name,
                            icon: {
                                url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                                scaledSize: new google.maps.Size(36, 36)
                            },
                            animation: google.maps.Animation.DROP,
                            storeId: store.storeId || index  // 改為使用storeId
                        });
                        
                        // 將標記添加到標記數組
                        markers.push(window.tempMarker);
                        
                        // 移動地圖到標記位置
                        map.setCenter(position);
                        map.setZoom(16);
                        
                        // 創建信息窗口
                        const infoContent = `
                            <div class="info-window">
                                <h3>${store.name}</h3>
                                <div><strong>地址：</strong>${store.address}</div>
                                <div><strong>電話：</strong>${store.phone || '無電話資訊'}</div>
                                <div><strong>評分：</strong>${store.rating || 4.5} / 5</div>
                            </div>
                        `;
                        
                        // 顯示信息窗口
                        infowindow.setContent(infoContent);
                        infowindow.open(map, window.tempMarker);
                        
                        // 更新餐廳信息面板
                        selectRestaurant = {
                            name: store.name,
                            address: store.address,
                            phoneNumber: store.phone || '',
                            rating: store.rating || 4.5,
                            location: position,
                            id: store.storeId, 
                        };
                        
                        updateRestaurantInfo(selectRestaurant);
                    } catch (error) {
                        console.error('創建標記時出錯:', error);
                    }
                }
            });
            
            suggestionBox.append(suggestionItem);
        });
        
        suggestionBox.show();
    });
    
    // 🔍 點擊其他地方時隱藏建議清單
    $(document).on('click', function (e) {
        if (!$(e.target).closest('#search-input').length &&
            !$(e.target).closest('#autocomplete-suggestions').length) {
            $('#autocomplete-suggestions').hide();
        }
    });


    
});


</script>

	<!-- Contact Javascript File -->
	<script src="mail/jqBootstrapValidation.min.js"></script>
	<script src="mail/contact.js"></script>

	<!-- Template Javascript -->
	<script src="js/main.js"></script>
</body>
</html>