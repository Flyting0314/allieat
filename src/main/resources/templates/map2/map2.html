<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<th:block th:replace="fragments/header :: header"></th:block>
<!-- è©•åˆ†æ˜Ÿæ˜Ÿæ¨£å¼ -->
<style>
/* è©•åˆ†æ˜Ÿæ˜Ÿæ¨£å¼ */
.stars-outer {
	display: inline-block;
	position: relative;
	font-family: 'Font Awesome 5 Free';
	font-weight: 900;
}

.stars-outer::before {
	content: "\f005 \f005 \f005 \f005 \f005";
	color: #ccc;
}

.stars-inner {
	position: absolute;
	top: 0;
	left: 0;
	white-space: nowrap;
	overflow: hidden;
	width: 0;
}

.stars-inner::before {
	content: "\f005 \f005 \f005 \f005 \f005";
	color: #f8ce0b;
}

/* åœ°åœ–ä¿¡æ¯è¦–çª—æ¨£å¼ */
.gm-style .gm-style-iw {
	font-family: 'Roboto', sans-serif;
	padding: 15px;
}

.info-window {
	padding: 10px;
}

.info-window h3 {
	margin-top: 0;
	margin-bottom: 10px;
	color: #da9f5b;
}

.info-window div {
	margin-bottom: 5px;
}

/* æœå°‹æ¡†ç„¦é»æ¨£å¼ */
#search-input:focus {
	box-shadow: 0 0 0 0.2rem rgba(218, 159, 91, 0.25);
	border-color: #da9f5b;
}

.section-title::after {
	position: absolute;
	content: "";
	width: 100%;
	height: 0;
	top: 50%;
	left: 0;
	border-top: 2px dashed #bbb;
	z-index: -1;
}

.section-title {
	position: relative;
	display: inline-block;
	letter-spacing: 1px;
	color: #da9f5b;
	border-color: #da9f5b;
}

.section-title span {
	position: relative;
	background: #ffffff;
	padding: 0 10px;
}

/* é¤å»³åˆ—è¡¨æ¨£å¼ */
.restaurant-item {
	transition: all 0.2s ease;
	border-left: 3px solid transparent;
}

.restaurant-item:hover {
	border-left: 3px solid #da9f5b;
	background-color: rgba(218, 159, 91, 0.05);
}

.restaurant-category .badge {
	background-color: #da9f5b;
	font-weight: normal;
}

.location-item .badge {
	background-color: #da9f5b;
	font-weight: normal;
}

/* æœå°‹çµæœå€åŸŸæ¨£å¼ */
.nearby-restaurants {
	max-height: 500px;
	overflow-y: auto;
	padding-right: 5px;
}

.nearby-restaurants::-webkit-scrollbar {
	width: 5px;
}

.nearby-restaurants::-webkit-scrollbar-track {
	background: #f1f1f1;
	border-radius: 10px;
}

.nearby-restaurants::-webkit-scrollbar-thumb {
	background: #da9f5b;
	border-radius: 10px;
}

.nearby-restaurants::-webkit-scrollbar-thumb:hover {
	background: #c28a4a;
}

/* é¤å»³æ¨™ç±¤æ¨£å¼ */
.restaurant-tags {
	margin-top: 5px;
}

.restaurant-tags .tag {
	display: inline-block;
	padding: 2px 8px;
	margin-right: 5px;
	font-size: 0.7rem;
	border-radius: 10px;
	background-color: rgba(218, 159, 91, 0.2);
	color: #8b5a2b;
}

/* è¼‰å…¥å‹•ç•« */
.loading-spinner {
	display: inline-block;
	width: 1rem;
	height: 1rem;
	border: 2px solid rgba(218, 159, 91, 0.2);
	border-radius: 50%;
	border-top-color: #da9f5b;
	animation: spin 1s ease-in-out infinite;
}

@keyframes spin {to { transform:rotate(360deg);
	
}

}

/* é¤å»³è©³æƒ…è¦–çª—æ¨£å¼ */
.restaurant-detail-modal .modal-header {
	background-color: #da9f5b;
	color: white;
}

.restaurant-detail-modal .close {
	color: white;
	opacity: 0.8;
}

.restaurant-detail-modal .close:hover {
	opacity: 1;
}

.restaurant-detail-modal .restaurant-amenities i {
	color: #da9f5b;
	margin-right: 5px;
}

/* é¤å»³è©³æƒ…è¦–çª—åº•éƒ¨æŒ‰éˆ•æ¨£å¼ */
.restaurant-detail-modal .modal-footer .btn-primary {
	background-color: #da9f5b;
	border-color: #da9f5b;
}

.restaurant-detail-modal .modal-footer .btn-primary:hover {
	background-color: #c28a4a;
	border-color: #c28a4a;
}

/* è¿”å›æŒ‰éˆ•æ¨£å¼ */
.back-to-restaurants {
	position: absolute;
	top: 10px;
	left: 10px;
	z-index: 1000;
	background-color: rgba(255, 255, 255, 0.9);
	border: 1px solid #da9f5b;
	color: #da9f5b;
	padding: 5px 12px;
	border-radius: 4px;
	font-size: 0.9rem;
	display: none;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.back-to-restaurants:hover {
	background-color: #da9f5b;
	color: white;
}

/* è·¯ç·šæŒ‡å¼•åˆ—è¡¨æ¨£å¼ */
.route-steps ol {
	padding-left: 20px;
	margin-top: 5px;
}

.route-steps li {
	margin-bottom: 8px;
	font-size: 0.9rem;
}

#autocomplete-suggestions {
	max-height: 250px;
	overflow-y: auto;
	border-radius: 0 0 10px 10px;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#autocomplete-suggestions li {
	padding: 10px 15px;
	border-bottom: 1px solid #f1f1f1;
}

#autocomplete-suggestions li:hover {
	background-color: #f8f9fa;
	cursor: pointer;
	border-left: 3px solid #da9f5b;
}

#autocomplete-suggestions li:last-child {
	border-bottom: none;
	border-radius: 0 0 10px 10px;
}

.pac-container {
	display: none !important;
}
</style>
</head>

<body>
<th:block th:replace="fragments/bodySection :: bodySection"></th:block>

	<!-- Hero Section End -->

	<!-- ç¾åŒ–å¾Œçš„åœ°åœ–å€åŸŸ -->
	<div class="container-fluid py-5 bg-light">
		<div class="container">
			<div class="row mb-4">
				<div class="col-12 text-center">
					<h2 class="section-title text-uppercase mb-2">
						<span>å°‹æ‰¾æ„›å¿ƒé¤å»³</span>
					</h2>
					<p class="text-muted">æœå°‹æ‚¨é™„è¿‘çš„æ„›å¿ƒä»£ç”¨é¤åˆä½œé¤å»³</p>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 mb-4">
					<div class="card shadow-sm h-100">
						<div class="card-body">
							<h4 class="mb-3">æœå°‹é¤å»³</h4>
							<div class="input-group mb-4 position-relative"
								style="width: 100%;">
								<input id="search-input" class="form-control"
									placeholder="è¼¸å…¥åœ°é»ã€åœ°å€æˆ–é¤å»³åç¨±..."
									style="border-radius: 50px 0 0 50px; padding: 12px 20px; font-size: 1rem; height: 48px; box-shadow: 0 3px 8px rgba(0, 0, 0, 0.1);">
								<div class="input-group-append">
									<button class="btn btn-primary"
										style="border-radius: 0 50px 50px 0; padding: 0 20px; font-size: 1rem; height: 48px;">
										<i class="fas fa-search"></i>
									</button>
								</div>


								<!-- ğŸ”½ è‡ªå‹•å®Œæˆæç¤º -->
								<ul id="autocomplete-suggestions"
									class="list-group position-absolute w-100"
									style="z-index: 1000; top: 100%; left: 0; display: none;"></ul>
							</div>

							<div id="restaurant-info" class="mt-4 d-none">
								<h5 class="restaurant-name font-weight-bold"></h5>
								<div class="restaurant-rating mb-2">
									<div class="stars-outer">
										<div class="stars-inner"></div>
									</div>
									<span class="rating-value ml-2"></span>
								</div>
								<p class="restaurant-address mb-1">
									<i class="fas fa-map-marker-alt mr-2 text-primary"></i> <span></span>
								</p>
								<p class="restaurant-phone mb-1">
									<i class="fas fa-phone mr-2 text-primary"></i> <span></span>
								</p>
								<p class="walking-time mb-3">
									<i class="fas fa-walking mr-2 text-primary"></i> <span></span>
								</p>
								<!-- å‰å¾€å°èˆªï¼šåœ°åœ–å°èˆª -->
								<button class="btn btn-primary btn-block mt-3"
									onclick="showRouteInMap(selectRestaurant.location, selectRestaurant.name)">
									<i class="fas fa-route mr-1"></i>å‰å¾€å°èˆª
								</button>

								<!-- å‰å¾€é»é¤ï¼šè·³è½‰åˆ°é»é¤é  -->
								<button type="button" class="btn btn-success btn-block mt-2"
									onclick="goToRestaurantPage(selectRestaurant.id || selectRestaurant.storeId, selectRestaurant.name)">
									<i class="fas fa-utensils mr-1"></i>å‰å¾€é»é¤
								</button>


							</div>

							<!-- âœ… ä¿ç•™ï¼šæ„›å¿ƒé¤åˆä½œsåˆ—è¡¨ -->
							<div class="nearby-restaurants mt-4">
								<h5>é™„è¿‘æ„›å¿ƒåˆä½œé¤å»³</h5>
								<div class="list-group mt-3 restaurants-list">
									<!-- é¤å»³åˆ—è¡¨æœƒç”±JSå‹•æ…‹ç”Ÿæˆ -->
								</div>
							</div>



						</div>
					</div>
				</div>

				<div class="col-md-8 mb-4">
					<div class="card shadow-sm h-100">
						<div class="card-body p-0">
							<div id="map"
								style="width: 100%; height: 700px; border-radius: 5px;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- é¤å»³è©³æƒ…æ¨¡æ…‹è¦–çª— -->
	<div class="modal fade restaurant-detail-modal"
		id="restaurantDetailModal" tabindex="-1" role="dialog"
		aria-labelledby="restaurantDetailModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="restaurantDetailModalLabel">é¤å»³è©³æƒ…</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<img id="restaurant-photo" class="img-fluid rounded" alt="é¤å»³å°é¢" style="display: none;" />

						</div>
						<div class="col-md-6">
							<h4 class="restaurant-name"></h4>
							<div class="restaurant-rating mb-2">
								<div class="stars-outer">
									<div class="stars-inner"></div>
								</div>
								<span class="rating-value ml-2"></span>
							</div>
							<p class="restaurant-address mb-1">
								<i class="fas fa-map-marker-alt mr-2 text-primary"></i> <span></span>
							</p>
							<p class="restaurant-phone mb-1">
								<i class="fas fa-phone mr-2 text-primary"></i> <span></span>
							</p>
							<p class="restaurant-category mb-1">
								<i class="fas fa-utensils mr-2 text-primary"></i> <span></span>
							</p>
							<div class="restaurant-tags mt-2">
								<!-- æ¨™ç±¤æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
							</div>
						</div>
					</div>

					<hr>

					<div class="row mt-3">
						<div class="col-12">
							<h5>æ„›å¿ƒä»£ç”¨é¤è¨Šæ¯</h5>
							<p>æœ¬é¤å»³æ˜¯ã€Œæ”å‘·éœ¸ ALLiEATã€æ„›å¿ƒä»£ç”¨é¤åˆä½œå¤¥ä¼´ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤è™•ï¼š</p>
							<ul>
								<li>æè´ˆæ„›å¿ƒé¤é»çµ¦æœ‰éœ€è¦çš„äºº</li>
								<li>è‹¥æ‚¨æœ‰æ„›å¿ƒä»£ç”¨é¤åˆ¸ï¼Œå¯åœ¨æ­¤å…Œæ›é¤é»</li>
							</ul>
						</div>
					</div>

					<div class="row mt-3">
						<div class="col-12">
							<h5>é¤å»³è¨­æ–½</h5>
							<div class="restaurant-amenities row">
								<div class="col-md-4 mb-2">
									<i class="fas fa-wifi"></i> å…è²»WiFi
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-parking"></i> åœè»Šå ´
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-wheelchair"></i> ç„¡éšœç¤™è¨­æ–½
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-baby"></i> å…’ç«¥åº§æ¤…
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-credit-card"></i> åˆ·å¡æœå‹™
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-dog"></i> å¯µç‰©å‹å–„
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">é—œé–‰</button>
					<button type="button" class="btn btn-primary btn-restaurant">å‰å¾€é»é¤</button>
					<button type="button" class="btn btn-primary btn-navigation">å‰å¾€å°èˆª</button>
					<!-- <button onclick="debugStore()">èª¿è©¦é¤å»³æ•¸æ“š</button> -->
				</div>
			</div>
		</div>
	</div>

	<!-- Footer Start -->
	<th:block th:replace="fragments/footer :: footer"></th:block>

	<!-- Back to Top -->
	<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i
		class="fa fa-angle-double-up"></i></a>

	<!-- å°‡å¾Œç«¯çš„ storeList å‚³åˆ°å‰ç«¯è®Šæˆ JS è®Šæ•¸ -->
	<script th:inline="javascript">
    /*<![CDATA[*/
    const stores = /*[[${storeList}]]*/ [];
    /*]]>*/
</script>

	<!-- JavaScript Libraries -->
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
	<script src="lib/easing/easing.min.js"></script>
	<script src="lib/waypoints/waypoints.min.js"></script>
	<script src="lib/owlcarousel/owl.carousel.min.js"></script>
	<script src="lib/tempusdominus/js/moment.min.js"></script>
	<script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
	<script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

	<!-- åœ°åœ–ç›¸é—œè…³æœ¬ -->
	<script>
    // æ•´åˆåœ°åœ–JavaScript
    let map;
    let currentPosition;
    let selectRestaurant;
    let marker;
    let autocomplete;
    let directionsService;
    let directionsRenderer;
    let infowindow;
    let markers = []; // å­˜å„²æ‰€æœ‰æ¨™è¨˜
    let userMarker; // ç”¨æˆ¶ä½ç½®æ¨™è¨˜
    let tempSearchMarker = null;  // ä½¿ç”¨è€…æœå°‹ä½ç½®çš„ç´…é»
    let tempRouteMarker = null;   // å°èˆªç›®çš„åœ°çš„æ©˜é»

    
  
    function initMap() {
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 25.033, lng: 121.565 },
            zoom: 14,
            styles: [/* åœ°åœ–æ¨£å¼ç•¥ */],
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            zoomControl: true
        });

        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: '#da9f5b',
                strokeWeight: 5,
                strokeOpacity: 0.7
            }
        });

        infowindow = new google.maps.InfoWindow({
            maxWidth: 300,
            pixelOffset: new google.maps.Size(0, -30)
        });

        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function (position) {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };

                // âœ… æ¨™è¨˜ä½¿ç”¨è€…ä½ç½®
                userMarker = new google.maps.Marker({
                    position: currentPosition,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeColor: "white",
                        strokeWeight: 2
                    },
                    title: "æ‚¨çš„ä½ç½®",
                    zIndex: 999
                });

                map.setCenter(currentPosition);

                // âœ… åˆå§‹åŒ– autocomplete
                autocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('search-input'),
                    {
                        types: ['restaurant', 'food'],
                        componentRestrictions: { country: 'tw' }
                    }
                );
                autocomplete.addListener('place_changed', onPlaceChanged);

                // âœ… ç­‰ currentPosition æœ‰å€¼å†å‘¼å«é€™å…©å€‹
                addRestaurantMarkers();
                addRestaurantsList();

            }, function () {
                handleLocationError(true, map.getCenter());
            });
        } else {
            handleLocationError(false, map.getCenter());
        }
    }


    function handleLocationError(browserHasGeolocation, pos) {
        alert(browserHasGeolocation
            ? 'ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªä½ç½®æ¬Šé™å·²é–‹å•Ÿã€‚'
            : 'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚');

        currentPosition = { lat: 25.047924, lng: 121.517081 }; // å°åŒ—è»Šç«™ fallback
        map.setCenter(currentPosition);

        autocomplete = new google.maps.places.Autocomplete(
            document.getElementById('search-input')
        );
        autocomplete.addListener('place_changed', onPlaceChanged);

        // âœ… ä¹Ÿè¦è£œä¸Šé€™å…©è¡Œ
        addRestaurantMarkers();
        addRestaurantsList();
    }

    function onPlaceChanged() {
        const place = autocomplete.getPlace();
        
        if (!place.geometry || !place.geometry.location) {
            alert("æ‰¾ä¸åˆ°è©²åœ°é»çš„è©³ç´°è³‡è¨Šï¼Œè«‹é¸æ“‡æœå°‹çµæœä¸­çš„é¤å»³ã€‚");
            return;
        }
        
        selectRestaurant = {
            location: {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            },
            placeId: place.place_id,
            name: place.name,
            address: place.formatted_address || "ç„¡åœ°å€è³‡è¨Š",
            phoneNumber: place.formatted_phone_number || "ç„¡é›»è©±è³‡è¨Š",
            rating: place.rating || "å°šæœªè©•åˆ†"
        };
        
        // æ›´æ–°åœ°åœ–
        map.setCenter(selectRestaurant.location);
        map.setZoom(17);
        
        // æ›´æ–°æ¨™è¨˜
        if (tempSearchMarker) tempSearchMarker.setMap(null);
tempSearchMarker = new google.maps.Marker({
    map: map,
    position: selectRestaurant.location,
    animation: google.maps.Animation.DROP,
    icon: {
        url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
        scaledSize: new google.maps.Size(40, 40)
    },
    title: selectRestaurant.name
});
        
        // æ›´æ–°å´é‚Šæ¬„è³‡è¨Š
        updateRestaurantInfo(selectRestaurant);
        
        // é¡¯ç¤ºä¿¡æ¯çª—å£
        const content = `
            <div class="info-window">
                <h3>${selectRestaurant.name}</h3>
                <div><strong>åœ°å€ï¼š</strong>${selectRestaurant.address}</div>
                <div><strong>é›»è©±ï¼š</strong>${selectRestaurant.phoneNumber}</div>
                <div><strong>è©•åˆ†ï¼š</strong>${selectRestaurant.rating} / 5</div>
                <div class="mt-2 text-center">
                    <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap(${selectRestaurant.location.lat}, ${selectRestaurant.location.lng}, '${selectRestaurant.name}')">
                        <i class="fas fa-route mr-1"></i>é¡¯ç¤ºè·¯ç·š
                    </button>
                </div>
            </div>
        `;
        
        infowindow.setContent(content);
        infowindow.open(map, marker);
    }

    function updateRestaurantInfo(restaurant) {
        const infoDiv = document.getElementById('restaurant-info');
        infoDiv.classList.remove('d-none');
        
        // æ›´æ–°é¤å»³åç¨±
        infoDiv.querySelector('.restaurant-name').textContent = restaurant.name;
        
        // æ›´æ–°è©•åˆ†æ˜Ÿæ˜Ÿ
        const starsInner = infoDiv.querySelector('.stars-inner');
        const starPercentage = (restaurant.rating / 5) * 100;
        starsInner.style.width = `${starPercentage}%`;
        infoDiv.querySelector('.rating-value').textContent = `${restaurant.rating} / 5`;
        
        // æ›´æ–°åœ°å€èˆ‡é›»è©±
        infoDiv.querySelector('.restaurant-address span').textContent = restaurant.address;
        infoDiv.querySelector('.restaurant-phone span').textContent = restaurant.phoneNumber || restaurant.phone;
        
        // æ›´æ–°æ­¥è¡Œæ™‚é–“
        if (restaurant.duration) {
            infoDiv.querySelector('.walking-time span').textContent = restaurant.duration;
        } else {
            infoDiv.querySelector('.walking-time span').textContent = "è¨ˆç®—ä¸­...";
            // è¨ˆç®—æ­¥è¡Œæ™‚é–“
            if (currentPosition && restaurant.location) {
                directionsService.route({
                    origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
                    destination: new google.maps.LatLng(restaurant.location.lat, restaurant.location.lng),
                    travelMode: 'WALKING'
                }, function(response, status) {
                    if (status === 'OK') {
                        const leg = response.routes[0].legs[0];
                        infoDiv.querySelector('.walking-time span').textContent = leg.duration.text;
                        restaurant.duration = leg.duration.text;
                    }
                });
            }
        }
        
        // æ›´æ–°å°èˆªæŒ‰éˆ•äº‹ä»¶ - åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè·¯ç·š
        const navButton = infoDiv.querySelector('.btn-primary');
        navButton.onclick = function() {
            if (restaurant.location) {
                showRouteInMap(restaurant.location, restaurant.name);
            }
        };
    }

    // æ·»åŠ é¤å»³æ¨™è¨˜ - ä½¿ç”¨å¾ Thymeleaf ç²å–çš„æ•¸æ“š
    function addRestaurantMarkers() {
        // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        
        // ä½¿ç”¨å¾Œç«¯æä¾›çš„é¤å»³æ•¸æ“š
        if (typeof stores !== 'undefined' && stores.length > 0) {
            stores.forEach((store, index) => {
                // å°‡å¾Œç«¯æ•¸æ“šè½‰æ›ç‚ºåœ°åœ–æ‰€éœ€æ ¼å¼
                const storeLocation = { 
                    lat: store.latitude,
                    lng: store.longitude
                };
                
                const marker = new google.maps.Marker({
                    position: storeLocation,
                    map: map,
                    title: store.name,
                    animation: google.maps.Animation.DROP,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                        scaledSize: new google.maps.Size(36, 36)
                    },
                    label: {
                        text: store.name,
                        color: '#000',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    storeId: store.storeId || index  // æ”¹ç‚ºä½¿ç”¨storeId
                });
                
                markers.push(marker);
                
       
             // é»æ“Šæ¨™è¨˜æ™‚é¡¯ç¤ºä¿¡æ¯
                marker.addListener('click', function() {
                    selectRestaurant = {
                        name: store.name,
                        address: store.address,
                        phoneNumber: store.phone,
                        rating: store.rating || 4.5,
                        location: storeLocation,
                        id: store.storeId || store.id, // ç¢ºä¿ä½¿ç”¨æ­£ç¢ºçš„ ID
                        category: store.category || 'é¤é£²',
                        tags: store.tags || ['æ„›å¿ƒåˆä½œåº—']
                    };
                    
                    // ç›´æ¥é¡¯ç¤ºæ¨¡æ…‹è¦–çª—ï¼Œè€Œä¸æ˜¯åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºä¿¡æ¯çª—å£
                    showRestaurantModal(store);
                });
                    
                    
                    //æ¸¬è©¦ç”¨======================
                    function debugRestaurant(btn, id, name) {
                    console.log('æº–å‚™è·³è½‰,é¤å»³ID:', id, 'é¤å»³åç¨±:', name);
                    console.log('æŒ‰éˆ•å…ƒç´ :', btn);
                    console.log('æ‰¾åˆ°ç›¸æ‡‰åº—å®¶:', stores.find(s => s.name === name));
                    
                    // å»¶é²è·³è½‰ï¼Œä»¥ä¾¿æŸ¥çœ‹èª¿è©¦ä¿¡æ¯
                    setTimeout(() => {
                        goToRestaurantPage(id, name);
                    }, 3000);
                }
             });
         }
    } 
    

    function handlePlacesResult(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
            const place = results[0];
            
            selectRestaurant = {
                location: {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng()
                },
                placeId: place.place_id,
                name: place.name,
                address: place.formatted_address || "ç„¡åœ°å€è³‡è¨Š",
                phoneNumber: "02-XXXX-XXXX", // la4æ¨¡æ“¬é›»è©±
                rating: place.rating || "å°šæœªè©•åˆ†"
            };
            
            // æ›´æ–°åœ°åœ–
            map.setCenter(selectRestaurant.location);
            map.setZoom(17);
            
            // æ›´æ–°æ¨™è¨˜
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({
                map: map,
                position: selectRestaurant.location,
                animation: google.maps.Animation.DROP
            });
            
            // æ›´æ–°å´é‚Šæ¬„è³‡è¨Š
            updateRestaurantInfo(selectRestaurant);
            
            // å‰µå»ºä¿¡æ¯çª—å£
            const infoContent = `
                <div class="info-window">
                    <h3>${selectRestaurant.name}</h3>
                    <div><strong>åœ°å€ï¼š</strong>${selectRestaurant.address}</div>
                    <div><strong>é›»è©±ï¼š</strong>${selectRestaurant.phoneNumber}</div>
                    <div><strong>è©•åˆ†ï¼š</strong>${selectRestaurant.rating} / 5</div>
                    <div class="mt-2 text-center">
                        <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap({lat: ${selectRestaurant.location.lat}, lng: ${selectRestaurant.location.lng}}, '${selectRestaurant.name}')">
                            <i class="fas fa-route mr-1"></i>é¡¯ç¤ºè·¯ç·š
                        </button>
                    </div>
                </div>
            `;
            
            infowindow.setContent(infoContent);
            infowindow.open(map, marker);
        } else {
            alert("æ‰¾ä¸åˆ°ç›¸é—œé¤å»³");
        }
    }
    
    // æ›´æ–°å´é‚Šæ¬„
    function updateSidebar() {
        // å…ˆæ·»åŠ é¤å»³åˆ—è¡¨å€åŸŸ (ä¿®æ”¹é †åº)
        addRestaurantsList();
        
       
    }

    // æ›´æ–°ç†±é–€åœ°é»å€åŸŸ
    function updatePopularLocations() {
        const popularLocations = restaurantApi.getPopularLocations();
        const locationContainer = document.querySelector('.location-tips .list-group');
        
        // æ¸…é™¤ç¾æœ‰é …ç›®
        locationContainer.innerHTML = '';
        
        // æ·»åŠ æ–°é …ç›®
        popularLocations.forEach(location => {
            const locationItem = document.createElement('a');
            locationItem.href = '#';
            locationItem.className = 'list-group-item list-group-item-action location-item';
            locationItem.setAttribute('data-name', location.name);
            locationItem.innerHTML = `
                <i class="fas fa-utensils mr-2 text-primary"></i>
                ${location.name} <span class="badge badge-pill badge-primary">${location.count}</span>
            `;
            
            // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
            locationItem.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('search-input').value = this.getAttribute('data-name');
                
                // è§¸ç™¼æœå°‹
                const service = new google.maps.places.PlacesService(map);
                service.textSearch({
                    query: this.getAttribute('data-name') + " é¤å»³",
                    location: currentPosition,
                    radius: 5000
                }, handlePlacesResult);
            });
            
            locationContainer.appendChild(locationItem);
        });
    }

    // æ·»åŠ é¤å»³åˆ—è¡¨å€åŸŸ
    
  // âœ… ç¢ºä¿ getDistance å›å‚³çš„æ˜¯å…¬é‡Œæ•¸ï¼ˆä¸æ˜¯å…¬å°ºï¼‰ï¼Œä¸¦åŠ å¼·æª¢æŸ¥ currentPosition æ˜¯å¦æ­£ç¢º
function getDistance(lat1, lng1, lat2, lng2) {
    if (!lat1 || !lng1 || !lat2 || !lng2) return 0;
    function toRad(x) {
        return x * Math.PI / 180;
    }
    const R = 6371; // åœ°çƒåŠå¾‘ (å…¬é‡Œ)
    const dLat = toRad(lat2 - lat1);
    const dLng = toRad(lng2 - lng1);
    const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
              Math.cos(toRad(lat1)) * Math.cos(toRad(lat2)) *
              Math.sin(dLng / 2) * Math.sin(dLng / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
}

function addRestaurantsList() {
    const restaurantsList = document.querySelector('.restaurants-list');
    restaurantsList.innerHTML = '';

    if (!currentPosition || !currentPosition.lat || !currentPosition.lng) {
        console.warn('å°šæœªå–å¾—ä½¿ç”¨è€…ä½ç½®');
        restaurantsList.innerHTML = '<p class="text-center">å°šæœªå–å¾—ä½¿ç”¨è€…ä½ç½®</p>';
        return;
    }

    const geocoder = new google.maps.Geocoder();

    if (typeof stores !== 'undefined' && stores.length > 0) {
        stores.forEach((store, index) => {
            const restaurantItem = document.createElement('a');
            restaurantItem.href = '#';
            restaurantItem.className = 'list-group-item list-group-item-action restaurant-item';
            restaurantItem.setAttribute('data-id', store.storeId);

            const tags = store.tags || ['æ„›å¿ƒåˆä½œåº—'];
            const tagHtml = tags.map(tag => `<small class="badge badge-info ml-1">${tag}</small>`).join('');

            // é è¨­è·é›¢æ–‡å­—
            let distanceText = 'è·é›¢æœªçŸ¥';

            const renderRestaurantItem = (distance) => {
                distanceText = distance < 1 ? `${Math.round(distance * 1000)} å…¬å°º` : `${distance.toFixed(1)} å…¬é‡Œ`;

                restaurantItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${store.name}</h6>
                        <small>${distanceText}</small>
                    </div>
                    <div class="restaurant-category mb-1">
                        <small class="text-muted">${store.category || 'é¤é£²'}</small>
                        ${tagHtml}
                    </div>
                    <small class="d-block">
                        <div class="stars-outer d-inline-block" style="font-size: 0.8rem;">
                            <div class="stars-inner" style="width: ${((store.rating || 4.5) / 5) * 100}%"></div>
                        </div>
                        <span class="rating-value ml-1">${store.rating || 4.5}</span>
                    </small>
                `;

                restaurantItem.addEventListener('click', function (e) {
                    e.preventDefault();
                    const storeId = $(this).data('id');
                    const storeData = stores.find(s => s.storeId == storeId || s.id == storeId);
                    if (storeData) showRestaurantModal(storeData);
                });

                restaurantsList.appendChild(restaurantItem);
            };

            // âœ… æœ‰ç¶“ç·¯åº¦å°±å…ˆè½‰ç‚ºæ•¸å­—å†è™•ç†
            const lat = parseFloat(store.latitude);
            const lng = parseFloat(store.longitude);

            if (!isNaN(lat) && !isNaN(lng)) {
                const dist = getDistance(currentPosition.lat, currentPosition.lng, lat, lng);
                renderRestaurantItem(dist);
            } else if (store.address) {
                // â—æ²’æœ‰ç¶“ç·¯åº¦å°±ç”¨åœ°å€åæŸ¥
                geocoder.geocode({ address: store.address }, function (results, status) {
                    if (status === 'OK' && results[0] && results[0].geometry) {
                        const loc = results[0].geometry.location;
                        const lat = loc.lat();
                        const lng = loc.lng();

                        store.latitude = lat;
                        store.longitude = lng;

                        const dist = getDistance(currentPosition.lat, currentPosition.lng, lat, lng);
                        renderRestaurantItem(dist);
                    } else {
                        console.warn('åœ°å€è½‰ç¶“ç·¯åº¦å¤±æ•—', store.address, status);
                        renderRestaurantItem(NaN);
                    }
                });
            } else {
                // æ²’ç¶“ç·¯åº¦ä¹Ÿæ²’åœ°å€ï¼Œç„¡æ³•è¨ˆç®—
                renderRestaurantItem(NaN);
            }
        });
    } else {
        restaurantsList.innerHTML = '<p class="text-center">æ²’æœ‰å¯ç”¨çš„é¤å»³è³‡æ–™</p>';
    }
}

//æ¸¬è©¦ç”¨========================
function debugStore() {
    console.log('æ‰€æœ‰é¤å»³æ•¸æ“š:', stores);
    if(stores.length > 0) {
        console.log('ç¬¬ä¸€å€‹é¤å»³çµæ§‹:', stores[0]);
        console.log('é¤å»³IDå±¬æ€§:', stores[0].storeId, stores[0].id);
    }
    return false; // é˜»æ­¢é é¢è·³è½‰
}

// è·³è½‰åˆ°é¤å»³è©³æƒ…é é¢
function goToRestaurantPage(storeId, name) {
    console.log('è·³è½‰åˆ°é¤å»³é é¢, ID:', storeId, 'åç¨±:', name);
    
    // ç¢ºä¿ storeId æ˜¯æ•¸å­—
    storeId = parseInt(storeId, 10);
    
    if (isNaN(storeId) || storeId <= 0) {
        console.error('ç„¡æ•ˆçš„é¤å»³ID');
        alert('æ‰¾ä¸åˆ°é¤å»³ï¼Œè«‹é‡æ–°é¸æ“‡');
        return;
    }
    
    // å¦‚æœåç¨±æ˜¯ç·¨ç¢¼éçš„ï¼Œå…ˆè§£ç¢¼
    name = decodeURIComponent(name);
    
    // è·³è½‰åˆ°é¤å»³é»é¤é é¢
    const url = `/orderfood?id=${storeId}&name=${encodeURIComponent(name)}`;
    console.log('å³å°‡è·³è½‰åˆ°:', url);
    window.location.href = url;
}

// é¤å»³è©³æƒ…æ¨¡æ…‹è¦–çª—
function showRestaurantModal(restaurant) {
    const modal = $('#restaurantDetailModal');

    // âœ… è£œå¼· storeIdï¼Œå¦‚æœæ˜¯ store.id å‚³é€²ä¾†çš„è©±
    if (!restaurant.storeId && restaurant.id) {
        restaurant.storeId = restaurant.id;
    }

    // âœ… è¨­å®šåœ–ç‰‡é¡¯ç¤º
    const photoImg = document.getElementById("restaurant-photo");
    const imgUrl = `/meal/photo/${restaurant.storeId}/cover`;
    const testImg = new Image();

    testImg.onload = function () {
        photoImg.src = imgUrl;
        photoImg.style.display = "block";
    };
    testImg.onerror = function () {
        console.warn("è¼‰å…¥åœ–ç‰‡å¤±æ•—ï¼Œæ”¹ç”¨é è¨­åœ–ï¼š", imgUrl);
        photoImg.src = "/img/default-restaurant.png"; // âœ… ä½¿ç”¨é è¨­åœ–
        photoImg.style.display = "block";
    };
    testImg.src = imgUrl;

    // âœ… è¨­å®šé¤å»³è³‡è¨Š
    modal.find('.restaurant-name').text(restaurant.name);
    modal.find('.restaurant-address span').text(restaurant.address || "åœ°å€æœªçŸ¥");
    modal.find('.restaurant-phone span').text(restaurant.phone || restaurant.phoneNumber || "ç„¡é›»è©±è³‡è¨Š");
    modal.find('.restaurant-category span').text(restaurant.category || 'ä¸€èˆ¬é¤é£²');

    // âœ… æ˜Ÿæ˜Ÿè©•åˆ†
    const starsInner = modal.find('.stars-inner');
    const rating = parseFloat(restaurant.rating || 4.5);
    const starPercentage = (rating / 5) * 100;
    starsInner.css('width', `${starPercentage}%`);
    modal.find('.rating-value').text(`${rating.toFixed(1)} / 5`);

    // âœ… æ¨™ç±¤æ¸²æŸ“
    const tagsContainer = modal.find('.restaurant-tags');
    tagsContainer.empty();
    const tags = restaurant.tags || ['æ„›å¿ƒåˆä½œåº—'];
    tags.forEach(tag => {
        tagsContainer.append(`<span class="badge badge-info mr-1">${tag}</span>`);
    });

    // âœ… å‰å¾€é»é¤æŒ‰éˆ•
    modal.find('.btn-restaurant').off('click').on('click', function () {
        modal.modal('hide');
        goToRestaurantPage(restaurant.storeId, restaurant.name);
    });

    // âœ… å‰å¾€å°èˆªæŒ‰éˆ•
    modal.find('.btn-navigation').off('click').on('click', function () {
        modal.modal('hide');
        if (restaurant.latitude && restaurant.longitude) {
            showRouteInMap({
                lat: parseFloat(restaurant.latitude),
                lng: parseFloat(restaurant.longitude)
            }, restaurant.name);
        } else if (restaurant.location) {
            showRouteInMap(restaurant.location, restaurant.name);
        } else {
            const geocoder = new google.maps.Geocoder();
            geocoder.geocode({ address: restaurant.address }, function (results, status) {
                if (status === 'OK' && results[0]?.geometry) {
                    const loc = results[0].geometry.location;
                    showRouteInMap({ lat: loc.lat(), lng: loc.lng() }, restaurant.name);
                } else {
                    alert('ç„¡æ³•è§£æåœ°å€ï¼š' + restaurant.address);
                }
            });
        }
    });

    // âœ… é¡¯ç¤ºæ¨¡æ…‹è¦–çª—
    modal.modal('show');
}

    // æ ¼å¼åŒ–è·¯ç·šæŒ‡å¼•æ–‡å­—
    function formatInstructions(instruction) {
        // ç§»é™¤HTMLæ¨™ç±¤ä½†ä¿ç•™æ–‡å­—
        const div = document.createElement('div');
        div.innerHTML = instruction;
        let text = div.textContent || div.innerText || '';
        
        // å¦‚æœæœ‰è·é›¢è³‡è¨Šï¼Œä¿ç•™è·é›¢ä½†ç°¡åŒ–æ ¼å¼
        const distanceMatch = instruction.match(/(\d+)\s*(å…¬å°º|ç±³|m|km|å…¬é‡Œ)/i);
        if (distanceMatch) {
            const distance = distanceMatch[0];
            text = text.replace(/å‘(æ±|å—|è¥¿|åŒ—|æ±åŒ—|æ±å—|è¥¿å—|è¥¿åŒ—)èµ°/, 'å‘$1èµ° ' + distance);
        }
        
        // ç°¡åŒ–å¸¸è¦‹æŒ‡å¼•
        text = text.replace('ç¹¼çºŒç›´è¡Œ', 'ç›´è¡Œ')
               .replace('è¼•å¾®å‘å³è½‰', 'ç¨å¾®å³è½‰')
               .replace('è¼•å¾®å‘å·¦è½‰', 'ç¨å¾®å·¦è½‰')
               .replace('ç›®çš„åœ°åœ¨', 'åˆ°é”');
        
        return text;
    }

    // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè·¯ç·šå°èˆª
    function showRouteInMap(destination, destinationName) {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç”¨æˆ¶ä½ç½®
        if (!currentPosition) {
            alert('è«‹å…ˆå…è¨±ç²å–æ‚¨çš„ä½ç½®ï¼Œä»¥ä¾¿è¦åŠƒè·¯ç·š');
            return;
        }
        
        // é¡¯ç¤ºè¿”å›æŒ‰éˆ•
        const backButton = document.getElementById('back-to-restaurants');
        if (backButton) {
            backButton.style.display = 'block';
        } else {
            // å‰µå»ºè¿”å›æŒ‰éˆ•
            const btn = document.createElement('button');
            btn.id = 'back-to-restaurants';
            btn.className = 'back-to-restaurants';
            btn.innerHTML = '<i class="fas fa-arrow-left mr-2"></i>è¿”å›é¤å»³åˆ—è¡¨';
            btn.onclick = function() {
                // æ¸…é™¤è·¯ç·š
                directionsRenderer.set('directions', null);
                
                // éš±è—è¿”å›æŒ‰éˆ•
                this.style.display = 'none';
                
                // é‡æ–°é¡¯ç¤ºæ‰€æœ‰é¤å»³æ¨™è¨˜
                markers.forEach(marker => marker.setVisible(true));
                
                // é—œé–‰ä¿¡æ¯çª—å£
                infowindow.close();
                
                // é¡¯ç¤ºæ‰€æœ‰é¤å»³
                showAllRestaurants();
            };
            document.getElementById('map').parentNode.appendChild(btn);
        }
        
        // éš±è—æ‰€æœ‰é¤å»³æ¨™è¨˜
        markers.forEach(marker => marker.setVisible(false));
        
        // è¦åŠƒè·¯ç·š
        directionsService.route({
            origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
            destination: new google.maps.LatLng(destination.lat, destination.lng),
            travelMode: 'WALKING',
            provideRouteAlternatives: false,
            avoidHighways: true,
            avoidTolls: true
        }, function(response, status) {
            if (status === 'OK') {
                // è¨­ç½®è·¯ç·šæ¸²æŸ“å™¨é¸é …
                directionsRenderer.setOptions({
                    directions: response,
                    suppressMarkers: true, // éš±è—é»˜èªæ¨™è¨˜
                    polylineOptions: {
                        strokeColor: '#da9f5b',
                        strokeWeight: 5,
                        strokeOpacity: 0.7
                    }
                });
                
                // ç²å–è·¯ç·šè©³æƒ…
                const leg = response.routes[0].legs[0];
                
                // æ ¼å¼åŒ–è·¯ç·šæŒ‡å¼•æ­¥é©Ÿ
                const formattedSteps = leg.steps.map(step => {
                    return `<li>${formatInstructions(step.instructions)}</li>`;
                }).join('');
                
                // å‰µå»ºè·¯ç·šè©³æƒ…ä¿¡æ¯çª—å£
                const routeInfo = `
                    <div class="info-window">
                        <h3>å‰å¾€ ${destinationName}</h3>
                        <div><strong><i class="fas fa-map-marker-alt mr-2 text-primary"></i>èµ·é»ï¼š</strong>${leg.start_address}</div>
                        <div><strong><i class="fas fa-flag-checkered mr-2 text-danger"></i>çµ‚é»ï¼š</strong>${leg.end_address}</div>
                        <div><strong><i class="fas fa-route mr-2 text-success"></i>è·é›¢ï¼š</strong>${leg.distance.text}</div>
                        <div><strong><i class="fas fa-walking mr-2 text-info"></i>æ­¥è¡Œæ™‚é–“ï¼š</strong>${leg.duration.text}</div>
                        <div class="route-steps mt-2">
                            <strong><i class="fas fa-directions mr-2"></i>è·¯ç·šæŒ‡å¼•ï¼š</strong>
                            <ol class="mt-1">
                                ${formattedSteps}
                            </ol>
                        </div>
                    </div>
                `;
                
                // é¡¯ç¤ºè·¯ç·šè©³æƒ…
                infowindow.setContent(routeInfo);
                infowindow.setPosition(destination);
                infowindow.open(map);
                
                // æ›´æ–°åœ°åœ–è¦–è§’ä»¥é¡¯ç¤ºæ•´æ¢è·¯ç·š
                const bounds = new google.maps.LatLngBounds();
                const path = response.routes[0].overview_path;
                path.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
                
                // æ·»åŠ èµ·é»å’Œçµ‚é»æ¨™è¨˜
                // èµ·é»å·²æœ‰ç”¨æˆ¶ä½ç½®æ¨™è¨˜
                // æ·»åŠ çµ‚é»æ¨™è¨˜
             // æ·»åŠ çµ‚é»æ¨™è¨˜ï¼ˆæ”¹ç‚ºå€åŸŸè®Šæ•¸ï¼‰
                const destinationMarker = new google.maps.Marker({
                    position: new google.maps.LatLng(destination.lat, destination.lng),
                    map: map,
                    title: destinationName,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    zIndex: 900
                });

            } else {
                alert('ç„¡æ³•è¦åŠƒè·¯ç·šï¼š' + status);
                
                // é‡æ–°é¡¯ç¤ºæ‰€æœ‰é¤å»³æ¨™è¨˜
                markers.forEach(marker => marker.setVisible(true));
                
                // éš±è—è¿”å›æŒ‰éˆ•
                document.getElementById('back-to-restaurants').style.display = 'none';
            }
        });
    }

    // é¡¯ç¤ºæ‰€æœ‰é¤å»³
    function showAllRestaurants() {
        if (markers.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            
            markers.forEach(marker => {
                marker.setVisible(true);
                bounds.extend(marker.getPosition());
            });
            
            map.fitBounds(bounds);
        }
    }

    // æ¨¡ç³Šæœç´¢å‡½æ•¸ - åœ¨storesæ•¸çµ„ä¸­æœå°‹ç¬¦åˆæ¢ä»¶çš„é¤å»³
    function fuzzySearchRestaurants(searchText) {
        if (!stores || !stores.length) {
            return [];
        }
        
        // å°‡æœå°‹æ–‡å­—è½‰å°å¯«ä»¥é€²è¡Œä¸å€åˆ†å¤§å°å¯«çš„æ¯”å°
        const searchLower = searchText.toLowerCase();
        
        // ç¯©é¸ç¬¦åˆæ¢ä»¶çš„é¤å»³
        return stores.filter(store => {
            // æª¢æŸ¥é¤å»³åç¨±
            if (store.name && store.name.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // æª¢æŸ¥åœ°å€
            if (store.address && store.address.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // æª¢æŸ¥é¡åˆ¥
            if (store.category && store.category.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // æª¢æŸ¥æ¨™ç±¤
            if (store.tags && Array.isArray(store.tags)) {
                return store.tags.some(tag => tag.toLowerCase().includes(searchLower));
            }
            
            return false;
        });
    }

    // é¡¯ç¤ºæœå°‹çµæœå‡½æ•¸
   function displaySearchResults(results) {
    markers.forEach(marker => marker.setMap(null));
    markers = [];

    if (results.length === 0) {
        alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³');
        addRestaurantMarkers();
        return;
    }

    const restaurantsList = document.querySelector('.restaurants-list');
    restaurantsList.innerHTML = '';

    const bounds = new google.maps.LatLngBounds();

    results.forEach((store, index) => {
        const storeLocation = {
            lat: parseFloat(store.latitude),
            lng: parseFloat(store.longitude)
        };

        bounds.extend(new google.maps.LatLng(storeLocation.lat, storeLocation.lng));

        const marker = new google.maps.Marker({
            position: storeLocation,
            map: map,
            title: store.name,
            animation: google.maps.Animation.DROP,
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                scaledSize: new google.maps.Size(36, 36)
            },
            label: {
                text: store.name,
                color: '#000',
                fontSize: '12px',
                fontWeight: 'bold'
            },
            storeId: store.storeId || index
        });

        markers.push(marker);

        marker.addListener('click', function () {
            selectRestaurant = {
                name: store.name,
                address: store.address,
                phoneNumber: store.phone,
                rating: store.rating || 4.5,
                location: storeLocation,
                id: store.storeId || store.id,
                category: store.category || 'é¤é£²',
                tags: store.tags || ['æ„›å¿ƒåˆä½œåº—']
            };

            showRestaurantModal(store);
        });

        // âœ… è¨ˆç®—è·é›¢
        let distanceDisplay = 'ç„¡æ³•å–å¾—è·é›¢';
        if (currentPosition && store.latitude && store.longitude) {
            const distance = getDistance(currentPosition.lat, currentPosition.lng, store.latitude, store.longitude);
            if (distance < 1000) {
                distanceDisplay = `${Math.round(distance)} å…¬å°º`;
            } else {
                distanceDisplay = `${(distance / 1000).toFixed(1)} å…¬é‡Œ`;
            }
        }

        const tags = store.tags || ['æ„›å¿ƒåˆä½œåº—'];
        const tagHtml = tags.map(tag => `<small class="badge badge-info ml-1">${tag}</small>`).join('');

        const restaurantItem = document.createElement('a');
        restaurantItem.href = '#';
        restaurantItem.className = 'list-group-item list-group-item-action restaurant-item';
        restaurantItem.setAttribute('data-id', store.storeId);

        restaurantItem.innerHTML = `
            <div class="d-flex w-100 justify-content-between">
                <h6 class="mb-1">${store.name}</h6>
                <small>${distanceDisplay}</small>
            </div>
            <div class="restaurant-category mb-1">
                <small class="text-muted">${store.category || 'é¤é£²'}</small>
                ${tagHtml}
            </div>
            <small class="d-block">
                <div class="stars-outer d-inline-block" style="font-size: 0.8rem;">
                    <div class="stars-inner" style="width: ${((store.rating || 4.5) / 5) * 100}%"></div>
                </div>
                <span class="rating-value ml-1">${store.rating || 4.5}</span>
            </small>
        `;

        restaurantItem.addEventListener('click', function (e) {
            e.preventDefault();
            const marker = markers.find(m => m.storeId == store.id);
            if (marker) {
                google.maps.event.trigger(marker, 'click');
                map.setCenter(marker.getPosition());
                map.setZoom(16);
            } else {
                showRestaurantModal(store);
            }
        });

        restaurantsList.appendChild(restaurantItem);
    });

    if (markers.length > 0) {
        map.fitBounds(bounds);
        if (markers.length === 1) {
            google.maps.event.addListenerOnce(map, 'bounds_changed', function () {
                map.setZoom(16);
            });
        }
    }
}

    
    </script>

	<!-- Google Maps API -->
	<script async
		src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwk4bH6RdOWmqwmrpdYu7-NKZin0St0vQ&libraries=places&callback=initMap&region=TW&language=zh-TW">
    </script>

	<!-- åˆå§‹åŒ–åŠŸèƒ½ -->


	<script>
//ç•¶é é¢å®Œå…¨è¼‰å…¥å¾ŒåŸ·è¡Œ
$(document).ready(function() {
    // ä¿®æ”¹æœå°‹æŒ‰éˆ•é»æ“Šäº‹ä»¶ - çµåˆ Google Places API å’Œè³‡æ–™åº«æœå°‹
    $('.input-group-append .btn').click(function() {
        const searchText = $('#search-input').val().trim();
        if (!searchText) return;
        
        // é¦–å…ˆåœ¨æœ¬åœ°è³‡æ–™åº«ä¸­æœå°‹
        const localResults = fuzzySearchRestaurants(searchText);
        
        if (localResults.length > 0) {
            // å¦‚æœåœ¨æœ¬åœ°è³‡æ–™åº«ä¸­æ‰¾åˆ°çµæœï¼Œé¡¯ç¤ºé€™äº›çµæœ
            displaySearchResults(localResults);
        } else {
            // å¦‚æœæœ¬åœ°æ²’æœ‰æ‰¾åˆ°çµæœï¼Œä½¿ç”¨ Google Places API æœå°‹
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                const service = new google.maps.places.PlacesService(map);
                service.textSearch({
                    query: searchText,
                    location: currentPosition,
                    radius: 5000
                }, handlePlacesResult);
            }
        }
    });
    
    // ç›£è½æœå°‹è¼¸å…¥æ¡†çš„ Enter éµ
    $('#search-input').keypress(function(e) {
        if (e.which === 13) { // Enter éµçš„ keyCode
            $('.input-group-append .btn').click();
            e.preventDefault();
        }
    });
    
    // æ·»åŠ å´é‚Šæ¬„å°èˆªæŒ‰éˆ•é»æ“Šäº‹ä»¶ - æ”¹ç‚ºåœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè·¯ç·š
    $(document).on('click', '#restaurant-info .btn-primary', function() {
        if (selectRestaurant && selectRestaurant.location) {
            showRouteInMap(selectRestaurant.location, selectRestaurant.name);
        }
    });
    
   // æ·»åŠ é¤å»³é …ç›®é»æ“Šäº‹ä»¶è™•ç†
$(document).on('click', '.restaurant-item', function(e) {
    e.preventDefault();
    
    // ç¢ºä¿åœ°åœ–å·²åˆå§‹åŒ–
    if (!map) {
        console.error('åœ°åœ–å°šæœªåˆå§‹åŒ–');
        return;
    }
    
    // ç²å–é¤å»³ ID
    const restaurantId = $(this).data('id');
    
    // é¡¯ç¤ºåœ°åœ–è¼‰å…¥ä¸­ç‹€æ…‹
    console.log('æ­£åœ¨åŠ è¼‰é¤å»³ä½ç½®...');
    
    // æ‰¾åˆ°å°æ‡‰çš„æ¨™è¨˜ä¸¦è§¸ç™¼é»æ“Š
    const marker = markers.find(m => m.storeId == restaurantId);
    if (marker) {
        // ç¢ºä¿æ¨™è¨˜å¯è¦‹
        marker.setVisible(true);
        
        // ç§»å‹•åœ°åœ–è¦–è§’åˆ°æ¨™è¨˜ä½ç½®
        map.setCenter(marker.getPosition());
        map.setZoom(16);
        
        // è§¸ç™¼æ¨™è¨˜çš„é»æ“Šäº‹ä»¶
        google.maps.event.trigger(marker, 'click');
    } else {
        // å¦‚æœæ‰¾ä¸åˆ°æ¨™è¨˜ï¼Œç›´æ¥å¾storesæ•¸æ“šä¸­ç²å–é¤å»³ä¿¡æ¯
        const store = stores.find(s => s.storeId == restaurantId);
        if (store && store.latitude && store.longitude) {
            const storeLocation = { 
                lat: parseFloat(store.latitude), 
                lng: parseFloat(store.longitude) 
            };
            
            // ç§»å‹•åœ°åœ–åˆ°é¤å»³ä½ç½®
            map.setCenter(storeLocation);
            map.setZoom(16);
            
            // é¡¯ç¤ºé¤å»³ä¿¡æ¯
            showRestaurantModal(store);
        } else {
            console.error('æ‰¾ä¸åˆ°é¤å»³è³‡æ–™æˆ–ä½ç½®è³‡è¨Š');
        }
    }
});

    
    // ğŸ” è‡ªå‹•å®Œæˆå»ºè­° + é«˜äº®é—œéµå­— + åªé¡¯ç¤ºé¤å»³ä½ç½®ï¼ˆä¸å°èˆªï¼‰
    $('#search-input').on('input', function () {
        const keyword = $(this).val().trim().toLowerCase();
        const suggestionBox = $('#autocomplete-suggestions');
        suggestionBox.empty();
        
        if (keyword.length === 0) {
        	addRestaurantsList();         // æ¢å¾©å…¨éƒ¨é¤å»³
            addRestaurantMarkers();       // æ¢å¾©æ‰€æœ‰åœ°åœ–æ¨™è¨˜
            suggestionBox.hide();
            return;
        }
        
        const matched = stores.filter(store =>
            store.name.toLowerCase().includes(keyword) ||
            store.address.toLowerCase().includes(keyword)
        );
        
        if (matched.length === 0) {
            suggestionBox.hide();
            return;
        }
        
        matched.slice(0, 8).forEach(store => {
            // é«˜äº®é—œéµå­—
            const highlight = (text) => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                return text.replace(regex, '<b>$1</b>');
            };
            
            const suggestionItem = $(`
                <li class="list-group-item list-group-item-action">
                    ${highlight(store.name)} - ${highlight(store.address)}
                </li>
            `);
            
            suggestionItem.on('click', function() {
                // æ›´æ–°æœå°‹æ¡†å€¼ä¸¦éš±è—å»ºè­°æ¡†
                $('#search-input').val(store.name);
                suggestionBox.hide();
                
                console.log('é»æ“Šé¤å»³å»ºè­°:', store);
                
                // é¡¯ç¤ºæœå°‹çµæœ
                displaySearchResults([store]);
   
                
                // 1. æ¸…é™¤ä»»ä½•ç¾æœ‰è·¯ç·š
                if (directionsRenderer) {
                    directionsRenderer.setMap(null);
                }
                
                // 2. æ‰¾åˆ°å°æ‡‰çš„æ¨™è¨˜
                const storeId = store.id;
                const marker = markers.find(m => m.storeId == storeId);
                
                if (marker) {
                    console.log('æ‰¾åˆ°é¤å»³æ¨™è¨˜:', marker);
                    
                    // ç›´æ¥ä½¿ç”¨ç¾æœ‰æ¨™è¨˜
                    marker.setVisible(true);
                    map.setCenter(marker.getPosition());
                    map.setZoom(16);
                    
                    // è§¸ç™¼æ¨™è¨˜é»æ“Šäº‹ä»¶é¡¯ç¤ºä¿¡æ¯çª—å£
                    google.maps.event.trigger(marker, 'click');
                } else {
                    console.log('æœªæ‰¾åˆ°æ¨™è¨˜ï¼Œæ‰‹å‹•å‰µå»º:', store);
                    
                    // ç›´æ¥å¾åŸå§‹è³‡æ–™å‰µå»ºæ–°æ¨™è¨˜
                    try {
                        // å˜—è©¦ç²å–æœ‰æ•ˆåº§æ¨™
                        const validLat = parseFloat(store.latitude);
                        const validLng = parseFloat(store.longitude);
                        
                        if (isNaN(validLat) || isNaN(validLng)) {
                            console.error('é¤å»³åº§æ¨™ç„¡æ•ˆ:', store);
                            return;
                        }
                        
                        const position = {
                            lat: validLat,
                            lng: validLng
                        };
                        
                        console.log('å‰µå»ºæ–°æ¨™è¨˜æ–¼ä½ç½®:', position);
                        
                        // å‰µå»ºæ–°æ¨™è¨˜
                        if (window.tempMarker) {
                            window.tempMarker.setMap(null);
                        }
                        
                        window.tempMarker = new google.maps.Marker({
                            position: position,
                            map: map,
                            title: store.name,
                            icon: {
                                url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                                scaledSize: new google.maps.Size(36, 36)
                            },
                            animation: google.maps.Animation.DROP,
                            storeId: store.storeId || index  // æ”¹ç‚ºä½¿ç”¨storeId
                        });
                        
                        // å°‡æ¨™è¨˜æ·»åŠ åˆ°æ¨™è¨˜æ•¸çµ„
                        markers.push(window.tempMarker);
                        
                        // ç§»å‹•åœ°åœ–åˆ°æ¨™è¨˜ä½ç½®
                        map.setCenter(position);
                        map.setZoom(16);
                        
                        // å‰µå»ºä¿¡æ¯çª—å£
                        const infoContent = `
                            <div class="info-window">
                                <h3>${store.name}</h3>
                                <div><strong>åœ°å€ï¼š</strong>${store.address}</div>
                                <div><strong>é›»è©±ï¼š</strong>${store.phone || 'ç„¡é›»è©±è³‡è¨Š'}</div>
                                <div><strong>è©•åˆ†ï¼š</strong>${store.rating || 4.5} / 5</div>
                            </div>
                        `;
                        
                        // é¡¯ç¤ºä¿¡æ¯çª—å£
                        infowindow.setContent(infoContent);
                        infowindow.open(map, window.tempMarker);
                        
                        // æ›´æ–°é¤å»³ä¿¡æ¯é¢æ¿
                        selectRestaurant = {
                            name: store.name,
                            address: store.address,
                            phoneNumber: store.phone || '',
                            rating: store.rating || 4.5,
                            location: position,
                            id: store.storeId, 
                        };
                        
                        updateRestaurantInfo(selectRestaurant);
                    } catch (error) {
                        console.error('å‰µå»ºæ¨™è¨˜æ™‚å‡ºéŒ¯:', error);
                    }
                }
            });
            
            suggestionBox.append(suggestionItem);
        });
        
        suggestionBox.show();
    });
    
    // ğŸ” é»æ“Šå…¶ä»–åœ°æ–¹æ™‚éš±è—å»ºè­°æ¸…å–®
    $(document).on('click', function (e) {
        if (!$(e.target).closest('#search-input').length &&
            !$(e.target).closest('#autocomplete-suggestions').length) {
            $('#autocomplete-suggestions').hide();
        }
    });


    
});


</script>

	<!-- Contact Javascript File -->
	<script src="mail/jqBootstrapValidation.min.js"></script>
	<script src="mail/contact.js"></script>

	<!-- Template Javascript -->
	<script src="js/main.js"></script>
</body>
</html>