<!DOCTYPE html>
<html lang="zh-TW" xmlns:th="http://www.thymeleaf.org">
<head>
<meta charset="utf-8">
<title>æ”å‘·éœ¸ ALLiEAT - æ„›å¿ƒä»£ç”¨é¤å¹³å°</title>
<meta content="width=device-width, initial-scale=1.0" name="viewport">
<meta content="æ„›å¿ƒä»£ç”¨é¤, å…¬ç›Š, é¤é£²æè´ˆ" name="keywords">
<meta content="æ”å‘·éœ¸æ„›å¿ƒä»£ç”¨é¤å¹³å°ï¼Œé€£çµå–„å¿ƒäººå£«èˆ‡éœ€è¦æº«é£½çš„äºº" name="description">

<!-- Favicon -->
<link href="img/favicon.ico" rel="icon">

<!-- Google Font -->
<link rel="preconnect" href="https://fonts.gstatic.com">
<link
	href="https://fonts.googleapis.com/css2?family=Montserrat:wght@200;400&family=Roboto:wght@400;500;700&display=swap"
	rel="stylesheet">

<!-- Font Awesome -->
<link
	href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.10.0/css/all.min.css"
	rel="stylesheet">

<!-- Libraries Stylesheet -->
<link href="lib/owlcarousel/assets/owl.carousel.min.css"
	rel="stylesheet">
<link href="lib/tempusdominus/css/tempusdominus-bootstrap-4.min.css"
	rel="stylesheet" />
<link
	href="https://fonts.googleapis.com/css2?family=Satisfy&display=swap"
	rel="stylesheet">

<!-- Customized Bootstrap Stylesheet -->
<link rel="stylesheet" th:href="@{/css/style.css}" />

<!-- è©•åˆ†æ˜Ÿæ˜Ÿæ¨£å¼ -->
<style>
/* è©•åˆ†æ˜Ÿæ˜Ÿæ¨£å¼ */
.stars-outer {
	display: inline-block;
	position: relative;
	font-family: 'Font Awesome 5 Free';
	font-weight: 900;
}

.stars-outer::before {
	content: "\f005 \f005 \f005 \f005 \f005";
	color: #ccc;
}

.stars-inner {
	position: absolute;
	top: 0;
	left: 0;
	white-space: nowrap;
	overflow: hidden;
	width: 0;
}

.stars-inner::before {
	content: "\f005 \f005 \f005 \f005 \f005";
	color: #f8ce0b;
}

/* åœ°åœ–ä¿¡æ¯è¦–çª—æ¨£å¼ */
.gm-style .gm-style-iw {
	font-family: 'Roboto', sans-serif;
	padding: 15px;
}

.info-window {
	padding: 10px;
}

.info-window h3 {
	margin-top: 0;
	margin-bottom: 10px;
	color: #da9f5b;
}

.info-window div {
	margin-bottom: 5px;
}

/* æœå°‹æ¡†ç„¦é»æ¨£å¼ */
#search-input:focus {
	box-shadow: 0 0 0 0.2rem rgba(218, 159, 91, 0.25);
	border-color: #da9f5b;
}

.section-title::after {
	position: absolute;
	content: "";
	width: 100%;
	height: 0;
	top: 50%;
	left: 0;
	border-top: 2px dashed #bbb;
	z-index: -1;
}

.section-title {
	position: relative;
	display: inline-block;
	letter-spacing: 1px;
	color: #da9f5b;
	border-color: #da9f5b;
}

.section-title span {
	position: relative;
	background: #ffffff;
	padding: 0 10px;
}

/* é¤å»³åˆ—è¡¨æ¨£å¼ */
.restaurant-item {
	transition: all 0.2s ease;
	border-left: 3px solid transparent;
}

.restaurant-item:hover {
	border-left: 3px solid #da9f5b;
	background-color: rgba(218, 159, 91, 0.05);
}

.restaurant-category .badge {
	background-color: #da9f5b;
	font-weight: normal;
}

.location-item .badge {
	background-color: #da9f5b;
	font-weight: normal;
}

/* æœå°‹çµæœå€åŸŸæ¨£å¼ */
.nearby-restaurants {
	max-height: 300px;
	overflow-y: auto;
	padding-right: 5px;
}

.nearby-restaurants::-webkit-scrollbar {
	width: 5px;
}

.nearby-restaurants::-webkit-scrollbar-track {
	background: #f1f1f1;
	border-radius: 10px;
}

.nearby-restaurants::-webkit-scrollbar-thumb {
	background: #da9f5b;
	border-radius: 10px;
}

.nearby-restaurants::-webkit-scrollbar-thumb:hover {
	background: #c28a4a;
}

/* é¤å»³æ¨™ç±¤æ¨£å¼ */
.restaurant-tags {
	margin-top: 5px;
}

.restaurant-tags .tag {
	display: inline-block;
	padding: 2px 8px;
	margin-right: 5px;
	font-size: 0.7rem;
	border-radius: 10px;
	background-color: rgba(218, 159, 91, 0.2);
	color: #8b5a2b;
}

/* è¼‰å…¥å‹•ç•« */
.loading-spinner {
	display: inline-block;
	width: 1rem;
	height: 1rem;
	border: 2px solid rgba(218, 159, 91, 0.2);
	border-radius: 50%;
	border-top-color: #da9f5b;
	animation: spin 1s ease-in-out infinite;
}

keyframes spin {to { transform:rotate(360deg);
	
}

}

/* é¤å»³è©³æƒ…è¦–çª—æ¨£å¼ */
.restaurant-detail-modal .modal-header {
	background-color: #da9f5b;
	color: white;
}

.restaurant-detail-modal .close {
	color: white;
	opacity: 0.8;
}

.restaurant-detail-modal .close:hover {
	opacity: 1;
}

.restaurant-detail-modal .restaurant-amenities i {
	color: #da9f5b;
	margin-right: 5px;
}

/* é¤å»³è©³æƒ…è¦–çª—åº•éƒ¨æŒ‰éˆ•æ¨£å¼ */
.restaurant-detail-modal .modal-footer .btn-primary {
	background-color: #da9f5b;
	border-color: #da9f5b;
}

.restaurant-detail-modal .modal-footer .btn-primary:hover {
	background-color: #c28a4a;
	border-color: #c28a4a;
}

/* è¿”å›æŒ‰éˆ•æ¨£å¼ */
.back-to-restaurants {
	position: absolute;
	top: 10px;
	left: 10px;
	z-index: 1000;
	background-color: rgba(255, 255, 255, 0.9);
	border: 1px solid #da9f5b;
	color: #da9f5b;
	padding: 5px 12px;
	border-radius: 4px;
	font-size: 0.9rem;
	display: none;
	box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
}

.back-to-restaurants:hover {
	background-color: #da9f5b;
	color: white;
}

/* è·¯ç·šæŒ‡å¼•åˆ—è¡¨æ¨£å¼ */
.route-steps ol {
	padding-left: 20px;
	margin-top: 5px;
}

.route-steps li {
	margin-bottom: 8px;
	font-size: 0.9rem;
}

#autocomplete-suggestions {
	max-height: 250px;
	overflow-y: auto;
	border-radius: 0 0 10px 10px;
	box-shadow: 0 4px 8px rgba(0, 0, 0, 0.1);
}

#autocomplete-suggestions li {
	padding: 10px 15px;
	border-bottom: 1px solid #f1f1f1;
}

#autocomplete-suggestions li:hover {
	background-color: #f8f9fa;
	cursor: pointer;
	border-left: 3px solid #da9f5b;
}

#autocomplete-suggestions li:last-child {
	border-bottom: none;
	border-radius: 0 0 10px 10px;
}

.pac-container {
	display: none !important;
}
</style>
</head>

<body>
	<!-- Navbar Start -->
	<section id="header">
		<div class="container-fluid p-0 nav-bar">
			<nav class="navbar navbar-expand-lg bg-none navbar-dark py-3">
				<a href="index.html" class="navbar-brand px-lg-4 m-0">
					<h1 class="m-0 display-4 text-uppercase text-white"
						style="display: inline-block;">
						<img src="/img/logo3.png" width="80px" height="80px" alt=""
							style="vertical-align: middle; margin-right: 0px; margin-top: -10px; border-radius: 50%; object-fit: cover;">
						<span style="font-family: 'Satisfy', cursive;">ALLiEAT</span>
					</h1>
				</a>
				<button type="button" class="navbar-toggler" data-toggle="collapse"
					data-target="#navbarCollapse">
					<span class="navbar-toggler-icon"></span>
				</button>
				<div class="collapse navbar-collapse justify-content-between"
					id="navbarCollapse">
					<div class="navbar-nav ml-auto p-4">
						<a href="index.html" class="nav-item nav-link active">é—œæ–¼æˆ‘å€‘</a>
						<div class="nav-item dropdown">
							<a href="#" class="nav-link dropdown-toggle"
								data-toggle="dropdown">æˆ‘è¦ææ¬¾</a>
							<div class="dropdown-menu text-capitalize">
								<a href="reservation.html" class="dropdown-item">æˆ‘è¦ææ¬¾</a> <a
									href="testimonial.html" class="dropdown-item">ææ¬¾æŸ¥è©¢</a>
							</div>
						</div>
						<a href="service.html" class="nav-item nav-link">å—åŠ©è€…å–é¤</a>
						<div class="nav-item dropdown">
							<a href="#" class="nav-link dropdown-toggle"
								data-toggle="dropdown">è¨»å†Š/ç™»å…¥</a>
							<div class="dropdown-menu text-capitalize">
								<a href="reservation.html" class="dropdown-item">è¨»å†Š</a> <a
									href="testimonial.html" class="dropdown-item">ç™»å…¥</a>
							</div>
						</div>
						<a href="contact.html" class="nav-item nav-link">æœƒå“¡å°ˆå€</a>
					</div>
				</div>
			</nav>
		</div>
	</section>

	<!-- Hero Section Start -->
	<section id="hero">
		<div class="container-fluid p-0 mb-5">
			<div id="hero-carousel" class="carousel slide overlay-bottom"
				data-ride="carousel">
				<div class="carousel-inner">
					<div class="carousel-item active"
						style="background-image: url('img/åœ–ç‰‡3.png'); background-size: 110% auto; background-position: center -300px; height: 570px; filter: brightness(200%);">
						<div
							class="carousel-caption d-flex flex-column align-items-center justify-content-center">
							<h2 class="text-primary font-weight-medium m-0"></h2>
							<h1 class="display-1 text-white m-0"></h1>
							<h2 class="text-white m-0"></h2>
						</div>
					</div>
				</div>
			</div>
		</div>
	</section>
	<!-- Hero Section End -->

	<!-- ç¾åŒ–å¾Œçš„åœ°åœ–å€åŸŸ -->
	<div class="container-fluid py-5 bg-light">
		<div class="container">
			<div class="row mb-4">
				<div class="col-12 text-center">
					<h2 class="section-title text-uppercase mb-2">
						<span>å°‹æ‰¾æ„›å¿ƒé¤å»³</span>
					</h2>
					<p class="text-muted">æœå°‹æ‚¨é™„è¿‘çš„æ„›å¿ƒä»£ç”¨é¤åˆä½œé¤å»³</p>
				</div>
			</div>
			<div class="row">
				<div class="col-md-4 mb-4">
					<div class="card shadow-sm h-100">
						<div class="card-body">
							<h4 class="mb-3">æœå°‹é¤å»³</h4>
							<div class="input-group mb-4 position-relative">
								<input id="search-input" class="form-control"
									placeholder="è¼¸å…¥åœ°é»æˆ–é¤å»³åç¨±..."
									style="border-radius: 30px 0 0 30px; padding: 12px 20px; box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);">
								<div class="input-group-append">
									<button class="btn btn-primary"
										style="border-radius: 0 30px 30px 0;">
										<i class="fas fa-search"></i>
									</button>
								</div>
								<!-- ğŸ”½ è‡ªå‹•å®Œæˆæç¤º -->
								<ul id="autocomplete-suggestions"
									class="list-group position-absolute w-100"
									style="z-index: 1000; top: 100%; left: 0; display: none;"></ul>
							</div>

							<div id="restaurant-info" class="mt-4 d-none">
								<h5 class="restaurant-name font-weight-bold"></h5>
								<div class="restaurant-rating mb-2">
									<div class="stars-outer">
										<div class="stars-inner"></div>
									</div>
									<span class="rating-value ml-2"></span>
								</div>
								<p class="restaurant-address mb-1">
									<i class="fas fa-map-marker-alt mr-2 text-primary"></i> <span></span>
								</p>
								<p class="restaurant-phone mb-1">
									<i class="fas fa-phone mr-2 text-primary"></i> <span></span>
								</p>
								<p class="walking-time mb-3">
									<i class="fas fa-walking mr-2 text-primary"></i> <span></span>
								</p>
								<button class="btn btn-primary btn-block mt-3">å‰å¾€å°èˆª</button>
							</div>

							<!-- äº¤æ›é †åºï¼šå…ˆé¡¯ç¤ºæ„›å¿ƒåˆä½œé¤å»³å€å¡Š -->
							<div class="nearby-restaurants mt-4">
								<h5>é™„è¿‘æ„›å¿ƒåˆä½œé¤å»³</h5>
								<div class="list-group mt-3 restaurants-list">
									<!-- é¤å»³åˆ—è¡¨æœƒç”±JSå‹•æ…‹ç”Ÿæˆ -->
								</div>
							</div>

							<!-- äº¤æ›é †åºï¼šå†é¡¯ç¤ºç†±é–€åœ°é»å€å¡Š -->
							<div class="location-tips mt-4">
								<h5>é™„è¿‘ç†±é–€åœ°é»</h5>
								<div class="list-group mt-3">
									<!-- ç†±é–€åœ°é»æœƒç”±APIå‹•æ…‹ç”Ÿæˆ -->
									<div class="text-center py-2">
										<div class="loading-spinner"></div>
										<span class="ml-2">è¼‰å…¥ä¸­...</span>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="col-md-8 mb-4">
					<div class="card shadow-sm h-100">
						<div class="card-body p-0">
							<div id="map"
								style="width: 100%; height: 600px; border-radius: 5px;"></div>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<!-- é¤å»³è©³æƒ…æ¨¡æ…‹è¦–çª— -->
	<div class="modal fade restaurant-detail-modal"
		id="restaurantDetailModal" tabindex="-1" role="dialog"
		aria-labelledby="restaurantDetailModalLabel" aria-hidden="true">
		<div class="modal-dialog modal-lg" role="document">
			<div class="modal-content">
				<div class="modal-header">
					<h5 class="modal-title" id="restaurantDetailModalLabel">é¤å»³è©³æƒ…</h5>
					<button type="button" class="close" data-dismiss="modal"
						aria-label="Close">
						<span aria-hidden="true">&times;</span>
					</button>
				</div>
				<div class="modal-body">
					<div class="row">
						<div class="col-md-6">
							<img src="/api/placeholder/400/300" class="img-fluid rounded"
								alt="é¤å»³ç…§ç‰‡">
						</div>
						<div class="col-md-6">
							<h4 class="restaurant-name"></h4>
							<div class="restaurant-rating mb-2">
								<div class="stars-outer">
									<div class="stars-inner"></div>
								</div>
								<span class="rating-value ml-2"></span>
							</div>
							<p class="restaurant-address mb-1">
								<i class="fas fa-map-marker-alt mr-2 text-primary"></i> <span></span>
							</p>
							<p class="restaurant-phone mb-1">
								<i class="fas fa-phone mr-2 text-primary"></i> <span></span>
							</p>
							<p class="restaurant-category mb-1">
								<i class="fas fa-utensils mr-2 text-primary"></i> <span></span>
							</p>
							<div class="restaurant-tags mt-2">
								<!-- æ¨™ç±¤æœƒåœ¨é€™è£¡å‹•æ…‹ç”Ÿæˆ -->
							</div>
						</div>
					</div>

					<hr>

					<div class="row mt-3">
						<div class="col-12">
							<h5>æ„›å¿ƒä»£ç”¨é¤è¨Šæ¯</h5>
							<p>æœ¬é¤å»³æ˜¯ã€Œæ”å‘·éœ¸ ALLiEATã€æ„›å¿ƒä»£ç”¨é¤åˆä½œå¤¥ä¼´ï¼Œæ‚¨å¯ä»¥åœ¨æ­¤è™•ï¼š</p>
							<ul>
								<li>æè´ˆæ„›å¿ƒé¤é»çµ¦æœ‰éœ€è¦çš„äºº</li>
								<li>è‹¥æ‚¨æœ‰æ„›å¿ƒä»£ç”¨é¤åˆ¸ï¼Œå¯åœ¨æ­¤å…Œæ›é¤é»</li>
							</ul>
						</div>
					</div>

					<div class="row mt-3">
						<div class="col-12">
							<h5>é¤å»³è¨­æ–½</h5>
							<div class="restaurant-amenities row">
								<div class="col-md-4 mb-2">
									<i class="fas fa-wifi"></i> å…è²»WiFi
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-parking"></i> åœè»Šå ´
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-wheelchair"></i> ç„¡éšœç¤™è¨­æ–½
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-baby"></i> å…’ç«¥åº§æ¤…
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-credit-card"></i> åˆ·å¡æœå‹™
								</div>
								<div class="col-md-4 mb-2">
									<i class="fas fa-dog"></i> å¯µç‰©å‹å–„
								</div>
							</div>
						</div>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary"
						data-dismiss="modal">é—œé–‰</button>
					<button type="button" class="btn btn-primary">å‰å¾€å°èˆª</button>
				</div>
			</div>
		</div>
	</div>

	<!-- Footer Start -->
	<section id="footer">
		<div
			class="container-fluid footer text-white mt-5 pt-5 px-0 position-relative overlay-top">
			<div class="row mx-0 pt-5 px-sm-3 px-lg-5 mt-4">
				<div class="col-lg-3 col-md-6 mb-5">
					<h4 class="text-white text-uppercase mb-4"
						style="letter-spacing: 3px;">è¯çµ¡æˆ‘å€‘</h4>
					<p>
						<i class="fa fa-map-marker-alt mr-2"></i>å°åŒ—å¸‚æ„›ä½ å€æ„›ä½ ä¸€è·¯5255è™Ÿ
					</p>
					<p>
						<i class="fa fa-phone-alt mr-2"></i>02-2222-5252
					</p>
					<p class="m-0">
						<i class="fa fa-envelope mr-2"></i>allieat105@gmail.com
					</p>
				</div>
				<div class="col-lg-3 col-md-6 mb-5">
					<h4 class="text-white text-uppercase mb-4"
						style="letter-spacing: 3px;">é—œæ³¨æˆ‘å€‘</h4>
					<p>åœ¨é€™å€‹ä¸–ç•Œä¸Šï¼Œæœ‰äº›äººæ¯å¤©ç‚ºäº†æº«é£½è€ŒåŠªåŠ›ï¼Œè€Œä½ çš„ä¸€ä»½æ„›å¿ƒï¼Œå¯ä»¥æˆç‚ºä»–å€‘çš„ä¸€çµ²å¸Œæœ›ã€‚æ„›å¿ƒä»£ç”¨é¤æ˜¯ä¸€å€‹ç°¡å–®å»å……æ»¿æº«åº¦çš„å…¬ç›Šè¡Œå‹•ï¼Œè®“éœ€è¦å¹«åŠ©çš„äººèƒ½å¤ ç²å¾—ä¸€ä»½ç†±é¨°é¨°çš„é¤é»ï¼Œæ„Ÿå—ç¤¾æœƒçš„é—œæ‡·èˆ‡æ”¯æŒã€‚</p>
					<div class="d-flex justify-content-start">
						<a class="btn btn-lg btn-outline-light btn-lg-square mr-2"
							href="#"><i class="fab fa-twitter"></i></a> <a
							class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
							class="fab fa-facebook-f"></i></a> <a
							class="btn btn-lg btn-outline-light btn-lg-square mr-2" href="#"><i
							class="fab fa-linkedin-in"></i></a> <a
							class="btn btn-lg btn-outline-light btn-lg-square" href="#"><i
							class="fab fa-instagram"></i></a>
					</div>
				</div>
				<div class="col-lg-3 col-md-6 mb-5">
					<h4 class="text-white text-uppercase mb-4"
						style="letter-spacing: 3px;">å®¢æœæ™‚é–“</h4>
					<div>
						<h6 class="text-white text-uppercase">å‘¨ä¸€ - é€±äº”</h6>
						<p>æ—©ä¸Š10:00 - æ™šä¸Š21:00</p>
						<h6 class="text-white text-uppercase">é€±å…­ - é€±æ—¥</h6>
						<p>æ—©ä¸Š11:00 - æ™šä¸Š19:00</p>
					</div>
				</div>
				<div class="col-lg-3 col-md-6 mb-5">
					<h4 class="text-white text-uppercase mb-4"
						style="letter-spacing: 3px;">è¨‚é–±é›»å­å ±</h4>
					<p>è¨‚é–±æ„›å¿ƒä»£ç”¨é¤é›»å­å ±ï¼Œç²å–æœ€æ–°æ„›å¿ƒè¨ˆç•«ã€æ–°å¢åˆä½œåº—å®¶èˆ‡å…¬ç›Šæ´»å‹•è³‡è¨Šï¼Œè®“æº«æš–æŒçºŒå‚³éï¼</p>
					<div class="w-100">
						<div class="input-group">
							<input type="text" class="form-control border-light"
								style="padding: 25px;" placeholder="è¼¸å…¥æ‚¨çš„ä¿¡ç®±">
							<div class="input-group-append">
								<button class="btn btn-primary font-weight-bold px-3">ç«‹å³è¨‚é–±</button>
							</div>
						</div>
					</div>
				</div>
			</div>
			<div
				class="container-fluid text-center text-white  mt-4 py-4 px-sm-3 px-md-5"
				style="border-color: rgba(256, 256, 256, .1) !important;">
				<p class="mb-2 text-white">
					ç‰ˆæ¬Šæ‰€æœ‰ &copy; <a class="font-weight-bold" href="#">æ”å‘·éœ¸è‚¡ä»½æœ‰é™å…¬å¸</a>.
					ä¿ç•™æ‰€æœ‰æ¬Šåˆ©
				</p>
				<p class="m-0 text-white">
					ç¶²ç«™è¨­è¨ˆç”± <a class="font-weight-bold" href="https://htmlcodex.com">æ”å‘·éœ¸è‚¡ä»½æœ‰é™å…¬å¸
						è¨­è¨ˆéƒ¨ è¨­è¨ˆ</a>
				</p>
			</div>
		</div>
	</section>
	<!-- Footer End -->

	<!-- Back to Top -->
	<a href="#" class="btn btn-lg btn-primary btn-lg-square back-to-top"><i
		class="fa fa-angle-double-up"></i></a>

	<!-- å°‡å¾Œç«¯çš„ storeList å‚³åˆ°å‰ç«¯è®Šæˆ JS è®Šæ•¸ -->
	<script th:inline="javascript">
    /*<![CDATA[*/
    const stores = /*[[${storeList}]]*/ [];
    /*]]>*/
</script>

	<!-- JavaScript Libraries -->
	<script src="https://code.jquery.com/jquery-3.4.1.min.js"></script>
	<script
		src="https://stackpath.bootstrapcdn.com/bootstrap/4.4.1/js/bootstrap.bundle.min.js"></script>
	<script src="lib/easing/easing.min.js"></script>
	<script src="lib/waypoints/waypoints.min.js"></script>
	<script src="lib/owlcarousel/owl.carousel.min.js"></script>
	<script src="lib/tempusdominus/js/moment.min.js"></script>
	<script src="lib/tempusdominus/js/moment-timezone.min.js"></script>
	<script src="lib/tempusdominus/js/tempusdominus-bootstrap-4.min.js"></script>

	<!-- åœ°åœ–ç›¸é—œè…³æœ¬ -->
	<script>
    // æ•´åˆåœ°åœ–JavaScript
    let map;
    let currentPosition;
    let selectRestaurant;
    let marker;
    let autocomplete;
    let directionsService;
    let directionsRenderer;
    let infowindow;
    let markers = []; // å­˜å„²æ‰€æœ‰æ¨™è¨˜
    let userMarker; // ç”¨æˆ¶ä½ç½®æ¨™è¨˜
    
    // æ¨¡æ“¬ API ç²å–ç†±é–€åœ°é»æ•¸æ“šï¼ˆå¯¦éš›ä½¿ç”¨æ™‚æ›¿æ›ç‚ºçœŸå¯¦ APIï¼‰
    const restaurantApi = {
        getPopularLocations: function() {
            // è¿”å›ç†±é–€åœ°é»
            return [
                { name: "å°åŒ—è»Šç«™", count: 12 },
                { name: "å°å¤§é†«é™¢", count: 8 },
                { name: "è¥¿é–€ç”º", count: 15 },
                { name: "æ±å€", count: 10 },
                { name: "ä¿¡ç¾©å€", count: 14 }
            ];
        }
    };

    function initMap() {
        // åˆå§‹åŒ–åœ°åœ–
        map = new google.maps.Map(document.getElementById('map'), {
            center: { lat: 25.033, lng: 121.565 },
            zoom: 14,
            styles: [
                {
                    "featureType": "administrative",
                    "elementType": "labels.text.fill",
                    "stylers": [{"color": "#444444"}]
                },
                {
                    "featureType": "landscape",
                    "elementType": "all",
                    "stylers": [{"color": "#f2f2f2"}]
                },
                {
                    "featureType": "poi",
                    "elementType": "all",
                    "stylers": [{"visibility": "off"}]
                },
                {
                    "featureType": "poi.business",
                    "elementType": "geometry.fill",
                    "stylers": [{"visibility": "on"}]
                },
                {
                    "featureType": "road",
                    "elementType": "all",
                    "stylers": [{"saturation": -100}, {"lightness": 45}]
                },
                {
                    "featureType": "road.highway",
                    "elementType": "all",
                    "stylers": [{"visibility": "simplified"}]
                },
                {
                    "featureType": "road.arterial",
                    "elementType": "labels.icon",
                    "stylers": [{"visibility": "off"}]
                },
                {
                    "featureType": "transit",
                    "elementType": "all",
                    "stylers": [{"visibility": "on"}]
                },
                {
                    "featureType": "water",
                    "elementType": "all",
                    "stylers": [{"color": "#b4d4e1"}, {"visibility": "on"}]
                }
            ],
            mapTypeControl: false,
            streetViewControl: false,
            fullscreenControl: true,
            zoomControl: true
        });

        // åˆå§‹åŒ–å°èˆªæœå‹™
        directionsService = new google.maps.DirectionsService();
        directionsRenderer = new google.maps.DirectionsRenderer({
            map: map,
            suppressMarkers: true,
            polylineOptions: {
                strokeColor: '#da9f5b',
                strokeWeight: 5,
                strokeOpacity: 0.7
            }
        });
        
        // åˆå§‹åŒ–ä¿¡æ¯çª—å£
        infowindow = new google.maps.InfoWindow({
            maxWidth: 300,
            pixelOffset: new google.maps.Size(0, -30)
        });

        // ç²å–ç”¨æˆ¶ä½ç½®
        if (navigator.geolocation) {
            navigator.geolocation.getCurrentPosition(function(position) {
                currentPosition = {
                    lat: position.coords.latitude,
                    lng: position.coords.longitude
                };
                
                // ç”¨æˆ¶ä½ç½®æ¨™è¨˜
                userMarker = new google.maps.Marker({
                    position: currentPosition,
                    map: map,
                    icon: {
                        path: google.maps.SymbolPath.CIRCLE,
                        scale: 10,
                        fillColor: "#4285F4",
                        fillOpacity: 1,
                        strokeColor: "white",
                        strokeWeight: 2
                    },
                    title: "æ‚¨çš„ä½ç½®",
                    zIndex: 999
                });
                
                // è¨­ç½®æœå°‹ç¯„åœ
                map.setCenter(currentPosition);
                
                // åˆå§‹åŒ–è‡ªå‹•å®Œæˆ
                autocomplete = new google.maps.places.Autocomplete(
                    document.getElementById('search-input'),
                    {
                        types: ['restaurant', 'food'],
                        componentRestrictions: { country: 'tw' }
                    }
                );
                
                // å¾ Thymeleaf ç²å–æ•¸æ“šä¸¦æ·»åŠ æ¨™è¨˜
                addRestaurantMarkers();
                
                // ç›£è½è‡ªå‹•å®Œæˆ
                autocomplete.addListener('place_changed', onPlaceChanged);
                
                // æ›´æ–°å´é‚Šæ¬„
                updateSidebar();
                
            }, function() {
                handleLocationError(true, map.getCenter());
            });
        } else {
            handleLocationError(false, map.getCenter());
        }
    }

    function handleLocationError(browserHasGeolocation, pos) {
        // å®šä½éŒ¯èª¤è™•ç†
        alert(browserHasGeolocation ?
            'ç„¡æ³•å–å¾—æ‚¨çš„ä½ç½®ã€‚è«‹ç¢ºèªä½ç½®æ¬Šé™å·²é–‹å•Ÿã€‚' :
            'æ‚¨çš„ç€è¦½å™¨ä¸æ”¯æ´å®šä½åŠŸèƒ½ã€‚');
        
        // é è¨­ä½ç½®è¨­ç‚ºå°åŒ—è»Šç«™
        currentPosition = { lat: 25.047924, lng: 121.517081 };
        map.setCenter(currentPosition);
        
        // åˆå§‹åŒ–å…¶ä»–åŠŸèƒ½
        autocomplete = new google.maps.places.Autocomplete(
            document.getElementById('search-input')
        );
        autocomplete.addListener('place_changed', onPlaceChanged);
        
        // æ·»åŠ é¤å»³æ¨™è¨˜
        addRestaurantMarkers();
        
        // æ›´æ–°å´é‚Šæ¬„
        updateSidebar();
    }

    function onPlaceChanged() {
        const place = autocomplete.getPlace();
        
        if (!place.geometry || !place.geometry.location) {
            alert("æ‰¾ä¸åˆ°è©²åœ°é»çš„è©³ç´°è³‡è¨Šï¼Œè«‹é¸æ“‡æœå°‹çµæœä¸­çš„é¤å»³ã€‚");
            return;
        }
        
        selectRestaurant = {
            location: {
                lat: place.geometry.location.lat(),
                lng: place.geometry.location.lng()
            },
            placeId: place.place_id,
            name: place.name,
            address: place.formatted_address || "ç„¡åœ°å€è³‡è¨Š",
            phoneNumber: place.formatted_phone_number || "ç„¡é›»è©±è³‡è¨Š",
            rating: place.rating || "å°šæœªè©•åˆ†"
        };
        
        // æ›´æ–°åœ°åœ–
        map.setCenter(selectRestaurant.location);
        map.setZoom(17);
        
        // æ›´æ–°æ¨™è¨˜
        if (marker) marker.setMap(null);
        marker = new google.maps.Marker({
            map: map,
            position: selectRestaurant.location,
            animation: google.maps.Animation.DROP,
            icon: {
                url: 'https://maps.google.com/mapfiles/ms/icons/red-dot.png',
                scaledSize: new google.maps.Size(40, 40)
            },
            title: selectRestaurant.name
        });
        
        // æ›´æ–°å´é‚Šæ¬„è³‡è¨Š
        updateRestaurantInfo(selectRestaurant);
        
        // é¡¯ç¤ºä¿¡æ¯çª—å£
        const content = `
            <div class="info-window">
                <h3>${selectRestaurant.name}</h3>
                <div><strong>åœ°å€ï¼š</strong>${selectRestaurant.address}</div>
                <div><strong>é›»è©±ï¼š</strong>${selectRestaurant.phoneNumber}</div>
                <div><strong>è©•åˆ†ï¼š</strong>${selectRestaurant.rating} / 5</div>
                <div class="mt-2 text-center">
                    <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap(${selectRestaurant.location.lat}, ${selectRestaurant.location.lng}, '${selectRestaurant.name}')">
                        <i class="fas fa-route mr-1"></i>é¡¯ç¤ºè·¯ç·š
                    </button>
                </div>
            </div>
        `;
        
        infowindow.setContent(content);
        infowindow.open(map, marker);
    }

    function updateRestaurantInfo(restaurant) {
        const infoDiv = document.getElementById('restaurant-info');
        infoDiv.classList.remove('d-none');
        
        // æ›´æ–°é¤å»³åç¨±
        infoDiv.querySelector('.restaurant-name').textContent = restaurant.name;
        
        // æ›´æ–°è©•åˆ†æ˜Ÿæ˜Ÿ
        const starsInner = infoDiv.querySelector('.stars-inner');
        const starPercentage = (restaurant.rating / 5) * 100;
        starsInner.style.width = `${starPercentage}%`;
        infoDiv.querySelector('.rating-value').textContent = `${restaurant.rating} / 5`;
        
        // æ›´æ–°åœ°å€èˆ‡é›»è©±
        infoDiv.querySelector('.restaurant-address span').textContent = restaurant.address;
        infoDiv.querySelector('.restaurant-phone span').textContent = restaurant.phoneNumber || restaurant.phone;
        
        // æ›´æ–°æ­¥è¡Œæ™‚é–“
        if (restaurant.duration) {
            infoDiv.querySelector('.walking-time span').textContent = restaurant.duration;
        } else {
            infoDiv.querySelector('.walking-time span').textContent = "è¨ˆç®—ä¸­...";
            // è¨ˆç®—æ­¥è¡Œæ™‚é–“
            if (currentPosition && restaurant.location) {
                directionsService.route({
                    origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
                    destination: new google.maps.LatLng(restaurant.location.lat, restaurant.location.lng),
                    travelMode: 'WALKING'
                }, function(response, status) {
                    if (status === 'OK') {
                        const leg = response.routes[0].legs[0];
                        infoDiv.querySelector('.walking-time span').textContent = leg.duration.text;
                        restaurant.duration = leg.duration.text;
                    }
                });
            }
        }
        
        // æ›´æ–°å°èˆªæŒ‰éˆ•äº‹ä»¶ - åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè·¯ç·š
        const navButton = infoDiv.querySelector('.btn-primary');
        navButton.onclick = function() {
            if (restaurant.location) {
                showRouteInMap(restaurant.location, restaurant.name);
            }
        };
    }

    // æ·»åŠ é¤å»³æ¨™è¨˜ - ä½¿ç”¨å¾ Thymeleaf ç²å–çš„æ•¸æ“š
    function addRestaurantMarkers() {
        // æ¸…é™¤ç¾æœ‰æ¨™è¨˜
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        
        // ä½¿ç”¨å¾Œç«¯æä¾›çš„é¤å»³æ•¸æ“š
        if (typeof stores !== 'undefined' && stores.length > 0) {
            stores.forEach((store, index) => {
                // å°‡å¾Œç«¯æ•¸æ“šè½‰æ›ç‚ºåœ°åœ–æ‰€éœ€æ ¼å¼
                const storeLocation = { 
                    lat: store.latitude,
                    lng: store.longitude
                };
                
                const marker = new google.maps.Marker({
                    position: storeLocation,
                    map: map,
                    title: store.name,
                    animation: google.maps.Animation.DROP,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                        scaledSize: new google.maps.Size(36, 36)
                    },
                    label: {
                        text: store.name,
                        color: '#000',
                        fontSize: '12px',
                        fontWeight: 'bold'
                    },
                    storeId: store.id || index
                });
                
                markers.push(marker);
                
                // é»æ“Šæ¨™è¨˜æ™‚é¡¯ç¤ºä¿¡æ¯
                marker.addListener('click', function() {
                    selectRestaurant = {
                        name: store.name,
                        address: store.address,
                        phoneNumber: store.phone,
                        rating: store.rating || 4.5,
                        location: storeLocation,
                        id: store.id,
                        category: store.category || 'é¤é£²',
                        tags: store.tags || ['æ„›å¿ƒåˆä½œåº—']
                    };
                    
                    // ä¿¡æ¯çª—å£å…§å®¹
                    const infoContent = `
                        <div class="info-window">
                            <h3>${store.name}</h3>
                            <div><strong>åœ°å€ï¼š</strong>${store.address}</div>
                            <div><strong>é›»è©±ï¼š</strong>${store.phone}</div>
                            <div><strong>è©•åˆ†ï¼š</strong>${store.rating || 4.5} / 5</div>
                            <div><strong>æ„›å¿ƒä»£ç”¨é¤åˆä½œé¤å»³</strong></div>
                            <div class="mt-2 text-center">
                                <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap({lat: ${storeLocation.lat}, lng: ${storeLocation.lng}}, '${store.name}')">
                                    <i class="fas fa-route mr-1"></i>é¡¯ç¤ºè·¯ç·š
                                </button>
                            </div>
                        </div>
                    `;
                    
                    infowindow.setContent(infoContent);
                    infowindow.open(map, marker);
                    
                    // æ›´æ–°å´æ¬„ä¿¡æ¯
                    updateRestaurantInfo(selectRestaurant);
                });
            });
        } else {
            console.error('æ²’æœ‰å¯ç”¨çš„é¤å»³æ•¸æ“š');
        }
    }

    function handlePlacesResult(results, status) {
        if (status === google.maps.places.PlacesServiceStatus.OK && results.length > 0) {
            const place = results[0];
            
            selectRestaurant = {
                location: {
                    lat: place.geometry.location.lat(),
                    lng: place.geometry.location.lng()
                },
                placeId: place.place_id,
                name: place.name,
                address: place.formatted_address || "ç„¡åœ°å€è³‡è¨Š",
                phoneNumber: "02-XXXX-XXXX", // la4æ¨¡æ“¬é›»è©±
                rating: place.rating || "å°šæœªè©•åˆ†"
            };
            
            // æ›´æ–°åœ°åœ–
            map.setCenter(selectRestaurant.location);
            map.setZoom(17);
            
            // æ›´æ–°æ¨™è¨˜
            if (marker) marker.setMap(null);
            marker = new google.maps.Marker({
                map: map,
                position: selectRestaurant.location,
                animation: google.maps.Animation.DROP
            });
            
            // æ›´æ–°å´é‚Šæ¬„è³‡è¨Š
            updateRestaurantInfo(selectRestaurant);
            
            // å‰µå»ºä¿¡æ¯çª—å£
            const infoContent = `
                <div class="info-window">
                    <h3>${selectRestaurant.name}</h3>
                    <div><strong>åœ°å€ï¼š</strong>${selectRestaurant.address}</div>
                    <div><strong>é›»è©±ï¼š</strong>${selectRestaurant.phoneNumber}</div>
                    <div><strong>è©•åˆ†ï¼š</strong>${selectRestaurant.rating} / 5</div>
                    <div class="mt-2 text-center">
                        <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap({lat: ${selectRestaurant.location.lat}, lng: ${selectRestaurant.location.lng}}, '${selectRestaurant.name}')">
                            <i class="fas fa-route mr-1"></i>é¡¯ç¤ºè·¯ç·š
                        </button>
                    </div>
                </div>
            `;
            
            infowindow.setContent(infoContent);
            infowindow.open(map, marker);
        } else {
            alert("æ‰¾ä¸åˆ°ç›¸é—œé¤å»³");
        }
    }
    
    // æ›´æ–°å´é‚Šæ¬„
    function updateSidebar() {
        // å…ˆæ·»åŠ é¤å»³åˆ—è¡¨å€åŸŸ (ä¿®æ”¹é †åº)
        addRestaurantsList();
        
        // å¾Œæ›´æ–°ç†±é–€åœ°é»å€åŸŸ (ä¿®æ”¹é †åº)
        updatePopularLocations();
    }

    // æ›´æ–°ç†±é–€åœ°é»å€åŸŸ
    function updatePopularLocations() {
        const popularLocations = restaurantApi.getPopularLocations();
        const locationContainer = document.querySelector('.location-tips .list-group');
        
        // æ¸…é™¤ç¾æœ‰é …ç›®
        locationContainer.innerHTML = '';
        
        // æ·»åŠ æ–°é …ç›®
        popularLocations.forEach(location => {
            const locationItem = document.createElement('a');
            locationItem.href = '#';
            locationItem.className = 'list-group-item list-group-item-action location-item';
            locationItem.setAttribute('data-name', location.name);
            locationItem.innerHTML = `
                <i class="fas fa-utensils mr-2 text-primary"></i>
                ${location.name} <span class="badge badge-pill badge-primary">${location.count}</span>
            `;
            
            // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
            locationItem.addEventListener('click', function(e) {
                e.preventDefault();
                document.getElementById('search-input').value = this.getAttribute('data-name');
                
                // è§¸ç™¼æœå°‹
                const service = new google.maps.places.PlacesService(map);
                service.textSearch({
                    query: this.getAttribute('data-name') + " é¤å»³",
                    location: currentPosition,
                    radius: 5000
                }, handlePlacesResult);
            });
            
            locationContainer.appendChild(locationItem);
        });
    }

    // æ·»åŠ é¤å»³åˆ—è¡¨å€åŸŸ
    function addRestaurantsList() {
        // é¤å»³åˆ—è¡¨å€åŸŸå·²ç¶“åœ¨HTMLä¸­é å…ˆå‰µå»ºï¼Œä¸éœ€è¦é‡æ–°å‰µå»º
        
        // æ·»åŠ é¤å»³åˆ—è¡¨é …ç›®
        const restaurantsList = document.querySelector('.restaurants-list');
        restaurantsList.innerHTML = '';
        
        if (typeof stores !== 'undefined' && stores.length > 0) {
            // ä½¿ç”¨å¾Œç«¯æä¾›çš„é¤å»³æ•¸æ“š
            stores.forEach(store => {
                const restaurantItem = document.createElement('a');
                restaurantItem.href = '#';
                restaurantItem.className = 'list-group-item list-group-item-action restaurant-item';
                restaurantItem.setAttribute('data-id', store.id);
                
                // è¨ˆç®—æ¨™ç±¤
                const tags = store.tags || ['æ„›å¿ƒåˆä½œåº—'];
                const tagHtml = tags.map(tag => `<small class="badge badge-info ml-1">${tag}</small>`).join('');
                
                restaurantItem.innerHTML = `
                    <div class="d-flex w-100 justify-content-between">
                        <h6 class="mb-1">${store.name}</h6>
                        <small>${store.distance || 'é™„è¿‘'}</small>
                    </div>
                    <div class="restaurant-category mb-1">
                        <small class="text-muted">${store.category || 'é¤é£²'}</small>
                        ${tagHtml}
                    </div>
                    <small class="d-block">
                        <div class="stars-outer d-inline-block" style="font-size: 0.8rem;">
                            <div class="stars-inner" style="width: ${((store.rating || 4.5) / 5) * 100}%"></div>
                        </div>
                        <span class="rating-value ml-1">${store.rating || 4.5}</span>
                    </small>
                `;
                
                // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
                restaurantItem.addEventListener('click', function(e) {
                    e.preventDefault();
                    
                    // åœ¨åœ°åœ–ä¸Šæ‰¾åˆ°ç›¸æ‡‰çš„æ¨™è¨˜
                    const marker = markers.find(m => m.storeId == store.id);
                    if (marker) {
                        // è§¸ç™¼æ¨™è¨˜çš„é»æ“Šäº‹ä»¶
                        google.maps.event.trigger(marker, 'click');
                    } else {
                        // æˆ–è€…ç›´æ¥é¡¯ç¤ºé¤å»³ä¿¡æ¯
                        showRestaurantModal(store);
                    }
                });
                
                restaurantsList.appendChild(restaurantItem);
            });
        } else {
            restaurantsList.innerHTML = '<p class="text-center">æ²’æœ‰å¯ç”¨çš„é¤å»³æ•¸æ“š</p>';
        }
    }

    // é¤å»³è©³æƒ…æ¨¡æ…‹è¦–çª—
    function showRestaurantModal(restaurant) {
        const modal = $('#restaurantDetailModal');
        
        // è¨­ç½®é¤å»³è³‡è¨Š
        modal.find('.restaurant-name').text(restaurant.name);
        
        // è¨­ç½®è©•åˆ†
        const starsInner = modal.find('.stars-inner');
        const starPercentage = ((restaurant.rating || 4.5) / 5) * 100;
        starsInner.css('width', `${starPercentage}%`);
        modal.find('.rating-value').text(`${restaurant.rating || 4.5} / 5`);
        
        // è¨­ç½®åœ°å€ã€é›»è©±ã€é¡åˆ¥
        modal.find('.restaurant-address span').text(restaurant.address);
        modal.find('.restaurant-phone span').text(restaurant.phone || restaurant.phoneNumber);
        modal.find('.restaurant-category span').text(restaurant.category || 'ä¸€èˆ¬é¤é£²');
        
        // è¨­ç½®æ¨™ç±¤
        const tagsContainer = modal.find('.restaurant-tags');
        tagsContainer.empty();
        
        const tags = restaurant.tags || ['æ„›å¿ƒåˆä½œåº—'];
        tags.forEach(tag => {
            tagsContainer.append(`<span class="tag">${tag}</span>`);
        });
        
        // é¡¯ç¤ºæ¨¡æ…‹è¦–çª—
        modal.modal('show');
        
        // è¨­ç½®å°èˆªæŒ‰éˆ•äº‹ä»¶ - æ”¹ç‚ºåœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè·¯ç·š
        modal.find('.modal-footer .btn-primary').off('click').on('click', function() {
            // é—œé–‰æ¨¡æ…‹è¦–çª—
            modal.modal('hide');
            
            // å¦‚æœæœ‰ç¶“ç·¯åº¦ï¼Œä½¿ç”¨ç¶“ç·¯åº¦é¡¯ç¤ºè·¯ç·š
            if (restaurant.latitude && restaurant.longitude) {
                const destination = {
                    lat: parseFloat(restaurant.latitude),
                    lng: parseFloat(restaurant.longitude)
                };
                showRouteInMap(destination, restaurant.name);
            } else {
                // å¦‚æœæ²’æœ‰ç¶“ç·¯åº¦ï¼Œä½¿ç”¨åœ°å€è½‰æ›ç‚ºç¶“ç·¯åº¦
                const geocoder = new google.maps.Geocoder();
                geocoder.geocode({ 'address': restaurant.address }, function(results, status) {
                    if (status === 'OK' && results[0].geometry) {
                        const destination = {
                            lat: results[0].geometry.location.lat(),
                            lng: results[0].geometry.location.lng()
                        };
                        showRouteInMap(destination, restaurant.name);
                    } else {
                        alert('ç„¡æ³•æ‰¾åˆ°è©²åœ°å€çš„ä½ç½®ï¼š' + restaurant.address);
                    }
                });
            }
        });
    }

    // æ ¼å¼åŒ–è·¯ç·šæŒ‡å¼•æ–‡å­—
    function formatInstructions(instruction) {
        // ç§»é™¤HTMLæ¨™ç±¤ä½†ä¿ç•™æ–‡å­—
        const div = document.createElement('div');
        div.innerHTML = instruction;
        let text = div.textContent || div.innerText || '';
        
        // å¦‚æœæœ‰è·é›¢è³‡è¨Šï¼Œä¿ç•™è·é›¢ä½†ç°¡åŒ–æ ¼å¼
        const distanceMatch = instruction.match(/(\d+)\s*(å…¬å°º|ç±³|m|km|å…¬é‡Œ)/i);
        if (distanceMatch) {
            const distance = distanceMatch[0];
            text = text.replace(/å‘(æ±|å—|è¥¿|åŒ—|æ±åŒ—|æ±å—|è¥¿å—|è¥¿åŒ—)èµ°/, 'å‘$1èµ° ' + distance);
        }
        
        // ç°¡åŒ–å¸¸è¦‹æŒ‡å¼•
        text = text.replace('ç¹¼çºŒç›´è¡Œ', 'ç›´è¡Œ')
               .replace('è¼•å¾®å‘å³è½‰', 'ç¨å¾®å³è½‰')
               .replace('è¼•å¾®å‘å·¦è½‰', 'ç¨å¾®å·¦è½‰')
               .replace('ç›®çš„åœ°åœ¨', 'åˆ°é”');
        
        return text;
    }

    // åœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè·¯ç·šå°èˆª
    function showRouteInMap(destination, destinationName) {
        // æª¢æŸ¥æ˜¯å¦æœ‰ç”¨æˆ¶ä½ç½®
        if (!currentPosition) {
            alert('è«‹å…ˆå…è¨±ç²å–æ‚¨çš„ä½ç½®ï¼Œä»¥ä¾¿è¦åŠƒè·¯ç·š');
            return;
        }
        
        // é¡¯ç¤ºè¿”å›æŒ‰éˆ•
        const backButton = document.getElementById('back-to-restaurants');
        if (backButton) {
            backButton.style.display = 'block';
        } else {
            // å‰µå»ºè¿”å›æŒ‰éˆ•
            const btn = document.createElement('button');
            btn.id = 'back-to-restaurants';
            btn.className = 'back-to-restaurants';
            btn.innerHTML = '<i class="fas fa-arrow-left mr-2"></i>è¿”å›é¤å»³åˆ—è¡¨';
            btn.onclick = function() {
                // æ¸…é™¤è·¯ç·š
                directionsRenderer.set('directions', null);
                
                // éš±è—è¿”å›æŒ‰éˆ•
                this.style.display = 'none';
                
                // é‡æ–°é¡¯ç¤ºæ‰€æœ‰é¤å»³æ¨™è¨˜
                markers.forEach(marker => marker.setVisible(true));
                
                // é—œé–‰ä¿¡æ¯çª—å£
                infowindow.close();
                
                // é¡¯ç¤ºæ‰€æœ‰é¤å»³
                showAllRestaurants();
            };
            document.getElementById('map').parentNode.appendChild(btn);
        }
        
        // éš±è—æ‰€æœ‰é¤å»³æ¨™è¨˜
        markers.forEach(marker => marker.setVisible(false));
        
        // è¦åŠƒè·¯ç·š
        directionsService.route({
            origin: new google.maps.LatLng(currentPosition.lat, currentPosition.lng),
            destination: new google.maps.LatLng(destination.lat, destination.lng),
            travelMode: 'WALKING',
            provideRouteAlternatives: false,
            avoidHighways: true,
            avoidTolls: true
        }, function(response, status) {
            if (status === 'OK') {
                // è¨­ç½®è·¯ç·šæ¸²æŸ“å™¨é¸é …
                directionsRenderer.setOptions({
                    directions: response,
                    suppressMarkers: true, // éš±è—é»˜èªæ¨™è¨˜
                    polylineOptions: {
                        strokeColor: '#da9f5b',
                        strokeWeight: 5,
                        strokeOpacity: 0.7
                    }
                });
                
                // ç²å–è·¯ç·šè©³æƒ…
                const leg = response.routes[0].legs[0];
                
                // æ ¼å¼åŒ–è·¯ç·šæŒ‡å¼•æ­¥é©Ÿ
                const formattedSteps = leg.steps.map(step => {
                    return `<li>${formatInstructions(step.instructions)}</li>`;
                }).join('');
                
                // å‰µå»ºè·¯ç·šè©³æƒ…ä¿¡æ¯çª—å£
                const routeInfo = `
                    <div class="info-window">
                        <h3>å‰å¾€ ${destinationName}</h3>
                        <div><strong><i class="fas fa-map-marker-alt mr-2 text-primary"></i>èµ·é»ï¼š</strong>${leg.start_address}</div>
                        <div><strong><i class="fas fa-flag-checkered mr-2 text-danger"></i>çµ‚é»ï¼š</strong>${leg.end_address}</div>
                        <div><strong><i class="fas fa-route mr-2 text-success"></i>è·é›¢ï¼š</strong>${leg.distance.text}</div>
                        <div><strong><i class="fas fa-walking mr-2 text-info"></i>æ­¥è¡Œæ™‚é–“ï¼š</strong>${leg.duration.text}</div>
                        <div class="route-steps mt-2">
                            <strong><i class="fas fa-directions mr-2"></i>è·¯ç·šæŒ‡å¼•ï¼š</strong>
                            <ol class="mt-1">
                                ${formattedSteps}
                            </ol>
                        </div>
                    </div>
                `;
                
                // é¡¯ç¤ºè·¯ç·šè©³æƒ…
                infowindow.setContent(routeInfo);
                infowindow.setPosition(destination);
                infowindow.open(map);
                
                // æ›´æ–°åœ°åœ–è¦–è§’ä»¥é¡¯ç¤ºæ•´æ¢è·¯ç·š
                const bounds = new google.maps.LatLngBounds();
                const path = response.routes[0].overview_path;
                path.forEach(point => bounds.extend(point));
                map.fitBounds(bounds);
                
                // æ·»åŠ èµ·é»å’Œçµ‚é»æ¨™è¨˜
                // èµ·é»å·²æœ‰ç”¨æˆ¶ä½ç½®æ¨™è¨˜
                // æ·»åŠ çµ‚é»æ¨™è¨˜
                if (marker) marker.setMap(null);
                marker = new google.maps.Marker({
                    position: new google.maps.LatLng(destination.lat, destination.lng),
                    map: map,
                    title: destinationName,
                    icon: {
                        url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                        scaledSize: new google.maps.Size(40, 40)
                    },
                    zIndex: 900
                });
            } else {
                alert('ç„¡æ³•è¦åŠƒè·¯ç·šï¼š' + status);
                
                // é‡æ–°é¡¯ç¤ºæ‰€æœ‰é¤å»³æ¨™è¨˜
                markers.forEach(marker => marker.setVisible(true));
                
                // éš±è—è¿”å›æŒ‰éˆ•
                document.getElementById('back-to-restaurants').style.display = 'none';
            }
        });
    }

    // é¡¯ç¤ºæ‰€æœ‰é¤å»³
    function showAllRestaurants() {
        if (markers.length > 0) {
            const bounds = new google.maps.LatLngBounds();
            
            markers.forEach(marker => {
                marker.setVisible(true);
                bounds.extend(marker.getPosition());
            });
            
            map.fitBounds(bounds);
        }
    }

    // æ¨¡ç³Šæœç´¢å‡½æ•¸ - åœ¨storesæ•¸çµ„ä¸­æœå°‹ç¬¦åˆæ¢ä»¶çš„é¤å»³
    function fuzzySearchRestaurants(searchText) {
        if (!stores || !stores.length) {
            return [];
        }
        
        // å°‡æœå°‹æ–‡å­—è½‰å°å¯«ä»¥é€²è¡Œä¸å€åˆ†å¤§å°å¯«çš„æ¯”å°
        const searchLower = searchText.toLowerCase();
        
        // ç¯©é¸ç¬¦åˆæ¢ä»¶çš„é¤å»³
        return stores.filter(store => {
            // æª¢æŸ¥é¤å»³åç¨±
            if (store.name && store.name.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // æª¢æŸ¥åœ°å€
            if (store.address && store.address.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // æª¢æŸ¥é¡åˆ¥
            if (store.category && store.category.toLowerCase().includes(searchLower)) {
                return true;
            }
            
            // æª¢æŸ¥æ¨™ç±¤
            if (store.tags && Array.isArray(store.tags)) {
                return store.tags.some(tag => tag.toLowerCase().includes(searchLower));
            }
            
            return false;
        });
    }

    // é¡¯ç¤ºæœå°‹çµæœå‡½æ•¸
    function displaySearchResults(results) {
        // å…ˆæ¸…é™¤åœ°åœ–ä¸Šçš„æ‰€æœ‰æ¨™è¨˜
        markers.forEach(marker => marker.setMap(null));
        markers = [];
        
        if (results.length === 0) {
            // æ²’æœ‰æœå°‹çµæœ
            alert('æ²’æœ‰æ‰¾åˆ°ç¬¦åˆæ¢ä»¶çš„é¤å»³');
            // é‡æ–°åŠ è¼‰æ‰€æœ‰é¤å»³æ¨™è¨˜
            addRestaurantMarkers();
            return;
        }
        
        // æ›´æ–°é¤å»³åˆ—è¡¨
        const restaurantsList = document.querySelector('.restaurants-list');
        restaurantsList.innerHTML = '';
        
        // å‰µå»ºé‚Šç•Œå°è±¡ï¼Œç”¨æ–¼èª¿æ•´åœ°åœ–è¦–è§’
        const bounds = new google.maps.LatLngBounds();
        
        // æ·»åŠ æœå°‹çµæœçš„æ¨™è¨˜å’Œåˆ—è¡¨é …ç›®
        results.forEach((store, index) => {
            // å‰µå»ºæ¨™è¨˜ä½ç½®
           const storeLocation = { 
    lat: parseFloat(store.latitude),
    lng: parseFloat(store.longitude)
};

            
            // å°‡ä½ç½®æ·»åŠ åˆ°åœ°åœ–é‚Šç•Œä¸­
            bounds.extend(new google.maps.LatLng(storeLocation.lat, storeLocation.lng));
            
            // å‰µå»ºæ¨™è¨˜
            const marker = new google.maps.Marker({
                position: storeLocation,
                map: map,
                title: store.name,
                animation: google.maps.Animation.DROP,
                icon: {
                    url: 'https://maps.google.com/mapfiles/ms/icons/orange-dot.png',
                    scaledSize: new google.maps.Size(36, 36)
                },
                label: {
                    text: store.name,
                    color: '#000',
                    fontSize: '12px',
                    fontWeight: 'bold'
                },
                storeId: store.id || index
            });
            
            markers.push(marker);
            
            // é»æ“Šæ¨™è¨˜æ™‚é¡¯ç¤ºä¿¡æ¯
            marker.addListener('click', function() {
                selectRestaurant = {
                    name: store.name,
                    address: store.address,
                    phoneNumber: store.phone,
                    rating: store.rating || 4.5,
                    location: storeLocation,
                    id: store.id,
                    category: store.category || 'é¤é£²',
                    tags: store.tags || ['æ„›å¿ƒåˆä½œåº—']
                };
                
                // ä¿¡æ¯çª—å£å…§å®¹
                const infoContent = `
                    <div class="info-window">
                        <h3>${store.name}</h3>
                        <div><strong>åœ°å€ï¼š</strong>${store.address}</div>
                        <div><strong>é›»è©±ï¼š</strong>${store.phone}</div>
                        <div><strong>è©•åˆ†ï¼š</strong>${store.rating || 4.5} / 5</div>
                        <div><strong>æ„›å¿ƒä»£ç”¨é¤åˆä½œé¤å»³</strong></div>
                        <div class="mt-2 text-center">
                            <button class="btn btn-sm btn-primary mt-2" onclick="showRouteInMap({lat: ${storeLocation.lat}, lng: ${storeLocation.lng}}, '${store.name}')">
                                <i class="fas fa-route mr-1"></i>é¡¯ç¤ºè·¯ç·š
                            </button>
                        </div>
                    </div>
                `;
                
                infowindow.setContent(infoContent);
                infowindow.open(map, marker);
                
                // æ›´æ–°å´æ¬„ä¿¡æ¯
                updateRestaurantInfo(selectRestaurant);
            });
            
            // æ·»åŠ åˆ—è¡¨é …ç›®
            const restaurantItem = document.createElement('a');
            restaurantItem.href = '#';
            restaurantItem.className = 'list-group-item list-group-item-action restaurant-item';
            restaurantItem.setAttribute('data-id', store.id);
            
            // è¨ˆç®—æ¨™ç±¤
            const tags = store.tags || ['æ„›å¿ƒåˆä½œåº—'];
            const tagHtml = tags.map(tag => `<small class="badge badge-info ml-1">${tag}</small>`).join('');
            
            restaurantItem.innerHTML = `
                <div class="d-flex w-100 justify-content-between">
                    <h6 class="mb-1">${store.name}</h6>
                    <small>${store.distance || 'é™„è¿‘'}</small>
                </div>
                <div class="restaurant-category mb-1">
                    <small class="text-muted">${store.category || 'é¤é£²'}</small>
                    ${tagHtml}
                </div>
                <small class="d-block">
                    <div class="stars-outer d-inline-block" style="font-size: 0.8rem;">
                        <div class="stars-inner" style="width: ${((store.rating || 4.5) / 5) * 100}%"></div>
                    </div>
                    <span class="rating-value ml-1">${store.rating || 4.5}</span>
                </small>
            `;
            
            // æ·»åŠ é»æ“Šäº‹ä»¶ç›£è½å™¨
            restaurantItem.addEventListener('click', function(e) {
                e.preventDefault();
                
                // åœ¨åœ°åœ–ä¸Šæ‰¾åˆ°ç›¸æ‡‰çš„æ¨™è¨˜
                const marker = markers.find(m => m.storeId == store.id);
                if (marker) {
                    // è§¸ç™¼æ¨™è¨˜çš„é»æ“Šäº‹ä»¶
                    google.maps.event.trigger(marker, 'click');
                    
                    // ç§»å‹•åˆ°æ¨™è¨˜ä½ç½®ä¸¦èª¿æ•´ç¸®æ”¾
                    map.setCenter(marker.getPosition());
                    map.setZoom(16);
                } else {
                    // æˆ–è€…ç›´æ¥é¡¯ç¤ºé¤å»³ä¿¡æ¯
                    showRestaurantModal(store);
                }
            });
            
            restaurantsList.appendChild(restaurantItem);
        });
        
        // èª¿æ•´åœ°åœ–è¦–è§’ä»¥é¡¯ç¤ºæ‰€æœ‰çµæœ
        if (markers.length > 0) {
            map.fitBounds(bounds);
            
            // å¦‚æœåªæœ‰ä¸€å€‹çµæœï¼Œé©ç•¶ç¸®æ”¾
            if (markers.length === 1) {
                google.maps.event.addListenerOnce(map, 'bounds_changed', function() {
                    map.setZoom(16);
                });
            }
        }
    }
    </script>

	<!-- Contact Javascript File -->
	<script src="mail/jqBootstrapValidation.min.js"></script>
	<script src="mail/contact.js"></script>

	<!-- Template Javascript -->
	<script src="js/main.js"></script>
</body>
</html>

<!-- Google Maps API -->
<script async
	src="https://maps.googleapis.com/maps/api/js?key=AIzaSyCwk4bH6RdOWmqwmrpdYu7-NKZin0St0vQ&libraries=places&callback=initMap&region=TW&language=zh-TW">
    </script>

<!-- åˆå§‹åŒ–åŠŸèƒ½ -->
<script>
//ç•¶é é¢å®Œå…¨è¼‰å…¥å¾ŒåŸ·è¡Œ
$(document).ready(function() {
    // ä¿®æ”¹æœå°‹æŒ‰éˆ•é»æ“Šäº‹ä»¶ - çµåˆ Google Places API å’Œè³‡æ–™åº«æœå°‹
    $('.input-group-append .btn').click(function() {
        const searchText = $('#search-input').val().trim();
        if (!searchText) return;
        
        // é¦–å…ˆåœ¨æœ¬åœ°è³‡æ–™åº«ä¸­æœå°‹
        const localResults = fuzzySearchRestaurants(searchText);
        
        if (localResults.length > 0) {
            // å¦‚æœåœ¨æœ¬åœ°è³‡æ–™åº«ä¸­æ‰¾åˆ°çµæœï¼Œé¡¯ç¤ºé€™äº›çµæœ
            displaySearchResults(localResults);
            
            const storeLocation = { 
            	    lat: parseFloat(store.latitude),
            	    lng: parseFloat(store.longitude)
            	};
            
        } else {
            // å¦‚æœæœ¬åœ°æ²’æœ‰æ‰¾åˆ°çµæœï¼Œä½¿ç”¨ Google Places API æœå°‹
            if (typeof google !== 'undefined' && google.maps && google.maps.places) {
                const service = new google.maps.places.PlacesService(map);
                service.textSearch({
                    query: searchText,
                    location: currentPosition,
                    radius: 5000
                }, handlePlacesResult);
            }
        }
    });
    
    // ç›£è½æœå°‹è¼¸å…¥æ¡†çš„ Enter éµ
    $('#search-input').keypress(function(e) {
        if (e.which === 13) { // Enter éµçš„ keyCode
            $('.input-group-append .btn').click();
            e.preventDefault();
        }
    });
    
    // æ·»åŠ å´é‚Šæ¬„å°èˆªæŒ‰éˆ•é»æ“Šäº‹ä»¶ - æ”¹ç‚ºåœ¨åœ°åœ–ä¸Šé¡¯ç¤ºè·¯ç·š
    $(document).on('click', '#restaurant-info .btn-primary', function() {
        if (selectRestaurant && selectRestaurant.location) {
            showRouteInMap(selectRestaurant.location, selectRestaurant.name);
        }
    });
    
    // æ·»åŠ é¤å»³é …ç›®é»æ“Šäº‹ä»¶è™•ç†
    $(document).on('click', '.restaurant-item', function(e) {
        e.preventDefault();
        
        // ç¢ºä¿åœ°åœ–å·²åˆå§‹åŒ–
        if (!map) {
            console.error('åœ°åœ–å°šæœªåˆå§‹åŒ–');
            return;
        }
        
        // ç²å–é¤å»³ ID
        const restaurantId = $(this).data('id');
        
        // é¡¯ç¤ºåœ°åœ–è¼‰å…¥ä¸­ç‹€æ…‹
        console.log('æ­£åœ¨åŠ è¼‰é¤å»³ä½ç½®...');
        
        // æ‰¾åˆ°å°æ‡‰çš„æ¨™è¨˜ä¸¦è§¸ç™¼é»æ“Š
        const marker = markers.find(m => m.storeId == restaurantId);
        if (marker) {
            // ç¢ºä¿æ¨™è¨˜å¯è¦‹
            marker.setVisible(true);
            
            // ç§»å‹•åœ°åœ–è¦–è§’åˆ°æ¨™è¨˜ä½ç½®
            map.setCenter(marker.getPosition());
            map.setZoom(16);
            
            // è§¸ç™¼æ¨™è¨˜çš„é»æ“Šäº‹ä»¶
            google.maps.event.trigger(marker, 'click');
        } else {
            // å¦‚æœæ‰¾ä¸åˆ°æ¨™è¨˜ï¼Œç›´æ¥å¾storesæ•¸æ“šä¸­ç²å–é¤å»³ä¿¡æ¯
            const store = stores.find(s => s.id == restaurantId);
            if (store && store.latitude && store.longitude) {
                const storeLocation = { 
                    lat: parseFloat(store.latitude), 
                    lng: parseFloat(store.longitude) 
                };
                
                // ç§»å‹•åœ°åœ–åˆ°é¤å»³ä½ç½®
                map.setCenter(storeLocation);
                map.setZoom(16);
                
                // é¡¯ç¤ºé¤å»³ä¿¡æ¯
                showRestaurantModal(store);
            } else {
                console.error('æ‰¾ä¸åˆ°é¤å»³è³‡æ–™æˆ–ä½ç½®è³‡è¨Š');
            }
        }
    });
    
    // ğŸ” è‡ªå‹•å®Œæˆå»ºè­° + é«˜äº®é—œéµå­—
    $('#search-input').on('input', function () {
        const keyword = $(this).val().trim().toLowerCase();
        const suggestionBox = $('#autocomplete-suggestions');
        suggestionBox.empty();
        if (keyword.length === 0) {
            suggestionBox.hide();
            return;
        }
        const matched = stores.filter(store =>
            store.name.toLowerCase().includes(keyword) ||
            store.address.toLowerCase().includes(keyword)
        );
        if (matched.length === 0) {
            suggestionBox.hide();
            return;
        }
        matched.slice(0, 8).forEach(store => {
            // ğŸ‘‰ é«˜äº®åº—åå’Œåœ°å€ä¸­çš„é—œéµå­—
            const highlight = (text) => {
                const regex = new RegExp(`(${keyword})`, 'gi');
                return text.replace(regex, '<b>$1</b>');
            };
            const suggestionItem = $(`
                <li class="list-group-item list-group-item-action">
                    ${highlight(store.name)} - ${highlight(store.address)}
                </li>
            `);
            suggestionItem.on('click', function () {
                $('#search-input').val(store.name);
                suggestionBox.hide();
                displaySearchResults([store]);
            });
            suggestionBox.append(suggestionItem);
        });
        suggestionBox.show();
    });
    
    // ğŸ” é»æ“Šå…¶ä»–åœ°æ–¹æ™‚éš±è—å»ºè­°æ¸…å–®
    $(document).on('click', function (e) {
        if (!$(e.target).closest('#search-input').length &&
            !$(e.target).closest('#autocomplete-suggestions').length) {
            $('#autocomplete-suggestions').hide();
        }
    });
});
</script>

<!-- Contact Javascript File -->
<script src="mail/jqBootstrapValidation.min.js"></script>
<script src="mail/contact.js"></script>

<!-- Template Javascript -->
<script src="js/main.js"></script>
</body>
</html>